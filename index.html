<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamNet - Universal Player</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           ESTILOS GENERALES (TUS ESTILOS ORIGINALES)
           ========================================= */
        :root { --primary: #E50914; --bg: #000000; --key-bg: #222; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        .focusable:focus {
            outline: none; border: 3px solid white !important; transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0,0,0,0.9); z-index: 9999;
            background-color: rgba(255,255,255,0.2); color: white;
        }

        header { position: fixed; top: 0; width: 100%; height: 60px; z-index: 100; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent); display: flex; align-items: center; justify-content: space-between; padding: 0 4%; box-sizing: border-box; }
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .logo { color: var(--primary); font-size: 24px; font-weight: 900; text-decoration: none; margin-right: 10px; text-shadow: 2px 2px 4px black; }
        .nav-btn { background: transparent; border: 2px solid transparent; color: #ccc; font-size: 14px; cursor: pointer; font-weight: bold; padding: 5px 15px; border-radius: 4px; transition: 0.2s; display: flex; align-items: center; justify-content: center;}
        .nav-btn.active { color: white; background: rgba(255,255,255,0.1); border-bottom: 2px solid var(--primary); }
        
        .search-btn-header { background: rgba(255,255,255,0.1); border: 2px solid transparent; color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        .search-btn-header .material-icons-round { font-size: 20px; }

        #app { padding-top: 80px; height: 100vh; overflow-y: auto; padding-bottom: 50px; box-sizing: border-box; }
        .section-title { margin-left: 4%; font-size: 1.4rem; color: #e5e5e5; margin-bottom: 10px; margin-top: 20px; text-shadow: 1px 1px 2px black; font-weight: bold;}
        
        .horizontal-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 15px 4%; scroll-behavior: smooth; }
        .horizontal-scroll::-webkit-scrollbar { height: 0px; }
        
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 20px 4%; }
        
        .card { min-width: 140px; height: 210px; background: #222; border-radius: 6px; cursor: pointer; position: relative; overflow: hidden; transition: transform 0.2s; border: 3px solid transparent; display: flex; align-items: center; justify-content: center; }
        .card-fallback-title { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; text-align: center; padding: 10px; font-size: 0.9rem; font-weight: bold; color: #aaa; z-index: 0; word-wrap: break-word; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: relative; z-index: 10; background: #222; }
        
        .progress-track { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background: rgba(255,255,255,0.3); z-index: 20; display: none; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; }

        #search-results-grid .card { min-width: auto; height: 100%; width: 100%; }

        /* SEARCH */
        #search-interface { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #000; z-index: 2000; display: none; padding: 80px 4% 20px 4%; box-sizing: border-box; }
        .search-container { display: flex; height: 100%; gap: 30px; }
        .keyboard-panel { flex: 0 0 320px; display: flex; flex-direction: column; }
        .search-display-area { margin-bottom: 20px; }
        .search-instruction { color: #888; font-size: 0.9rem; margin-bottom: 5px; }
        .search-input-display { font-size: 2rem; color: white; border-bottom: 2px solid var(--primary); padding-bottom: 10px; min-height: 40px; font-weight: bold; }
        .keyboard-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; justify-items: center; }
        .key-btn { width: 45px; height: 45px; background: var(--key-bg); color: #ddd; border: 2px solid transparent; border-radius: 50%; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .key-btn.wide { grid-column: span 2; width: auto; padding: 0 20px; border-radius: 30px; }
        .key-btn.action { background: #333; }
        .results-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .results-header { color: #888; margin-bottom: 15px; font-size: 1.1rem; }
        #search-results-grid { padding: 10px; overflow-y: auto; height: 100%; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); grid-auto-rows: 150px; gap: 10px; align-content: start; }

        /* DETAILS */
        #details-view { position: fixed; inset: 0; background: var(--bg); z-index: 200; display: none; overflow-x: hidden; overflow-y: auto; }
        .details-hero { position: absolute; inset: 0; width: 100%; height: 100%; background-size: cover; background-position: center top; mask-image: linear-gradient(to bottom, black 50%, transparent 100%); }
        .hero-gradient { position: absolute; inset: 0; }
        .details-content { position: absolute; top: 1%; left: 5%; width: 90%; z-index: 10; display: flex; flex-direction: column; bottom: 240px; justify-content: flex-start; }
        .details-title { font-size: 3rem; font-weight: 900; margin-bottom: 5px; text-shadow: 2px 2px 10px black; line-height: 1; }
        .details-meta { font-size: 1.1rem; color: #ccc; margin-bottom: 10px; font-weight: bold; display: flex; gap: 15px; align-items: center;}
        .tag { background: rgba(255,255,255,0.2); padding: 2px 8px; border-radius: 4px; font-size: 0.9rem; }
        .details-desc { font-size: 1rem; line-height: 1.4; color: #ddd; margin-bottom: 20px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; text-shadow: 1px 1px 2px black; }
        .action-row { display: flex; gap: 15px; margin-bottom: 5px; flex-wrap: wrap; }
        .btn-large { padding: 10px 25px; font-size: 1rem; font-weight: bold; border-radius: 4px; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s;}
        .btn-primary { background: white; color: black; border: 3px solid transparent; }
        .btn-secondary { background: rgba(100, 100, 100, 0.6); color: white; border: 3px solid transparent; }
        
        #series-container { position: absolute; bottom: 20px; left: 5%; right: 5%; z-index: 20; background: transparent; }
        .season-header { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .season-selector { background: #333; color: white; border: 2px solid #555; padding: 12px 30px; border-radius: 4px; font-size: 1.1rem; font-weight: bold; cursor: pointer; min-width: 220px; }
        .episode-scroller { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; scroll-behavior: smooth; }
        .episode-scroller::-webkit-scrollbar { height: 0; }
        .episode-card { min-width: 220px; max-width: 220px; background: rgba(30,30,30,0.8); border-radius: 6px; overflow: hidden; cursor: pointer; border: 3px solid transparent; transition: transform 0.2s; display: flex; flex-direction: column; position: relative; }
        .episode-card:hover, .episode-card:focus { transform: scale(1.05); border-color: white; background: #333; z-index: 50; }
        .ep-thumb { width: 100%; height: 125px; object-fit: cover; }
        .ep-info { padding: 10px; }
        .ep-title { font-size: 0.9rem; font-weight: bold; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* PLAYER */
        #player-container { position: fixed; inset: 0; background: black; z-index: 5000; display: none; }
        #video { width: 100%; height: 100%; }
        .player-ui { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: space-between; background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 25%, transparent 75%, rgba(0,0,0,0.9) 100%); transition: opacity 0.3s ease; z-index: 99999 !important; pointer-events: none; }
        .ui-fade-out { opacity: 0 !important; pointer-events: none; }
        .p-header { display: flex; justify-content: space-between; align-items: flex-start; padding: 30px; position: relative; }
        .btn-back-p { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.15); color: white; border: 2px solid transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100000; pointer-events: auto !important; }
        .p-clock { font-size: 1.5rem; font-weight: bold; color: #ccc; text-shadow: 2px 2px 4px black; position: absolute; left: 50%; top: 40px; transform: translateX(-50%); z-index: 1; pointer-events: none; }
        .p-meta { text-align: right; text-shadow: 1px 1px 3px black; max-width: 40%; z-index: 2; pointer-events: none; }
        .p-controls-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 40px; align-items: center; pointer-events: none; }
        .ctrl-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(0,0,0,0.6); color: white; border: 3px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; pointer-events: auto !important; }
        .ctrl-btn:focus, .ctrl-btn:hover { background: var(--primary); border-color: white; transform: scale(1.15); }
        
        .error-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; padding: 30px; border: 1px solid #555; z-index: 999999; display: none; text-align: center; border-radius: 8px; box-shadow: 0 0 50px black; }
        .shaka-controls-container .focusable:focus { outline: none !important; border: 2px solid var(--primary) !important; background-color: rgba(255, 255, 255, 0.2); transform: scale(1.1); }
        @media (orientation: portrait) {
            .details-hero { height: 50vh; width: 100%; top: 0; mask-image: linear-gradient(to bottom, black 50%, transparent 100%); }
            .hero-gradient { height: 50vh; background: linear-gradient(to top, black 10%, transparent); }
            .details-content { position: relative; top: auto; margin-top: 35vh; width: 90%; left: 5%; margin-bottom: 20px; justify-content: flex-start; }
            .details-title { font-size: 2.5rem; }
            .details-desc { -webkit-line-clamp: 6; }
            #series-container { position: relative; bottom: auto; margin-top: 0; padding-bottom: 50px; }
            .search-container { flex-direction: column; }
            .keyboard-panel { flex: none; width: 100%; margin-bottom: 20px;}
        }
    </style>
</head>
<body>

    <header id="main-header">
        <div class="nav-left">
            <a href="#" class="logo">STREAMNET</a>
            <button class="nav-btn focusable active" onclick="renderView('home')">Inicio</button>
            <button class="nav-btn focusable" onclick="renderView('series')">Series</button>
            <button class="nav-btn focusable" onclick="renderView('movies')">Películas</button>
        </div>
        <button class="search-btn-header focusable" onclick="openSearchInterface()">
            <span class="material-icons-round">search</span>
        </button>
    </header>

    <div id="app">
        <h2 style="text-align:center; margin-top:100px; color:#777;" id="loading-msg">Cargando contenido...</h2>
    </div>

    <div id="search-interface">
        <div class="search-container">
            <div class="keyboard-panel">
                <div class="search-display-area">
                    <div class="search-instruction">Escribe para buscar...</div>
                    <div id="virtual-input-display" class="search-input-display"></div>
                </div>
                <div id="keyboard-grid" class="keyboard-grid"></div>
            </div>
            <div class="results-panel">
                <div class="results-header" id="results-count-text">Resultados</div>
                <div id="search-results-grid"></div>
            </div>
        </div>
    </div>

    <div id="details-view">
        <div class="details-hero" id="det-hero"></div>
        <div class="hero-gradient"></div>
        <div class="details-content">
            <h1 class="details-title" id="det-title">TITULO</h1>
            <div class="details-meta" id="det-meta">
                <span class="tag" id="det-year"></span>
                <span class="tag" id="det-type"></span>
            </div>
            <p class="details-desc" id="det-desc">Descripción...</p>
            <div class="action-row">
                <button id="btn-play-hero" class="btn-large btn-primary focusable">
                    <span class="material-icons-round">play_arrow</span> <span id="play-text">Reproducir</span>
                </button>
                <button id="btn-back-details" class="btn-large btn-secondary focusable" onclick="closeDetails()">
                    <span class="material-icons-round">arrow_back</span> Volver
                </button>
            </div>
        </div>
        <div id="series-container" style="display:none;">
            <div class="season-header">
                <select id="season-select" class="season-selector focusable"></select>
                <h3 style="margin:0;">Episodios</h3>
            </div>
            <div id="episodes-list" class="episode-scroller"></div>
        </div>
    </div>

    <div id="player-container">
        <video id="video" autoplay></video>
        <div id="player-ui" class="player-ui">
            <div class="p-header">
                <button id="btn-back-player" class="btn-back-p focusable"><span class="material-icons-round">arrow_back</span></button>
                <div class="p-clock" id="p-clock">00:00</div>
                <div class="p-meta"><h2 id="p-title">Título</h2><span id="p-sub">Subtítulo</span></div>
            </div>
            <div class="p-controls-center">
                <button id="btn-prev" class="ctrl-btn mini focusable" onclick="changeEpisode(-1)"><span class="material-icons-round">skip_previous</span></button>
                <button id="btn-play-center" class="ctrl-btn focusable" onclick="togglePlay()"><span class="material-icons-round" id="icon-play">pause</span></button>
                <button id="btn-next" class="ctrl-btn mini focusable" onclick="changeEpisode(1)"><span class="material-icons-round">skip_next</span></button>
            </div>
            <div style="height: 50px;"></div>
        </div>
    </div>

    <div id="error-modal" class="error-modal">
        <h3 style="color:#ff5555; margin-top:0">Error de Reproducción</h3>
        <p id="error-msg">...</p>
        <button class="btn-primary focusable" onclick="document.getElementById('error-modal').style.display='none'; exitPlayer()">Cerrar</button>
    </div>

<script>
    // --- VARIABLES GLOBALES ---
    const SOURCES = [
        { url: 'https://gist.githubusercontent.com/TIGRE9725/f7c1267ddd3460062c44d6c93e932c95/raw/izzigo.json', type: 'json' },
        { url: 'https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1', type: 'json' },
        { url: 'https://gist.githubusercontent.com/TIGRE9725/9d495adb5d3737cd9e0ece692aaf1917/raw/netvideo.pelis.m3u', type: 'm3u' },
        { url: 'https://raw.githubusercontent.com/TIGRE9725/PELIS/main/netvideo.series.m3u', type: 'm3u' },
        { url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/playlist_peliculas.m3u', type: 'm3u' },
        { url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/playlist_series.m3u', type: 'm3u' }
    ];

    let catalog = [], currentView = 'home', activeSection = 'home', currentItem = null, player = null, uiTimer = null, clockInterval = null;
    let currentSeasonIdx = 0, currentEpIdx = 0, searchString = "";
    const DEFAULT_IMG = "https://via.placeholder.com/300x450/333333/FFFFFF?text=Sin+Imagen";

    const KEYMAP = { LEFT:[37], UP:[38], RIGHT:[39], DOWN:[40], ENTER:[13,23,66], BACK:[8,461,10009,27,4], PLAY:[415,19,85,179,126], PAUSE:[19,85,179,127], STOP:[413,86], REWIND:[412,89], FAST_FWD:[417,90], NEXT_TRACK:[176,87], PREV_TRACK:[177,88] };
    const KEYBOARD_LAYOUT = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","1","2","3","4","5","6","7","8","9","0","SPACE","DEL","VOLVER"];

    window.addEventListener('keydown', handleRemote, true);
    window.onload = async () => {
        initShaka();
        generateKeyboard();
        document.getElementById('btn-back-player').onclick = exitPlayer;
        await loadAllData();
        const pCont = document.getElementById('player-container');
        pCont.addEventListener('mousemove', resetUiTimer); pCont.addEventListener('touchstart', resetUiTimer);
    };

    // --- CARGA DE DATOS UNIFICADA ---
    async function loadAllData() {
        try {
            const promises = SOURCES.map(src => fetch(src.url).then(r => r.text()).then(txt => ({ type: src.type, text: txt })));
            const results = await Promise.all(promises);
            
            results.forEach(res => {
                let items = [];
                if (res.type === 'm3u' || res.text.trim().startsWith('#')) items = parseM3U(res.text);
                else items = JSON.parse(res.text);
                
                items.forEach(i => {
                    const normalized = normalizeItem(i);
                    // Solo agregar si tiene URL válida
                    if (normalized.url || (normalized.seasons && normalized.seasons.length > 0)) {
                        catalog.push(normalized);
                    }
                });
            });
            
            document.getElementById('loading-msg').style.display = 'none';
            renderView('home');
        } catch (e) { document.getElementById('loading-msg').innerText = "Error cargando contenido: " + e.message; }
    }

    // --- PARSERS Y NORMALIZADORES ---
    function normalizeItem(i) {
        let type = 'movie';
        // Detección automática de series
        if (i.estaciones || i.seasons || i.seriesName || (i.tipo && i.tipo.includes('serie'))) type = 'series';
        
        let seasons = [];
        if (type === 'series') {
            if (i.estaciones || i.seasons) {
                // Formato JSON
                const raw = i.estaciones || i.seasons;
                seasons = raw.map((s, idx) => ({
                    num: s.numero || s.season_number || idx + 1,
                    episodes: (s.episodios || s.episodes || []).map(e => ({
                        title: e.title || e.titulo,
                        img: e.img || e.image || i.poster,
                        url: e.url || e.mpd || e.source?.url,
                        drm: e.drm || e.source?.drm
                    }))
                }));
            } else if (i.episodes) {
                // Formato M3U Agrupado (ver parser abajo)
                seasons = [{ num: 1, episodes: i.episodes }];
            }
        }

        return {
            id: i.id || Math.random().toString(36),
            title: i.title || i.titulo || i.seriesName,
            desc: i.description || i.sinopsis || i.desc || "Sin descripción.",
            // Búsqueda exhaustiva de imágenes
            poster: i.poster || i.img || i.image || i.images?.poster || DEFAULT_IMG,
            hero: i.backdrop || i.poster || i.img || DEFAULT_IMG,
            type: type,
            year: i.year || '',
            url: i.url || i.mpd || i.source?.url,
            drm: i.drm || i.source?.drm, // Objeto DRM original { clearKeys: ... }
            seasons: seasons
        };
    }

    function parseM3U(text) {
        const lines = text.split('\n');
        const items = [];
        const seriesGroups = {}; // Agrupar series por group-title
        let curr = null;

        for (let l of lines) {
            l = l.trim();
            if (l.startsWith('#EXTINF')) {
                curr = { drm: {} };
                // Extraer Imagen (tvg-logo)
                const logo = l.match(/tvg-logo="([^"]+)"/);
                curr.poster = logo ? logo[1] : null;
                // Extraer Grupo (Series)
                const grp = l.match(/group-title="([^"]+)"/);
                curr.group = grp ? grp[1] : null;
                // Título (después de la última coma)
                curr.title = l.substring(l.lastIndexOf(',') + 1).trim();
            } else if (l.startsWith('#KODIPROP')) {
                if (curr) {
                    const keys = l.split('=')[1].split(',');
                    const ck = {};
                    keys.forEach(pair => { const s = pair.split(':'); if (s[0] && s[1]) ck[s[0]] = s[1]; });
                    curr.drm.clearKeys = ck;
                }
            } else if (l.startsWith('http')) {
                if (curr) {
                    curr.url = l;
                    
                    if (curr.group) {
                        // Es serie (agrupada)
                        if (!seriesGroups[curr.group]) {
                            seriesGroups[curr.group] = { seriesName: curr.group, poster: curr.poster, episodes: [] };
                        }
                        // Si el episodio tiene poster y la serie no, úsalo
                        if (!seriesGroups[curr.group].poster && curr.poster) seriesGroups[curr.group].poster = curr.poster;
                        seriesGroups[curr.group].episodes.push(curr);
                    } else {
                        // Es película suelta
                        items.push(curr); 
                    }
                    curr = null;
                }
            }
        }
        // Combinar pelis sueltas + series agrupadas
        return [...items, ...Object.values(seriesGroups)];
    }

    // ================= INTERFAZ =================
    function renderView(view) {
        if (['home', 'series', 'movies'].includes(view)) activeSection = view;
        currentView = activeSection;
        
        // UI Reset
        document.getElementById('main-header').style.display = 'flex';
        document.getElementById('search-interface').style.display = 'none';
        document.getElementById('details-view').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        const app = document.getElementById('app'); app.innerHTML = '';
        
        // Header Tabs
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if (activeSection === 'home') document.querySelectorAll('.nav-btn')[0].classList.add('active');
        if (activeSection === 'series') document.querySelectorAll('.nav-btn')[1].classList.add('active');
        if (activeSection === 'movies') document.querySelectorAll('.nav-btn')[2].classList.add('active');

        if (activeSection === 'home') {
            const watching = catalog.filter(x => { const p = getProgress(x.id); return p.pct > 1 && p.pct < 95; });
            if (watching.length > 0) createRow("Continuar Viendo", watching);
            createRow("Series Recientes", catalog.filter(x => x.type === 'series').slice(0, 15));
            createRow("Películas Recientes", catalog.filter(x => x.type === 'movie').slice(0, 15));
        } else if (activeSection === 'series') {
            createGrid(catalog.filter(x => x.type === 'series'));
        } else {
            createGrid(catalog.filter(x => x.type === 'movie'));
        }
        setTimeout(() => { const el = document.querySelector('.card'); if (el) el.focus(); }, 200);
    }

    function createRow(title, list) {
        if (!list.length) return;
        document.getElementById('app').insertAdjacentHTML('beforeend', `<div><h3 class="section-title">${title}</h3><div class="horizontal-scroll">${list.map(i => cardHtml(i)).join('')}</div></div>`);
    }
    function createGrid(list) { document.getElementById('app').innerHTML = `<div class="grid-view">${list.map(i => cardHtml(i)).join('')}</div>`; }
    
    function cardHtml(item) {
        const p = getProgress(item.id);
        const bar = p.pct > 0 ? `<div class="progress-track" style="display:block"><div class="progress-fill" style="width:${p.pct}%"></div></div>` : '';
        // Manejo de error de imagen: si falla, se oculta y se ve el fallback-title
        return `
            <div class="card focusable" tabindex="0" onclick="openDetails('${item.id}')" data-id="${item.id}">
                <div class="card-fallback-title">${item.title}</div>
                <img src="${item.poster}" loading="lazy" onerror="this.style.display='none'">
                ${bar}
            </div>`;
    }

    function openDetails(id) {
        const item = catalog.find(x => x.id === id); if(!item) return;
        currentItem = item; currentView = 'details';
        document.getElementById('app').style.display = 'none'; document.getElementById('main-header').style.display = 'none';
        const view = document.getElementById('details-view'); view.style.display = 'block'; view.scrollTop = 0;
        
        document.getElementById('det-hero').style.backgroundImage = `url('${item.hero}')`;
        document.getElementById('det-title').innerText = item.title;
        document.getElementById('det-desc').innerText = item.desc;
        document.getElementById('det-year').innerText = item.year;
        document.getElementById('det-type').innerText = item.type === 'series' ? 'Serie' : 'Película';
        
        const btnPlay = document.getElementById('btn-play-hero');
        const txtPlay = document.getElementById('play-text');
        const sCont = document.getElementById('series-container');

        if (item.type === 'series') {
            sCont.style.display = 'block';
            renderSeasons(item);
            // Lógica Reanudar Serie
            let nextS = 0, nextE = 0;
            const lastSeen = JSON.parse(localStorage.getItem('last_seen_' + item.id) || '{}');
            if (lastSeen.s !== undefined) { nextS = lastSeen.s; nextE = lastSeen.e; }
            
            const ep = item.seasons[nextS]?.episodes[nextE];
            txtPlay.innerText = ep ? `Reanudar: ${ep.title}` : "Reproducir";
            btnPlay.onclick = () => playEpisode(nextS, nextE);
        } else {
            sCont.style.display = 'none';
            const p = getProgress(item.id);
            txtPlay.innerText = (p.pct > 1 && p.pct < 98) ? "Reanudar" : "Reproducir";
            btnPlay.onclick = () => startPlayer(item.url, item.drm, item.title, false);
        }
        setTimeout(() => btnPlay.focus(), 100);
    }

    function renderSeasons(item) {
        const sel = document.getElementById('season-select'); sel.innerHTML = '';
        item.seasons.forEach((s, idx) => { sel.innerHTML += `<option value="${idx}">Temporada ${s.num}</option>`; });
        
        sel.onchange = () => renderEpisodes(item, sel.value);
        
        // Seleccionar ultima temporada vista
        let defIdx = 0;
        const last = JSON.parse(localStorage.getItem('last_seen_' + item.id) || '{}');
        if (last.s !== undefined) defIdx = last.s;
        
        sel.value = defIdx;
        renderEpisodes(item, defIdx); // Renderizar inmediatamente
    }

    function renderEpisodes(item, sIdx) {
        const list = document.getElementById('episodes-list'); list.innerHTML = '';
        const season = item.seasons[sIdx];
        if (!season) return;

        season.episodes.forEach((ep, idx) => {
            const p = getProgress(getEpId(item.id, sIdx, idx));
            const bar = p.pct > 0 ? `<div class="progress-track" style="display:block"><div class="progress-fill" style="width:${p.pct}%"></div></div>` : '';
            const div = document.createElement('div'); div.className = 'episode-card focusable'; div.tabIndex = 0;
            div.onclick = () => playEpisode(sIdx, idx);
            // Imagen del episodio o de la serie
            const thumb = ep.img || item.poster; 
            div.innerHTML = `<img src="${thumb}" class="ep-thumb" onerror="this.src='${DEFAULT_IMG}'">${bar}<div class="ep-info"><div class="ep-title">${idx+1}. ${ep.title||'Episodio'}</div></div>`;
            list.appendChild(div);
        });
    }

    // ================= REPRODUCTOR Y DRM =================
    async function startPlayer(mpd, drm, title, isSeries) {
        if (!mpd) return showError("Sin URL de video.");
        document.getElementById('player-container').style.display = 'block';
        currentView = 'player';
        
        // UI Player
        const disp = isSeries ? 'flex' : 'none';
        document.getElementById('btn-prev').style.display = disp; document.getElementById('btn-next').style.display = disp;
        document.getElementById('p-title').innerText = currentItem.title; 
        document.getElementById('p-sub').innerText = isSeries ? title : "Película";
        updateClock(); clockInterval = setInterval(updateClock, 60000);

        try {
            await player.unload(); // Limpiar previo
            
            // CONFIGURACIÓN DRM CRÍTICA
            const config = { streaming: { bufferingGoal: 60 } };
            // IMPORTANTE: Si hay llaves, configurar. Si no, dejar vacío para que no busque licencias.
            if (drm && drm.clearKeys) {
                config.drm = { clearKeys: drm.clearKeys };
            } else {
                config.drm = {}; // Limpiar config DRM anterior
            }
            player.configure(config);

            await player.load(mpd);
            const vid = document.getElementById('video');
            
            // Recuperar progreso
            let loadId = currentItem.id;
            if (isSeries) loadId = getEpId(currentItem.id, currentSeasonIdx, currentEpIdx);
            const saved = getProgress(loadId);
            if (saved.pct > 1 && saved.pct < 98) vid.currentTime = saved.time;
            
            vid.play().catch(e => console.log("Autoplay blocked"));
            setTimeout(() => { document.getElementById('btn-play-center').focus(); resetUiTimer(); }, 500);
            
        } catch (e) { onError(e); }
    }

    async function playEpisode(sIdx, eIdx) {
        currentSeasonIdx = parseInt(sIdx); currentEpIdx = parseInt(eIdx);
        const ep = currentItem.seasons[sIdx].episodes[eIdx];
        if (ep) startPlayer(ep.url, ep.drm, `T${currentItem.seasons[sIdx].num} E${eIdx+1}: ${ep.title}`, true);
    }

    function togglePlay() { const v = document.getElementById('video'); v.paused ? v.play() : v.pause(); }
    function exitPlayer() {
        const v = document.getElementById('video'); v.pause(); v.src = ""; player.unload(); clearInterval(clockInterval);
        document.getElementById('player-container').style.display = 'none';
        if (currentItem) {
            currentView = 'details'; 
            document.getElementById('details-view').style.display = 'block';
            document.getElementById('main-header').style.display = 'none'; // Header off en detalles
            setTimeout(() => document.getElementById('btn-play-hero').focus(), 100);
        } else renderView('home');
    }

    function changeEpisode(dir) {
        let newEp = currentEpIdx + dir, newSe = currentSeasonIdx;
        if (dir === 1 && newEp >= currentItem.seasons[newSe].episodes.length) { newSe++; newEp = 0; }
        else if (dir === -1 && newEp < 0) { newSe--; if(newSe>=0) newEp = currentItem.seasons[newSe].episodes.length-1; else return; }
        if (newSe>=0 && newSe<currentItem.seasons.length) playEpisode(newSe, newEp); else exitPlayer();
    }

    // ================= UTILS & SEARCH =================
    function initShaka() {
        shaka.polyfill.installAll();
        if (shaka.Player.isBrowserSupported()) {
            player = new shaka.Player(document.getElementById('video'));
            const ui = new shaka.ui.Overlay(player, document.getElementById('player-container'), document.getElementById('video'));
            ui.configure({ controlPanelElements: ['time_and_duration', 'spacer', 'mute', 'volume', 'fullscreen', 'overflow_menu'] });
            player.addEventListener('error', onError);
            document.getElementById('video').addEventListener('timeupdate', () => {
                if (!document.getElementById('video').paused && currentItem) {
                    let saveId = currentItem.id;
                    if(currentItem.type === 'series') {
                        saveId = getEpId(currentItem.id, currentSeasonIdx, currentEpIdx);
                        localStorage.setItem('last_seen_' + currentItem.id, JSON.stringify({ s: currentSeasonIdx, e: currentEpIdx }));
                    }
                    saveProgress(saveId, document.getElementById('video').currentTime, document.getElementById('video').duration);
                }
            });
            document.getElementById('video').addEventListener('ended', () => { if (currentItem.type === 'series') changeEpisode(1); else exitPlayer(); });
        }
    }

    function resetUiTimer() {
        const ui = document.getElementById('player-ui'); ui.classList.remove('ui-fade-out'); clearTimeout(uiTimer);
        if (!document.getElementById('video').paused) uiTimer = setTimeout(() => ui.classList.add('ui-fade-out'), 3500);
    }
    function updateClock() { document.getElementById('p-clock').innerText = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }); }
    function onError(e) { console.error(e); document.getElementById('error-msg').innerText = "Error: " + e.code; document.getElementById('error-modal').style.display='block'; }
    function getEpId(itemId, sIdx, eIdx) { return `${itemId}_s${sIdx}e${eIdx}`; }
    function saveProgress(id, time, dur) { localStorage.setItem('prog_'+id, JSON.stringify({time, pct:(time/dur)*100})); }
    function getProgress(id) { const d = localStorage.getItem('prog_'+id); return d ? JSON.parse(d) : {pct:0, time:0}; }

    // --- SEARCH ---
    function openSearchInterface() {
        currentView = 'search'; document.getElementById('app').style.display = 'none'; document.getElementById('search-interface').style.display = 'block';
        searchString = ""; document.getElementById('virtual-input-display').innerText = ""; document.getElementById('search-results-grid').innerHTML = "";
        generateKeyboard(); setTimeout(() => document.querySelector('.key-btn').focus(), 100);
    }
    function closeSearchInterface() {
        document.getElementById('search-interface').style.display = 'none'; document.getElementById('app').style.display = 'block'; renderView(activeCategory);
    }
    function updateSearchString(char) {
        if(char==='DEL') searchString = searchString.slice(0, -1); else if(char==='SPACE') searchString += " "; else searchString += char;
        document.getElementById('virtual-input-display').innerText = searchString + "_";
        const term = searchString.toLowerCase(); const grid = document.getElementById('search-results-grid'); grid.innerHTML = "";
        if (term.length > 0) {
            const hits = catalog.filter(i => i.title.toLowerCase().includes(term));
            document.getElementById('results-count-text').innerText = `${hits.length} resultados`;
            grid.innerHTML = hits.map(i => cardHtml(i)).join('');
        }
    }
    // (Teclado y Keymap iguales a tu original, resumidos aquí por espacio)
    const KEYMAP={LEFT:[37],UP:[38],RIGHT:[39],DOWN:[40],ENTER:[13,23,66],BACK:[8,461,10009,27,4],PLAY:[415,19,85,179,126],PAUSE:[19,85,179,127],STOP:[413,86],REWIND:[412,89],FAST_FWD:[417,90],NEXT_TRACK:[176,87],PREV_TRACK:[177,88]};
    function isKey(e,n){return KEYMAP[n]&&KEYMAP[n].includes(e.keyCode);}
    function handleRemote(e){
        const k=e.keyCode;
        if(isKey(e,'BACK')){e.preventDefault();if(document.getElementById('error-modal').style.display==='block'){document.getElementById('error-modal').style.display='none';return;}if(currentView==='player')exitPlayer();else if(currentView==='details')closeDetails();else if(currentView==='search')closeSearchInterface();return;}
        if([37,38,39,40].includes(k)){e.preventDefault();moveFocus(k);}
        if(isKey(e,'ENTER')){ if(document.activeElement) document.activeElement.click(); }
        if(currentView==='player'){ if(isKey(e,'PLAY')||isKey(e,'PAUSE'))togglePlay(); if(isKey(e,'NEXT_TRACK'))changeEpisode(1); if(isKey(e,'PREV_TRACK'))changeEpisode(-1); }
    }
    function moveFocus(k){ /* Tu lógica original de navegación espacial */ 
        const current = document.activeElement; const all = Array.from(document.querySelectorAll('.focusable:not([style*="display: none"])'));
        const idx = all.indexOf(current); if(idx===-1 && all.length){ all[0].focus(); return; }
        if(k===39 && idx<all.length-1) all[idx+1].focus(); if(k===37 && idx>0) all[idx-1].focus();
        if(k===40){ const cols=Math.floor(document.body.clientWidth/155); if(idx+cols<all.length) all[idx+cols].focus(); }
        if(k===38){ const cols=Math.floor(document.body.clientWidth/155); if(idx-cols>=0) all[idx-cols].focus(); }
    }

    // Inicialización
    window.onload = async () => { initShaka(); await loadData(); };
</script>
</body>
</html>
