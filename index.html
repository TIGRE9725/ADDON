<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamNet - Universal Player</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ================= ESTILOS GENERALES ================= */
        :root { --primary: #E50914; --bg: #000000; --card-bg: #1e1e1e; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* FOCO VISUAL (TV REMOTE) */
        .focusable:focus {
            outline: none; border: 4px solid white !important; transform: scale(1.05);
            box-shadow: 0 0 25px rgba(0,0,0,0.9); z-index: 100;
            background-color: #333; color: white;
        }

        /* HEADER */
        header { 
            position: fixed; top: 0; width: 100%; height: 70px; z-index: 500; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.8) 50%, transparent 100%); 
            display: flex; align-items: center; padding: 0 20px; box-sizing: border-box;
        }
        
        .nav-left { display: flex; align-items: center; gap: 15px; width: 100%; }
        
        /* BOTÓN VOLVER VISIBLE */
        .btn-header-back {
            background: rgba(255,255,255,0.15); border: none; color: white; border-radius: 50%;
            width: 40px; height: 40px; display: none; align-items: center; justify-content: center;
            cursor: pointer; font-size: 24px; transition: background 0.2s;
        }
        .btn-header-back:hover { background: var(--primary); }

        .logo { color: var(--primary); font-size: 26px; font-weight: 900; margin-right: 15px; text-shadow: 2px 2px 4px black; letter-spacing: 1px; }
        
        .breadcrumb { font-size: 16px; color: #ddd; font-weight: bold; display: flex; align-items: center; gap: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .breadcrumb span { color: var(--primary); margin: 0 5px; }

        /* CONTENEDOR APP */
        #app { padding-top: 90px; height: 100vh; overflow-y: auto; padding-bottom: 50px; box-sizing: border-box; }
        
        /* GRILLA RESPONSIVA */
        .grid-view { 
            display: grid; 
            /* Se adapta automáticamente al tamaño de la pantalla */
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); 
            gap: 20px; padding: 0 4%; 
        }

        /* ESTILO PARA PELICULAS/SERIES (POSTER VERTICAL) */
        .card { 
            aspect-ratio: 2/3; background: var(--card-bg); 
            border-radius: 8px; cursor: pointer; position: relative; overflow: hidden; 
            transition: transform 0.2s; border: 3px solid transparent; 
            display: flex; align-items: center; justify-content: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* ESTILO ESPECIAL PARA NIVEL 1 (BANNERS HORIZONTALES) */
        .grid-view.main-menu {
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Más anchos */
        }
        .card.main-card {
            aspect-ratio: 16/9; /* Formato TV */
            background: #222;
            border: 2px solid #333;
        }
        .card.main-card img { opacity: 0.8; }
        .card.main-card .card-fallback-title { font-size: 1.5rem; text-transform: uppercase; letter-spacing: 2px; }

        /* IMAGEN Y TITULO */
        .card img { width: 100%; height: 100%; object-fit: cover; z-index: 1; transition: opacity 0.3s; }
        .card-fallback-title {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            text-align: center; padding: 10px; font-size: 1rem; font-weight: bold; color: #ccc; z-index: 0; 
            word-wrap: break-word; text-shadow: 2px 2px 4px black;
        }
        
        .folder-icon { position: absolute; top: 10px; right: 10px; z-index: 20; background: rgba(0,0,0,0.7); border-radius: 50%; padding: 6px; }

        /* VISTA DE DETALLES */
        #details-view { position: fixed; inset: 0; background: var(--bg); z-index: 600; display: none; overflow-y: auto; }
        .details-hero { width: 100%; height: 60vh; background-size: cover; background-position: center top; mask-image: linear-gradient(to bottom, black 50%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%); }
        .details-content { position: absolute; top: 40%; left: 5%; width: 90%; z-index: 10; }
        .details-title { font-size: 3rem; font-weight: 900; margin-bottom: 15px; text-shadow: 2px 2px 10px black; line-height: 1.1; }
        .details-desc { font-size: 1.1rem; color: #ddd; max-width: 700px; margin-bottom: 25px; text-shadow: 1px 1px 2px black; line-height: 1.5; }
        
        .btn-large { 
            padding: 12px 35px; font-size: 1.2rem; font-weight: bold; background: white; color: black; 
            border: none; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; 
            transition: transform 0.2s;
        }
        .btn-large:hover { transform: scale(1.05); }
        .btn-secondary { background: rgba(100,100,100,0.6); color: white; margin-left: 15px; }

        /* REPRODUCTOR UI */
        #player-container { position: fixed; inset: 0; background: black; z-index: 5000; display: none; }
        #video { width: 100%; height: 100%; }
        
        .player-ui { 
            position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: space-between; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent 20%, transparent 80%, rgba(0,0,0,0.8));
            transition: opacity 0.3s; z-index: 6000; pointer-events: none;
        }
        .ui-hidden { opacity: 0; }
        
        .p-header { padding: 30px; display: flex; justify-content: space-between; align-items: center; pointer-events: auto; }
        .p-clock { font-size: 1.5rem; font-weight: bold; text-shadow: 2px 2px 4px black; }
        
        .p-controls { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            display: flex; gap: 40px; align-items: center; pointer-events: auto; 
        }
        .ctrl-btn { 
            width: 70px; height: 70px; border-radius: 50%; background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.3); color: white; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s;
        }
        .ctrl-btn:focus, .ctrl-btn:hover { background: var(--primary); transform: scale(1.1); border-color: white; }
        .ctrl-btn.mini { width: 50px; height: 50px; }

        /* LOADING & ERROR */
        #loading-msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.9); padding: 25px 50px; border-radius: 10px; z-index: 2000; display: none; font-weight: bold; color: white; border: 1px solid #333; }
        .error-modal { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; padding: 30px; border: 2px solid #555; z-index: 999999; display: none; text-align: center; border-radius: 10px; box-shadow: 0 0 50px black; }

    </style>
</head>
<body>

    <header id="main-header">
        <div class="nav-left">
            <button id="btn-header-back" class="btn-header-back focusable" onclick="goBack()">
                <span class="material-icons-round">arrow_back</span>
            </button>
            <div class="logo">STREAMNET</div>
            <div id="breadcrumb" class="breadcrumb">Inicio</div>
        </div>
    </header>

    <div id="loading-msg">Cargando...</div>

    <div id="app">
        </div>

    <div id="details-view">
        <div class="details-hero" id="det-hero"></div>
        <div class="details-content">
            <div class="details-title" id="det-title">Título</div>
            <div class="details-desc" id="det-desc">Descripción...</div>
            <div>
                <button id="btn-play-hero" class="btn-large focusable" onclick="playCurrentItem()">
                    <span class="material-icons-round">play_arrow</span> Reproducir
                </button>
                <button class="btn-large btn-secondary focusable" onclick="closeDetails()">
                    <span class="material-icons-round">close</span> Cerrar
                </button>
            </div>
        </div>
    </div>

    <div id="player-container">
        <video id="video" autoplay></video>
        
        <div id="player-ui" class="player-ui">
            <div class="p-header">
                <button class="ctrl-btn mini focusable" onclick="closePlayer()">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <div class="p-clock" id="p-clock">00:00</div>
            </div>

            <div class="p-controls">
                <button id="btn-prev" class="ctrl-btn mini focusable"><span class="material-icons-round">skip_previous</span></button>
                <button id="btn-play-center" class="ctrl-btn focusable" onclick="togglePlay()"><span class="material-icons-round" id="icon-play">pause</span></button>
                <button id="btn-next" class="ctrl-btn mini focusable"><span class="material-icons-round">skip_next</span></button>
            </div>
        </div>
    </div>

    <div id="error-modal" class="error-modal">
        <h3 style="color:#ff5555; margin-top:0">Error de Reproducción</h3>
        <p id="error-msg">No se pudo cargar el contenido.</p>
        <button class="btn-large focusable" style="font-size:1rem; padding:10px 20px;" onclick="closeError()">Cerrar</button>
    </div>

<script>
    // ================= CONFIGURACIÓN =================
    const MAIN_MENU = [
        { id: 'tv_root', title: 'TV EN VIVO', img: 'https://img.icons8.com/color/480/tv.png', type: 'folder' },
        { id: 'movies_root', title: 'PELÍCULAS', img: 'https://img.icons8.com/color/480/movie-projector.png', type: 'folder' },
        { id: 'series_root', title: 'SERIES', img: 'https://img.icons8.com/color/480/tv-show.png', type: 'folder' }
    ];

    const PROVIDERS_DATA = {
        'tv_root': [
            { title: 'IZZI TV', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/scl/fi/9y6dlas2jujl5tlsmrgse/IZZI.m3u?rlkey=qmbog8h21oha6upqxr0y54o2o&st=lgx3ekfe&dl=1', img: 'https://i.imgur.com/LOGO_IZZI.png' },
            { title: 'DISH', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/8vkt6055ift44x9yd5gm8/DISH.m3u?rlkey=66ltvgj7q8lsw352j5gvvm4ri&dl=1', img: 'https://i.imgur.com/LOGO_DISH.png' },
            { title: 'STAR TV', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/vnmo8y2l2z25dpzkv52hl/STARTV.m3u?rlkey=d3oj0vqgldbnmuqf30qaeqqti&dl=1', img: 'https://i.imgur.com/LOGO_STARTV.png' },
            { title: 'DIRECTV', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/avcnlb0d4bjrftmvzyau1/DTVGO.m3u?rlkey=xastr4qmw5e47772el989a0p5&dl=1', img: 'https://i.imgur.com/LOGO_DIRECTV.png' },
            { title: 'CLARO TV', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/eh5mm29jasa9y2gesiih0/CLAROTV.m3u?rlkey=eqn05qohgj10vbsa7279ij5qh&dl=1', img: 'https://i.imgur.com/LOGO_CLARO.png' },
            { title: 'AMAZON', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/agoem2v71esupgmbj1gck/AMAZON.m3u?rlkey=7tzh7zpan9quxz7l019sgndnh&dl=1', img: 'https://i.imgur.com/LOGO_AMAZON.png' },
            { title: 'SENSA (ARG)', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/dv2o6zl6zaekmenag4xkg/ARG.m3u?rlkey=hj1u6yyshizmco48qkrbhkyft&dl=1', img: 'https://i.imgur.com/LOGO_SENSA.png' },
            { title: 'INTERNET (MX)', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/q7xiqcsb8ymwo0g/MX-TPLAY.m3u?dl=1', img: 'https://i.imgur.com/LOGO_INTERNET.png' }
        ],
        'movies_root': [
            { title: 'IZZI GO', type: 'folder', source_type: 'json', url: 'https://gist.githubusercontent.com/TIGRE9725/f7c1267ddd3460062c44d6c93e932c95/raw/izzigo.json', img: 'https://i.imgur.com/LOGO_IZZIGO.png' },
            { title: 'NETVIDEO', type: 'folder', source_type: 'm3u', url: 'https://gist.githubusercontent.com/TIGRE9725/9d495adb5d3737cd9e0ece692aaf1917/raw/netvideo.pelis.m3u', img: 'https://i.imgur.com/LOGO_NETVIDEO.png' },
            { title: 'SERVIDOR 1', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/playlist_peliculas.m3u', img: 'https://via.placeholder.com/300?text=S1' },
            { title: 'SERVIDOR 2', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_server.m3u', img: 'https://via.placeholder.com/300?text=S2' },
            { title: 'SERVIDOR 3', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_dyndns.m3u', img: 'https://via.placeholder.com/300?text=S3' }
        ],
        'series_root': [
            { title: 'IZZI GO', type: 'folder', source_type: 'json', url: 'https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1', img: 'https://i.imgur.com/LOGO_IZZIGO.png' },
            { title: 'NETVIDEO', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/PELIS/main/netvideo.series.m3u', img: 'https://i.imgur.com/LOGO_NETVIDEO.png' },
            { title: 'SERVER 1', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/playlist_series.m3u', img: 'https://via.placeholder.com/300?text=S1' },
            { title: 'SERVER 2', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_server_series.m3u', img: 'https://via.placeholder.com/300?text=S2' },
            { title: 'SERVER 3', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_dyndns_series.m3u', img: 'https://via.placeholder.com/300?text=S3' }
        ]
    };

    let navigationStack = [];
    let player = null;
    let isPlaying = false;
    let isLiveContent = false;
    let selectedItem = null;
    let uiTimer = null;
    const DEFAULT_IMG = "https://via.placeholder.com/300x450/333333/FFFFFF?text=Sin+Imagen";

    window.onload = () => {
        initShaka();
        openFolder("Inicio", MAIN_MENU);
        setInterval(() => {
            document.getElementById('p-clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }, 1000);
    };

    // ================= NAVEGACIÓN =================
    function openFolder(title, items) {
        navigationStack.push({ title, items });
        renderGrid(items);
        updateHeaderUI();
    }

    function goBack() {
        if (navigationStack.length > 1) {
            navigationStack.pop();
            const prev = navigationStack[navigationStack.length - 1];
            renderGrid(prev.items);
            updateHeaderUI();
            return true;
        }
        return false;
    }

    function updateHeaderUI() {
        const title = navigationStack[navigationStack.length - 1].title;
        // Construir Breadcrumb
        const path = navigationStack.map(x => x.title).join(' <span style="font-size:12px; opacity:0.5; margin:0 5px;">▶</span> ');
        document.getElementById('breadcrumb').innerHTML = path;

        // Mostrar/Ocultar botón volver
        const btn = document.getElementById('btn-header-back');
        if (navigationStack.length > 1) {
            btn.style.display = 'flex';
        } else {
            btn.style.display = 'none';
        }
    }

    function renderGrid(items) {
        const app = document.getElementById('app');
        app.innerHTML = '';
        
        // Detectar si es el Menú Principal para aplicar diseño de Banners
        const isMainMenu = navigationStack.length === 1;
        
        const grid = document.createElement('div');
        grid.className = 'grid-view';
        if (isMainMenu) grid.classList.add('main-menu');

        if(!items || items.length === 0) {
            app.innerHTML = '<h3 style="text-align:center; color:#666; margin-top:50px;">Carpeta Vacía</h3>';
            return;
        }

        items.forEach((item) => {
            const card = document.createElement('div');
            card.className = 'card focusable';
            if (isMainMenu) card.classList.add('main-card'); // Clase especial para banners
            
            card.tabIndex = 0;
            
            // SOLUCIÓN CLICK: Asignar evento directamente
            card.addEventListener('click', () => handleItemClick(item));

            const isFolder = item.type === 'folder';
            const imgSrc = item.poster || item.img || "";
            const iconHTML = (isFolder && !isMainMenu) ? '<div class="folder-icon"><span class="material-icons-round">folder_open</span></div>' : '';

            card.innerHTML = `
                <div class="card-fallback-title">${item.title}</div>
                <img src="${imgSrc}" loading="lazy" onerror="this.style.display='none'">
                ${iconHTML}
            `;
            grid.appendChild(card);
        });
        app.appendChild(grid);
        
        // Enfocar primer elemento
        setTimeout(() => { const f = document.querySelector('.card'); if(f) f.focus(); }, 100);
    }

    // ================= MANEJO DE SELECCIÓN =================
    async function handleItemClick(item) {
        // 1. CARPETAS
        if (item.type === 'folder') {
            if (item.children) {
                openFolder(item.title, item.children);
                return;
            }
            // Root Menus
            if (PROVIDERS_DATA[item.id]) {
                openFolder(item.title, PROVIDERS_DATA[item.id]);
                return;
            }
            // External Lists
            if (item.url) {
                document.getElementById('loading-msg').style.display = 'block';
                const content = await fetchAndParseContent(item);
                document.getElementById('loading-msg').style.display = 'none';
                if(content.length > 0) openFolder(item.title, content);
                else alert("Error: Lista vacía o no accesible.");
                return;
            }
        }

        // 2. CONTENIDO
        selectedItem = item;
        const isTV = navigationStack.some(x => x.title === "TV EN VIVO"); // Match exacto con el título
        
        if (isTV) {
            startPlayer(item, true); // Modo LIVE
        } else {
            openDetails(item); // Modo VOD (Pelis/Series)
        }
    }

    function openDetails(item) {
        const view = document.getElementById('details-view');
        document.getElementById('det-hero').style.backgroundImage = `url('${item.poster || DEFAULT_IMG}')`;
        document.getElementById('det-title').innerText = item.title;
        document.getElementById('det-desc').innerText = item.desc || "Sin descripción disponible.";
        
        document.getElementById('app').style.display = 'none';
        document.getElementById('main-header').style.display = 'none';
        view.style.display = 'block';
        
        setTimeout(() => document.getElementById('btn-play-hero').focus(), 100);
    }

    function closeDetails() {
        document.getElementById('details-view').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('main-header').style.display = 'flex';
        setTimeout(() => { const f = document.querySelector('.card'); if(f) f.focus(); }, 100);
    }

    function playCurrentItem() {
        startPlayer(selectedItem, false);
    }

    // ================= REPRODUCTOR =================
    function initShaka() {
        shaka.polyfill.installAll();
        if (shaka.Player.isBrowserSupported()) {
            const video = document.getElementById('video');
            player = new shaka.Player(video);
            player.addEventListener('error', (e) => console.error(e));
        }
    }

    async function startPlayer(item, liveMode) {
        isLiveContent = liveMode;
        
        document.getElementById('app').style.display = 'none';
        document.getElementById('main-header').style.display = 'none';
        document.getElementById('details-view').style.display = 'none';
        document.getElementById('player-container').style.display = 'block';

        // Configurar botones según modo
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        
        if (isLiveContent) {
            btnPrev.style.display = 'none';
            btnNext.style.display = 'none';
            player.configure({ streaming: { bufferingGoal: 10, rebufferingGoal: 2, lowLatencyMode: true } });
        } else {
            btnPrev.style.display = 'flex';
            btnNext.style.display = 'flex';
            player.configure({ streaming: { bufferingGoal: 60, rebufferingGoal: 5 } });
        }

        const video = document.getElementById('video');
        isPlaying = true;
        resetUiTimer();

        try {
            // Detección MP4 Directo
            const ext = item.mpd.split('?')[0].split('.').pop().toLowerCase();
            const isNative = ['mp4','mkv','avi','mov'].includes(ext);

            if (isNative) {
                await player.unload();
                video.src = item.mpd;
            } else {
                if(item.drm && item.drm.clearKeys) {
                    player.configure({ drm: { clearKeys: item.drm.clearKeys } });
                } else {
                    player.configure({ drm: {} });
                }
                await player.load(item.mpd);
            }
            video.play();
            document.getElementById('btn-play-center').focus();

        } catch (e) {
            console.error(e);
            document.getElementById('error-msg').innerText = "Error: " + (e.message || "Fallo de carga");
            document.getElementById('error-modal').style.display = 'block';
            document.querySelector('#error-modal button').focus();
        }
    }

    function togglePlay() {
        const vid = document.getElementById('video');
        const icon = document.getElementById('icon-play');
        if (vid.paused) {
            vid.play();
            icon.innerText = 'pause';
        } else {
            vid.pause();
            icon.innerText = 'play_arrow';
        }
    }

    function closePlayer() {
        const vid = document.getElementById('video');
        vid.pause();
        vid.src = "";
        player.unload();
        document.getElementById('player-container').style.display = 'none';
        isPlaying = false;
        
        if (document.getElementById('details-view').style.display === 'block') {
            // Estábamos en detalles
            setTimeout(() => document.getElementById('btn-play-hero').focus(), 100);
        } else {
            // Estábamos en grid
            document.getElementById('app').style.display = 'block';
            document.getElementById('main-header').style.display = 'flex';
            setTimeout(() => { const f = document.querySelector('.card'); if(f) f.focus(); }, 100);
        }
    }

    function closeError() {
        document.getElementById('error-modal').style.display = 'none';
        closePlayer();
    }

    function resetUiTimer() {
        const ui = document.getElementById('player-ui');
        ui.classList.remove('ui-hidden');
        clearTimeout(uiTimer);
        uiTimer = setTimeout(() => { ui.classList.add('ui-hidden'); }, 4000);
    }
    
    document.getElementById('player-container').addEventListener('mousemove', resetUiTimer);
    document.getElementById('player-container').addEventListener('keydown', resetUiTimer);

    // ================= PARSEADOR M3U =================
    async function fetchAndParseContent(provider) {
        try {
            const response = await fetch(provider.url);
            const text = await response.text();
            if (provider.source_type === 'json' || text.trim().startsWith('[')) return JSON.parse(text).map(processJsonItem);

            const lines = text.split('\n');
            const groups = {}; const rootItems = [];
            let currentItem = null;

            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('#EXTINF')) {
                    currentItem = { type: 'stream', drm: {} };
                    const title = line.match(/,(.+)$/);
                    currentItem.title = title ? title[1].trim() : "Canal";
                    const logo = line.match(/tvg-logo="([^"]+)"/);
                    if(logo) currentItem.poster = logo[1];
                    const group = line.match(/group-title="([^"]+)"/);
                    currentItem.group = group ? group[1].trim() : "General";
                } else if (line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                    if (currentItem) {
                        const keys = line.split('=')[1].split(',');
                        const clearKeys = {};
                        keys.forEach(k => { const [id, val] = k.split(':'); if(id&&val) clearKeys[id]=val; });
                        currentItem.drm.clearKeys = clearKeys;
                    }
                } else if (line.startsWith('http')) {
                    if (currentItem) {
                        if (line.includes('|')) {
                            const [url, params] = line.split('|');
                            currentItem.mpd = url;
                            const p = new URLSearchParams(params);
                            const ck = p.get('clearkey');
                            if(ck) { const [id, val] = ck.split(':'); if(id&&val) currentItem.drm.clearKeys = {[id]:val}; }
                        } else { currentItem.mpd = line; }
                        
                        if(currentItem.group) {
                            if(!groups[currentItem.group]) groups[currentItem.group] = [];
                            groups[currentItem.group].push(currentItem);
                        } else rootItems.push(currentItem);
                        currentItem = null;
                    }
                }
            }
            const structure = [];
            for (const [key, val] of Object.entries(groups)) {
                structure.push({ title: key, type: 'folder', children: val, img: val[0]?.poster });
            }
            return [...structure, ...rootItems];
        } catch (e) { console.error(e); return []; }
    }
    
    function processJsonItem(item) {
        return { title: item.title||item.titulo, poster: item.img||item.poster, type: 'stream', mpd: item.mpd||item.url, drm: item.drm||{} };
    }

    // ================= INPUTS =================
    window.addEventListener('keydown', (e) => {
        const k = e.keyCode;
        
        // BACK
        if ([8, 27, 461, 10009, 4].includes(k)) {
            e.preventDefault();
            if(isPlaying) { closePlayer(); return; }
            if(document.getElementById('details-view').style.display === 'block') { closeDetails(); return; }
            if(document.getElementById('error-modal').style.display === 'block') { closeError(); return; }
            goBack();
        }

        // ENTER
        if (k === 13 || k === 23 || k === 66) {
            const act = document.activeElement;
            if(act && (act.classList.contains('card') || act.tagName === 'BUTTON')) act.click();
        }

        // FLECHAS
        if ([37,38,39,40].includes(k)) {
            // Bloqueo de avance en Live TV
            if (isPlaying && isLiveContent && (k === 37 || k === 39)) {
                e.preventDefault(); return;
            }
            if (!isPlaying) {
                e.preventDefault();
                navigateGrid(k);
            }
        }
    });

    function navigateGrid(key) {
        const items = Array.from(document.querySelectorAll('.card, button:not([style*="display: none"])'));
        if (!items.length) return;
        
        const cur = document.activeElement;
        const idx = items.indexOf(cur);
        
        if (idx === -1) { items[0].focus(); return; }
        
        // Navegación simple lineal si hay pocos elementos o estamos en header
        let next = idx;
        if(key === 39) next++;
        if(key === 37) next--;
        
        // Arriba/Abajo aproximado para grid
        if (cur.classList.contains('card')) {
            const gridWidth = document.querySelector('.grid-view').offsetWidth;
            const cardWidth = cur.offsetWidth + 20; 
            const cols = Math.floor(gridWidth / cardWidth) || 1;
            if(key === 40) next += cols;
            if(key === 38) next -= cols;
        }

        if(next >= 0 && next < items.length) items[next].focus();
    }

</script>
</body>
</html>
