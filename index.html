<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamNet - Universal Player</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* =========================================
           ESTILOS GENERALES
           ========================================= */
        :root { --primary: #E50914; --bg: #000000; --key-bg: #222; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* Interfaz de Menú */
        #ui-container { padding: 20px; height: 100vh; overflow-y: auto; }
        .categoria-titulo { font-size: 24px; font-weight: 900; margin-bottom: 10px; border-bottom: 2px solid var(--primary); display: inline-block; padding-bottom: 5px; }
        .grid-contenido { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-bottom: 30px; }
        
        .card { background: var(--key-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; position: relative; }
        .card:hover { transform: scale(1.05); }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        .card.tv img { height: 100px; object-fit: contain; background: white; padding: 10px; }
        .card-info { padding: 10px; font-size: 14px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Contenedor del Reproductor */
        #video-container { display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: black; }
        #video { width: 100%; height: 100%; }
        
        /* Botón de regreso */
        #btn-cerrar { position: absolute; top: 20px; left: 20px; z-index: 10000; background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>

    <div id="ui-container">
        <div id="catalogo-tv"></div>
        <div id="catalogo-peliculas"></div>
        <div id="catalogo-series"></div>
    </div>

    <div id="video-container" data-shaka-player-container>
        <button id="btn-cerrar" onclick="cerrarReproductor()"><span class="material-icons-round">arrow_back</span></button>
        <video id="video" autoplay data-shaka-player></video>
    </div>

    <script>
        // =========================================================================
        // NÚCLEO STREAMNET SERVERLESS: LÓGICA DE DATOS Y REPRODUCTOR
        // =========================================================================

        const URL_TV = "https://dl.dropboxusercontent.com/s/xfnhw0dfk7hrdx0zphj3l/TV-PLUS.m3u?rlkey=iqzrr4s7bjo7jljw02gd42apt&dl=1";
        const URL_PELICULAS = "https://dl.dropboxusercontent.com/s/2hv588f06l7y265fx12ti/peliculas.json?rlkey=w2ob1lmu9clymri00puohuhbd&dl=1";
        const URL_SERIES = "https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1";

        let currentItem = null;
        let currentSeasonIdx = 0;
        let currentEpIdx = 0;

        // ==========================================
        // 1. INICIALIZACIÓN DE SHAKA PLAYER Y FILTROS
        // ==========================================
        async function initApp() {
            shaka.polyfill.installAll();
            if (!shaka.Player.isBrowserSupported()) {
                console.error('Navegador no soportado');
                return;
            }

            const video = document.getElementById('video');
            window.player = new shaka.Player(video);

            // Escuchar errores de Shaka
            window.player.addEventListener('error', onErrorEvent);

            // EL FILTRO MAESTRO (Engaño a Izzi/Sensa para TODO el contenido)
            window.player.getNetworkingEngine().registerRequestFilter(function(type, request) {
                if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST || 
                    type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                    
                    const url = request.uris[0];
                    if (url.includes('izzigo.tv')) {
                        request.headers['Referer'] = 'https://www.izzigo.tv/';
                        request.headers['Origin'] = 'https://www.izzigo.tv';
                    } else if (url.includes('sensa.com.ar')) {
                        request.headers['Referer'] = 'https://player.sensa.com.ar/';
                    }
                }
            });

            // Guardar progreso periódicamente (Tu función nativa)
            video.addEventListener('timeupdate', () => {
                if (currentItem && currentItem.tipo !== 'tv' && video.currentTime > 5) {
                    let id = currentItem.tipo === 'series' ? getEpId(currentItem.id, currentSeasonIdx, currentEpIdx) : currentItem.id;
                    saveProgress(id, video.currentTime, video.duration);
                }
            });

            // Iniciar descarga de catálogos al vuelo
            await descargarCatalogos();
        }

        // ==========================================
        // 2. DESCARGA Y PARSEO DE DATOS (SERVERLESS)
        // ==========================================
        async function descargarCatalogos() {
            try {
                // Descargar JSONs
                const [resPeliculas, resSeries, resTV] = await Promise.all([
                    fetch(URL_PELICULAS),
                    fetch(URL_SERIES),
                    fetch(URL_TV)
                ]);

                const peliculas = await resPeliculas.json();
                const series = await resSeries.json();
                
                // Parsear M3U de TV localmente
                const textoTV = await resTV.text();
                const canales = parsearM3U(textoTV);

                renderizarCategoria('catalogo-tv', 'TV en Vivo', canales, 'tv');
                renderizarCategoria('catalogo-peliculas', 'Películas', peliculas, 'movies');
                renderizarCategoria('catalogo-series', 'Series', series, 'series');

            } catch (error) {
                console.error("Error al sincronizar datos:", error);
            }
        }

        function parsearM3U(texto) {
            const lineas = texto.split('\n');
            let canales = [];
            let canalActual = {};

            for (let linea of lineas) {
                linea = linea.trim();
                if (linea.startsWith('#EXTINF')) {
                    const logoMatch = linea.match(/tvg-logo="(.*?)"/);
                    canalActual.logo = logoMatch ? logoMatch[1] : '';
                    canalActual.nombre = linea.split(',').pop();
                    canalActual.tipo = 'tv';
                } else if (linea.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                    const claves = linea.split('=')[1].split(':');
                    canalActual.drm = { clearKeys: { [claves[0]]: claves[1] } };
                } else if (linea.startsWith('http') && linea.includes('.mpd')) {
                    canalActual.mpd = linea;
                    if (canalActual.drm) canales.push(canalActual);
                    canalActual = {}; 
                }
            }
            return canales;
        }

        // ==========================================
        // 3. RENDERIZADO DE INTERFAZ
        // ==========================================
        function renderizarCategoria(contenedorId, titulo, items, tipo) {
            const contenedor = document.getElementById(contenedorId);
            let html = `<div class="categoria-titulo">${titulo}</div><div class="grid-contenido">`;
            
            items.forEach((item, index) => {
                // Si es serie, tomamos el MPD del primer episodio como base para iniciar
                let mpd = item.mpd;
                if(tipo === 'series' && item.estaciones) {
                    mpd = item.estaciones[0].episodios[0].mpd; 
                    // Almacenamos el item completo para procesarlo luego en tu lógica de episodios
                }

                html += `
                    <div class="card ${tipo === 'tv' ? 'tv' : ''}" onclick='prepararReproduccion(${JSON.stringify(item).replace(/'/g, "&apos;")})'>
                        <img src="${item.logo || item.poster || item.img}" alt="${item.nombre || item.id}">
                        <div class="card-info">${item.nombre || item.id}</div>
                    </div>
                `;
            });
            html += `</div>`;
            contenedor.innerHTML = html;
        }

        // ==========================================
        // 4. MOTOR DE REPRODUCCIÓN UNIVERSAL
        // ==========================================
        async function prepararReproduccion(item) {
            currentItem = item;
            let urlFinal = item.mpd;

            // Logica para Series (Cargar primer episodio por defecto o el último visto)
            if (item.tipo === 'series') {
                // Aquí puedes integrar tu UI de selección de episodios. 
                // Por ahora, forzamos la reproducción del S01E01.
                currentSeasonIdx = 0;
                currentEpIdx = 0;
                urlFinal = item.estaciones[0].episodios[0].mpd;
                item.drm = item.estaciones[0].episodios[0].drm; // Extraer DRM del episodio
            }

            // Lógica de Catchup Dinámico para canales en vivo que lo soporten
            if (item.tipo === 'tv' && urlFinal.includes('{utc}')) {
                const horasAtras = 0; // 0 = En vivo (Puedes crear un botón para cambiar esto a 2 horas)
                const ahora = new Date();
                const tiempoInicio = new Date(ahora.getTime() - (horasAtras * 3600000));
                
                const utcStart = Math.floor(tiempoInicio.getTime() / 1000);
                const utcEnd = Math.floor(ahora.getTime() / 1000);

                urlFinal = urlFinal.replace('{utc}', utcStart).replace('{utcend}', utcEnd);
            }

            try {
                // Limpiar DRM anterior y aplicar el nuevo si existe
                window.player.configure({ drm: item.drm || {} });

                // Mostrar interfaz de video
                document.getElementById('ui-container').style.display = 'none';
                document.getElementById('video-container').style.display = 'block';

                await window.player.load(urlFinal);
                
                // Retomar progreso (Solo para VOD)
                if (item.tipo !== 'tv') {
                    let id = item.tipo === 'series' ? getEpId(item.id, currentSeasonIdx, currentEpIdx) : item.id;
                    let prog = getProgress(id);
                    if (prog && prog.time > 5) {
                        document.getElementById('video').currentTime = prog.time;
                    }
                }
                
                console.log("Reproducción exitosa!");

            } catch (e) {
                console.error("Error en la carga:", e);
                showError("No se pudo cargar el stream.");
                cerrarReproductor();
            }
        }

        function cerrarReproductor() {
            window.player.unload();
            document.getElementById('video-container').style.display = 'none';
            document.getElementById('ui-container').style.display = 'block';
            currentItem = null;
        }

        // ==========================================
        // 5. FUNCIONES UTILITARIAS Y DE ERROR (De tu código original)
        // ==========================================
        function onErrorEvent(event) { onError(event.detail); }
        function onError(error) { console.error('Error código', error.code, 'objeto', error); showError(error.code); }
        function showError(msg) { console.log("Error interceptado:", msg); } // Sin popups molestos
        
        function getEpId(itemId, sIdx, eIdx) { return `${itemId}_s${sIdx}e${eIdx}`; }
        function saveProgress(id, time, dur) { localStorage.setItem('prog_'+id, JSON.stringify({time, pct:(time/dur)*100})); }
        function getProgress(id) { const d = localStorage.getItem('prog_'+id); return d ? JSON.parse(d) : null; }

        // Arrancar la magia cuando cargue la página
        document.addEventListener('DOMContentLoaded', initApp);

    </script>
</body>
</html>
