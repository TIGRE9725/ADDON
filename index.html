<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamNet - Lite</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* === ESTILOS BASE (OPTIMIZADOS PARA RENDIMIENTO) === */
        :root { --primary: #E50914; --bg: #141414; --card-bg: #222; --text: #fff; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; overflow: hidden; user-select: none; }
        
        /* FOCO DE ALTO RENDIMIENTO (Solo Borde, sin sombras pesadas) */
        .focusable:focus {
            outline: 4px solid white;
            transform: scale(1.05);
            z-index: 100;
            background-color: #333;
        }

        /* HEADER */
        header { 
            position: fixed; top: 0; width: 100%; height: 70px; z-index: 50; 
            background: rgba(0,0,0,0.9); /* Fondo sólido para rendimiento */
            display: flex; align-items: center; justify-content: space-between; /* Separa Izq y Der */
            padding: 0 40px; box-sizing: border-box; border-bottom: 1px solid #333;
        }
        
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .logo { color: var(--primary); font-size: 28px; font-weight: 900; letter-spacing: 1px; }
        .breadcrumb { font-size: 18px; color: #ccc; font-weight: bold; text-transform: uppercase; }
        .clock { font-size: 1.5rem; font-weight: bold; color: #fff; font-variant-numeric: tabular-nums; }
        
        .btn-back { background: transparent; border: 2px solid #555; color: white; border-radius: 50%; width: 45px; height: 45px; display: none; align-items: center; justify-content: center; cursor: pointer; font-size: 24px; }
        .btn-back:hover { background: #333; border-color: white; }

        /* GRID PRINCIPAL */
        #app { padding-top: 90px; height: 100vh; overflow-y: auto; padding-bottom: 50px; box-sizing: border-box; }
        
        .grid-view { 
            display: grid; 
            /* Tarjetas más grandes para PC y TV */
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); 
            gap: 20px; padding: 0 4%; 
        }
        
        /* MENU PRINCIPAL (Rectangular) */
        .grid-view.main-menu { grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); }
        .card.main-card { aspect-ratio: 16/9; border: 1px solid #444; }
        .card.main-card img { opacity: 0.7; }
        .card.main-card .card-title { font-size: 1.5rem; text-transform: uppercase; bottom: 10px; top: auto; background: rgba(0,0,0,0.8); width: 100%; }

        /* TARJETAS NORMALES */
        .card { 
            aspect-ratio: 2/3; background: var(--card-bg); border-radius: 6px; cursor: pointer; 
            position: relative; overflow: hidden; border: 2px solid transparent; 
            transition: transform 0.1s ease-out; /* Animación muy corta */
        }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card-title { 
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; 
            text-align: center; padding: 5px; font-weight: bold; color: #eee; z-index: 0; font-size: 1rem;
        }
        .folder-icon { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.8); padding: 5px; border-radius: 50%; z-index: 2; }

        /* VISTA DETALLES (SOLO PELIS Y SERIES) */
        #details-view { position: fixed; inset: 0; background: #111; z-index: 60; display: none; overflow-y: auto; }
        .det-hero { width: 100%; height: 50vh; background-size: cover; opacity: 0.6; }
        .det-content { position: absolute; top: 10%; left: 5%; width: 60%; z-index: 10; padding-bottom: 50px; }
        .det-title { font-size: 3rem; font-weight: 900; margin-bottom: 10px; line-height: 1.1; }
        .det-desc { font-size: 1.1rem; color: #bbb; margin-bottom: 25px; max-width: 800px; background: rgba(0,0,0,0.5); padding: 10px; border-radius: 5px; }
        
        .btn-action { padding: 12px 30px; font-size: 1.2rem; font-weight: bold; background: white; color: black; border: none; cursor: pointer; border-radius: 4px; display: inline-flex; align-items: center; gap: 10px; margin-right: 15px; }
        .btn-action:focus { transform: scale(1.1); background: var(--primary); color: white; outline: 3px solid white; }
        .btn-secondary { background: #444; color: white; }

        /* SECCIÓN SERIES */
        #series-box { margin-top: 20px; background: #1a1a1a; padding: 20px; border-radius: 8px; border: 1px solid #333; display: none; }
        .season-head { display: flex; align-items: center; gap: 20px; margin-bottom: 15px; }
        .season-sel { padding: 10px; font-size: 1.1rem; background: #333; color: white; border: 1px solid #666; }
        .ep-list { display: flex; flex-direction: column; gap: 8px; }
        .ep-card { display: flex; align-items: center; gap: 15px; padding: 12px; background: #2a2a2a; cursor: pointer; border: 2px solid transparent; }
        .ep-card:focus { border-color: white; background: #444; transform: translateX(10px); }

        /* REPRODUCTOR SIMPLE */
        #player-container { position: fixed; inset: 0; background: black; z-index: 5000; display: none; }
        #video { width: 100%; height: 100%; }
        
        /* UI DEL PLAYER (Minimalista) */
        .player-ui { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 30px; }
        .p-top { display: flex; justify-content: space-between; align-items: flex-start; }
        .p-title { font-size: 1.5rem; font-weight: bold; text-shadow: 2px 2px 4px black; }
        .p-controls { pointer-events: auto; position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }
        .ctrl-btn { width: 50px; height: 50px; border-radius: 50%; background: rgba(0,0,0,0.6); border: 2px solid #aaa; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .ctrl-btn:focus { background: var(--primary); border-color: white; transform: scale(1.1); }

        /* LOADING */
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); background: #222; padding: 20px 40px; border-radius: 8px; display: none; z-index: 9999; border: 1px solid #444; font-weight: bold; }
    </style>
</head>
<body>

    <header>
        <div class="nav-left">
            <button id="btn-back" class="btn-back focusable" onclick="goBack()">
                <span class="material-icons-round">arrow_back</span>
            </button>
            <div class="logo">STREAMNET</div>
            <div id="breadcrumb" class="breadcrumb">INICIO</div>
        </div>
        <div id="clock" class="clock">00:00</div>
    </header>

    <div id="loading">Cargando...</div>

    <div id="app"></div>

    <div id="details-view">
        <div class="det-hero" id="det-hero"></div>
        <div class="det-content">
            <div class="det-title" id="det-title">Título</div>
            <div class="det-desc" id="det-desc">Sinopsis...</div>
            
            <div id="action-buttons">
                <button id="btn-play" class="btn-action focusable" onclick="playCurrent()">
                    <span class="material-icons-round">play_arrow</span> Reproducir
                </button>
                <button class="btn-action btn-secondary focusable" onclick="closeDetails()">
                    <span class="material-icons-round">close</span> Cerrar
                </button>
            </div>
            
            <div id="series-box">
                <div class="season-head">
                    <h3>Seleccionar Temporada:</h3>
                    <select id="season-select" class="season-sel focusable"></select>
                </div>
                <div id="episodes-list" class="ep-list"></div>
            </div>
        </div>
    </div>

    <div id="player-container">
        <video id="video" autoplay></video>
        <div class="player-ui">
            <div class="p-top">
                <button class="ctrl-btn focusable" style="pointer-events:auto" onclick="closePlayer()">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <div class="p-title" id="p-title">Título</div>
            </div>
            <div class="p-controls">
                <button class="ctrl-btn focusable" onclick="video.paused ? video.play() : video.pause()">
                    <span class="material-icons-round">play_arrow</span>
                </button>
            </div>
        </div>
    </div>

<script>
    // ================= CONFIGURACIÓN =================
    const MAIN_MENU = [
        { id: 'tv_root', title: 'TV EN VIVO', img: 'https://img.icons8.com/color/480/tv.png', type: 'folder' },
        { id: 'movies_root', title: 'PELÍCULAS', img: 'https://img.icons8.com/color/480/movie-projector.png', type: 'folder' },
        { id: 'series_root', title: 'SERIES', img: 'https://img.icons8.com/color/480/tv-show.png', type: 'folder' }
    ];

    const PROVIDERS = {
        'tv_root': [
            { title: 'IZZI TV', type: 'folder', url: 'https://dl.dropboxusercontent.com/scl/fi/9y6dlas2jujl5tlsmrgse/IZZI.m3u?rlkey=qmbog8h21oha6upqxr0y54o2o&st=lgx3ekfe&dl=1', img: 'https://i.imgur.com/LOGO_IZZI.png' },
            { title: 'DISH', type: 'folder', url: 'https://dl.dropboxusercontent.com/s/8vkt6055ift44x9yd5gm8/DISH.m3u?rlkey=66ltvgj7q8lsw352j5gvvm4ri&dl=1', img: 'https://i.imgur.com/LOGO_DISH.png' },
            { title: 'STAR TV', type: 'folder', url: 'https://dl.dropboxusercontent.com/s/vnmo8y2l2z25dpzkv52hl/STARTV.m3u?rlkey=d3oj0vqgldbnmuqf30qaeqqti&dl=1', img: 'https://i.imgur.com/LOGO_STARTV.png' },
            { title: 'DIRECTV', type: 'folder', url: 'https://dl.dropboxusercontent.com/s/avcnlb0d4bjrftmvzyau1/DTVGO.m3u?rlkey=xastr4qmw5e47772el989a0p5&dl=1', img: 'https://i.imgur.com/LOGO_DIRECTV.png' },
            { title: 'CLARO TV', type: 'folder', url: 'https://dl.dropboxusercontent.com/s/eh5mm29jasa9y2gesiih0/CLAROTV.m3u?rlkey=eqn05qohgj10vbsa7279ij5qh&dl=1', img: 'https://i.imgur.com/LOGO_CLARO.png' },
            { title: 'AMAZON', type: 'folder', url: 'https://dl.dropboxusercontent.com/s/agoem2v71esupgmbj1gck/AMAZON.m3u?rlkey=7tzh7zpan9quxz7l019sgndnh&dl=1', img: 'https://i.imgur.com/LOGO_AMAZON.png' },
            { title: 'SENSA (ARG)', type: 'folder', url: 'https://dl.dropboxusercontent.com/s/dv2o6zl6zaekmenag4xkg/ARG.m3u?rlkey=hj1u6yyshizmco48qkrbhkyft&dl=1', img: 'https://i.imgur.com/LOGO_SENSA.png' },
            { title: 'INTERNET (MX)', type: 'folder', url: 'https://dl.dropboxusercontent.com/s/q7xiqcsb8ymwo0g/MX-TPLAY.m3u?dl=1', img: 'https://i.imgur.com/LOGO_INTERNET.png' }
        ],
        'movies_root': [
            { title: 'IZZI GO', type: 'folder', url: 'https://gist.githubusercontent.com/TIGRE9725/f7c1267ddd3460062c44d6c93e932c95/raw/izzigo.json', img: 'https://i.imgur.com/LOGO_IZZIGO.png' },
            { title: 'NETVIDEO', type: 'folder', url: 'https://gist.githubusercontent.com/TIGRE9725/9d495adb5d3737cd9e0ece692aaf1917/raw/netvideo.pelis.m3u', img: 'https://i.imgur.com/LOGO_NETVIDEO.png' },
            { title: 'SERVIDOR 1', type: 'folder', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/playlist_peliculas.m3u', img: 'https://via.placeholder.com/300?text=S1' },
            { title: 'SERVIDOR 2', type: 'folder', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_server.m3u', img: 'https://via.placeholder.com/300?text=S2' },
            { title: 'SERVIDOR 3', type: 'folder', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_dyndns.m3u', img: 'https://via.placeholder.com/300?text=S3' }
        ],
        'series_root': [
            { title: 'IZZI GO', type: 'folder', url: 'https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1', img: 'https://i.imgur.com/LOGO_IZZIGO.png' },
            { title: 'NETVIDEO', type: 'folder', url: 'https://raw.githubusercontent.com/TIGRE9725/PELIS/main/netvideo.series.m3u', img: 'https://i.imgur.com/LOGO_NETVIDEO.png' },
            { title: 'SERVER 1', type: 'folder', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/playlist_series.m3u', img: 'https://via.placeholder.com/300?text=S1' },
            { title: 'SERVER 2', type: 'folder', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_server_series.m3u', img: 'https://via.placeholder.com/300?text=S2' },
            { title: 'SERVER 3', type: 'folder', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_dyndns_series.m3u', img: 'https://via.placeholder.com/300?text=S3' }
        ]
    };

    let navStack = [];
    let player = null;
    let selectedItem = null;
    const DEFAULT_IMG = "https://via.placeholder.com/300x450/222/FFF?text=Sin+Imagen";

    window.onload = () => {
        initShaka();
        openFolder("INICIO", MAIN_MENU);
        setInterval(updateClock, 1000);
        updateClock();
    };

    function updateClock() {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    // ================= NAVEGACIÓN =================
    function openFolder(title, items) {
        navStack.push({ title, items });
        renderGrid(items);
        updateHeader();
    }

    function goBack() {
        if(navStack.length > 1) {
            navStack.pop();
            renderGrid(navStack[navStack.length-1].items);
            updateHeader();
        }
    }

    function updateHeader() {
        const path = navStack.map(x => x.title).join(' / ');
        document.getElementById('breadcrumb').innerText = path;
        document.getElementById('btn-back').style.display = navStack.length > 1 ? 'flex' : 'none';
    }

    function renderGrid(items) {
        const app = document.getElementById('app');
        app.innerHTML = '';
        
        const isMain = navStack.length === 1;
        const grid = document.createElement('div');
        grid.className = 'grid-view ' + (isMain ? 'main-menu' : '');

        if(!items || items.length === 0) {
            app.innerHTML = '<h3 style="text-align:center; color:#777; margin-top:50px;">Carpeta Vacía</h3>';
            return;
        }

        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card focusable ' + (isMain ? 'main-card' : '');
            card.tabIndex = 0;
            
            // Asignar Click
            card.onclick = () => handleItemClick(item);

            const img = (isMain && item.backdrop) ? item.backdrop : (item.poster || item.img || DEFAULT_IMG);
            const titleHtml = `<div class="card-title">${item.title}</div>`;
            const iconHtml = (item.type==='folder' && !isMain) ? '<div class="folder-icon"><span class="material-icons-round">folder</span></div>' : '';

            card.innerHTML = `${titleHtml}<img src="${img}" loading="lazy" onerror="this.style.display='none'">${iconHtml}`;
            grid.appendChild(card);
        });
        
        app.appendChild(grid);
        
        // Foco automático al primer elemento (Esencial para TV)
        setTimeout(() => {
            const first = document.querySelector('.card');
            if(first) first.focus();
        }, 100);
    }

    // ================= MANEJO DE CLICKS =================
    async function handleItemClick(item) {
        // 1. CARPETAS
        if (item.type === 'folder') {
            if (item.children) { openFolder(item.title, item.children); return; }
            if (PROVIDERS[item.id]) { openFolder(item.title, PROVIDERS[item.id]); return; }
            
            if (item.url) {
                document.getElementById('loading').style.display = 'block';
                const content = await fetchContent(item);
                document.getElementById('loading').style.display = 'none';
                
                if(content.length) openFolder(item.title, content);
                else alert("Lista vacía o error de carga.");
                return;
            }
        }

        // 2. CONTENIDO (TV vs SERIES/PELIS)
        selectedItem = item;
        
        // Revisamos en qué sección estamos
        const rootSection = navStack[1]?.title; 

        if (rootSection === 'TV EN VIVO') {
            // TV: Reproducir Directo
            playVideo(item);
        } else {
            // VOD: Mostrar Detalles
            openDetails(item);
        }
    }

    // ================= VOD DETALLES =================
    function openDetails(item) {
        document.getElementById('det-title').innerText = item.title;
        document.getElementById('det-desc').innerText = item.description || item.desc || "Sin descripción.";
        document.getElementById('det-hero').style.backgroundImage = `url('${item.poster || item.img || DEFAULT_IMG}')`;
        
        const seriesBox = document.getElementById('series-box');
        const btnPlay = document.getElementById('btn-play');

        // LÓGICA DE SERIES
        if (item.type === 'series' || item.seasons) {
            seriesBox.style.display = 'block';
            btnPlay.style.display = 'none'; // Ocultar play general, usar episodios
            renderSeasons(item);
        } else {
            seriesBox.style.display = 'none';
            btnPlay.style.display = 'inline-flex';
            btnPlay.onclick = () => playVideo(item);
        }

        document.getElementById('details-view').style.display = 'block';
        document.getElementById('app').style.display = 'none';
        document.querySelector('header').style.display = 'none';
        
        // Foco inicial
        setTimeout(() => {
            if(seriesBox.style.display === 'block') document.getElementById('season-select').focus();
            else btnPlay.focus();
        }, 100);
    }

    function renderSeasons(item) {
        const sel = document.getElementById('season-select');
        sel.innerHTML = '';
        if(!item.seasons) return;

        item.seasons.forEach((s, idx) => {
            const opt = document.createElement('option');
            opt.value = idx;
            opt.text = `Temporada ${s.season_number || idx+1}`;
            sel.appendChild(opt);
        });
        
        sel.onchange = () => renderEpisodes(item, sel.value);
        sel.value = 0;
        renderEpisodes(item, 0);
    }

    function renderEpisodes(item, sIdx) {
        const list = document.getElementById('episodes-list');
        list.innerHTML = '';
        const season = item.seasons[sIdx];
        if(!season) return;

        (season.episodes || []).forEach((ep, idx) => {
            const row = document.createElement('div');
            row.className = 'ep-card focusable';
            row.tabIndex = 0;
            row.innerHTML = `<b>${idx+1}.</b> ${ep.title}`;
            row.onclick = () => {
                // Crear objeto jugable para el episodio
                const playObj = { 
                    title: ep.title, 
                    mpd: ep.source?.url || ep.mpd || ep.url, 
                    drm: ep.source?.drm || ep.drm 
                };
                playVideo(playObj);
            };
            list.appendChild(row);
        });
    }

    function closeDetails() {
        document.getElementById('details-view').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.querySelector('header').style.display = 'flex';
        setTimeout(() => document.querySelector('.card')?.focus(), 100);
    }

    // ================= REPRODUCTOR =================
    function initShaka() {
        shaka.polyfill.installAll();
        if (shaka.Player.isBrowserSupported()) {
            const video = document.getElementById('video');
            player = new shaka.Player(video);
            player.configure({ preferredAudioLanguage: 'es' });
            player.addEventListener('error', e => console.error('Shaka Error', e));
        }
    }

    async function playVideo(item) {
        const url = item.source?.url || item.mpd;
        if (!url) { alert("Error: No URL"); return; }

        document.getElementById('player-container').style.display = 'block';
        document.getElementById('p-title').innerText = item.title;

        try {
            await player.unload();
            const drm = item.source?.drm || item.drm;
            
            if (drm && drm.clearKeys) {
                player.configure({ drm: { clearKeys: drm.clearKeys } });
            } else {
                player.configure({ drm: {} });
            }
            
            await player.load(url);
            document.getElementById('video').play();
        } catch (e) {
            console.error(e);
            alert("Error al reproducir");
            closePlayer();
        }
    }

    function closePlayer() {
        player.unload();
        document.getElementById('player-container').style.display = 'none';
        
        // Volver a donde estábamos
        if (document.getElementById('details-view').style.display === 'block') {
            setTimeout(() => document.getElementById('season-select').focus(), 100);
        } else {
            setTimeout(() => document.querySelector('.card')?.focus(), 100);
        }
    }

    // ================= PARSERS (Normalizador Universal) =================
    async function fetchContent(item) {
        try {
            const res = await fetch(item.url);
            const text = await res.text();
            
            // JSON
            if(text.trim().startsWith('[')) {
                return JSON.parse(text).map(normalizeItem);
            }
            
            // M3U
            const lines = text.split('\n');
            const groups = {};
            let curr = null;
            
            for(let line of lines) {
                line = line.trim();
                if(line.startsWith('#EXTINF')) {
                    curr = { type: 'stream', drm: {} };
                    const parts = line.split(',');
                    curr.title = parts[parts.length-1].trim();
                    const logo = line.match(/tvg-logo="([^"]+)"/);
                    if(logo) curr.poster = logo[1];
                    const grp = line.match(/group-title="([^"]+)"/);
                    curr.group = grp ? grp[1].replace('IZZI-','') : 'General';
                } else if(line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                    if(curr) {
                        const keys = line.split('=')[1].split(',');
                        const ck = {};
                        keys.forEach(k => { const [id,v] = k.split(':'); if(id&&v) ck[id]=v; });
                        curr.drm.clearKeys = ck;
                    }
                } else if(line.startsWith('http')) {
                    if(curr) {
                        curr.mpd = line.split('|')[0].split('?')[0]; // Limpiar URL
                        if(!groups[curr.group]) groups[curr.group] = [];
                        groups[curr.group].push(curr);
                        curr = null;
                    }
                }
            }
            return Object.keys(groups).map(g => ({
                title: g, type: 'folder', children: groups[g].map(normalizeItem), img: groups[g][0].poster
            }));

        } catch(e) { console.error(e); return []; }
    }

    function normalizeItem(item) {
        return {
            title: item.title || item.titulo,
            poster: item.images?.poster || item.poster || item.img,
            backdrop: item.images?.backdrop || item.backdrop,
            description: item.description || item.sinopsis || item.desc,
            type: (item.type === 'series' || item.estaciones) ? 'series' : 'stream',
            mpd: item.source?.url || item.mpd || item.url,
            drm: item.source?.drm || item.drm,
            // Normalizar temporadas recursivamente
            seasons: (item.seasons || item.estaciones || []).map((s,i) => ({
                season_number: s.season_number || s.numero || i+1,
                episodes: (s.episodes || s.episodios || []).map(e => ({
                    title: e.title || e.titulo,
                    mpd: e.source?.url || e.mpd || e.url,
                    drm: e.source?.drm || e.drm
                }))
            }))
        };
    }

    // ================= TECLADO / CONTROL REMOTO =================
    window.addEventListener('keydown', (e) => {
        const k = e.keyCode;
        
        // BACK (Esc, BackSpace, Return)
        if([8, 27, 461, 10009].includes(k)) {
            e.preventDefault();
            if(document.getElementById('player-container').style.display === 'block') { closePlayer(); return; }
            if(document.getElementById('details-view').style.display === 'block') { closeDetails(); return; }
            goBack();
        }
        
        // ENTER
        if(k === 13 || k === 23) {
            document.activeElement?.click();
        }
        
        // FLECHAS
        if([37,38,39,40].includes(k)) {
            e.preventDefault();
            const items = Array.from(document.querySelectorAll('.focusable:not([style*="display: none"])')); // Solo visibles
            const idx = items.indexOf(document.activeElement);
            if(idx === -1) { items[0]?.focus(); return; }
            
            let next = idx;
            if(k===39) next++; // Right
            if(k===37) next--; // Left
            
            // Navegación Vertical en Grid
            if(k===40 || k===38) {
                const grid = document.querySelector('.grid-view');
                const isGrid = grid && grid.contains(document.activeElement);
                
                if(isGrid && grid.offsetParent !== null) {
                    const card = document.querySelector('.card');
                    if(card) {
                        const cols = Math.floor(grid.offsetWidth / card.offsetWidth);
                        if(k===40) next += cols;
                        if(k===38) next -= cols;
                    }
                } else {
                    if(k===40) next++;
                    if(k===38) next--;
                }
            }
            
            if(next >= 0 && next < items.length) items[next].focus();
        }
    });
</script>
</body>
</html>
