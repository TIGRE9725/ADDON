<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Launcher TV-PLUS</title>
    <style>
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --accent-color: #007bff;
            --hover-color: #3d3d3d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0; padding: 20px;
            display: flex; flex-direction: column; align-items: center;
        }

        h1 { margin-bottom: 30px; text-transform: uppercase; letter-spacing: 2px; font-size: 1.5rem; }
        #mensaje-estado { font-size: 1.2rem; color: #aaa; margin-top: 50px; }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px; width: 100%; max-width: 1200px;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px; padding: 20px;
            text-decoration: none; color: var(--text-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: transform 0.15s, background-color 0.15s, box-shadow 0.15s;
            cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            aspect-ratio: 1 / 1; border: 3px solid transparent; outline: none;
        }

        .card:hover, .card:focus {
            transform: translateY(-5px) scale(1.05);
            background-color: var(--hover-color);
            box-shadow: 0 10px 20px rgba(0,0,0,0.6);
            border-color: var(--accent-color); z-index: 10;
        }

        .card-icon {
            font-size: 3rem; margin-bottom: 12px;
            display: flex; justify-content: center; align-items: center; height: 70px;
        }
        
        .card-icon img { max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 8px; }

        .card-title {
            font-size: 1.1rem; font-weight: bold; text-align: center;
            overflow: hidden; text-overflow: ellipsis;
            display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical;
        }
    </style>
</head>
<body>

    <h1>TV-PLUS (Izzi)</h1>
    <div id="mensaje-estado">Descargando lista M3U...</div>
    <div class="grid-container" id="app-grid"></div>

<script>
    const URL_M3U = "https://dl.dropboxusercontent.com/s/xfnhw0dfk7hrdx0zphj3l/TV-PLUS.m3u?rlkey=iqzrr4s7bjo7jljw02gd42apt&dl=1";
    
    document.addEventListener('DOMContentLoaded', cargarListaM3U);

    async function cargarListaM3U() {
        const estado = document.getElementById('mensaje-estado');
        try {
            const respuesta = await fetch(URL_M3U);
            if (!respuesta.ok) throw new Error("Error de conexi칩n");
            
            const textoM3U = await respuesta.text();
            estado.innerText = "Procesando seguridad y llaves...";
            
            const canales = parsearM3UIzzi(textoM3U);
            
            if (canales.length > 0) {
                estado.style.display = 'none';
                renderizarGrilla(canales);
            } else {
                estado.innerText = "No se encontraron canales v치lidos.";
            }
        } catch (error) {
            estado.innerText = "Error cr칤tico al cargar la lista.";
        }
    }

    function parsearM3UIzzi(contenido) {
        const lineas = contenido.split('\n');
        const canales = [];
        let canalActual = {};

        for (let i = 0; i < lineas.length; i++) {
            let linea = lineas[i].trim();
            if (!linea) continue;

            if (linea.startsWith('#EXTINF')) {
                const partes = linea.split(',');
                canalActual.nombre = partes[partes.length - 1].trim();
                const matchLogo = linea.match(/tvg-logo="([^"]+)"/);
                canalActual.iconoHtml = matchLogo ? `<img src="${matchLogo[1]}" loading="lazy">` : "游닠";
            } 
            // Extraer User Agent de VLC
            else if (linea.startsWith('#EXTVLCOPT:http-user-agent=')) {
                canalActual.userAgent = linea.replace('#EXTVLCOPT:http-user-agent=', '').replace(/"/g, '');
            } 
            // Extraer Headers de Kodi (El Referer y Origin de Izzi)
            else if (linea.startsWith('#KODIPROP:inputstream.adaptive.stream_headers=')) {
                const headersStr = linea.replace('#KODIPROP:inputstream.adaptive.stream_headers=', '');
                const pares = headersStr.split('&');
                pares.forEach(par => {
                    const [key, val] = par.split('=');
                    if (key.toLowerCase() === 'referer') canalActual.referer = val;
                    if (key.toLowerCase() === 'origin') canalActual.origin = val;
                });
            }
            // Extraer el JSON COMPLETO de las llaves
            else if (linea.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                canalActual.keysRaw = linea.replace('#KODIPROP:inputstream.adaptive.license_key=', '');
            } 
            else if (!linea.startsWith('#')) {
                canalActual.mpd = linea;
                if (canalActual.mpd && canalActual.nombre) canales.push(canalActual);
                canalActual = {};
            }
        }
        return canales;
    }

    function renderizarGrilla(canales) {
        const gridContainer = document.getElementById('app-grid');
        gridContainer.innerHTML = ''; 

        canales.forEach((canal, index) => {
            const card = document.createElement('a');
            card.className = 'card';
            card.setAttribute('tabindex', '0');
            if(index === 0) card.id = "first-item";

            // Armar URL con absolutamente todos los par치metros
            let link = `reproductor.html?mpd=${encodeURIComponent(canal.mpd)}`;
            if (canal.keysRaw) link += `&keys=${encodeURIComponent(canal.keysRaw)}`;
            if (canal.referer) link += `&ref=${encodeURIComponent(canal.referer)}`;
            if (canal.origin) link += `&ori=${encodeURIComponent(canal.origin)}`;
            if (canal.userAgent) link += `&ua=${encodeURIComponent(canal.userAgent)}`;
            
            card.href = link;

            card.innerHTML = `<div class="card-icon">${canal.iconoHtml}</div><div class="card-title">${canal.nombre}</div>`;
            card.addEventListener('keydown', (e) => { if (e.key === 'Enter') window.location.href = card.href; });
            gridContainer.appendChild(card);
        });

        setTimeout(() => {
            const first = document.getElementById('first-item');
            if(first) first.focus();
        }, 100);
    }

    // Navegaci칩n D-PAD de la grilla
    document.addEventListener('keydown', (e) => {
        const elementos = Array.from(document.querySelectorAll('.card'));
        if (elementos.length === 0) return;

        let idx = elementos.indexOf(document.activeElement);
        if (idx === -1) { elementos[0].focus(); return; }

        const columnCount = window.getComputedStyle(document.getElementById('app-grid')).getPropertyValue('grid-template-columns').split(' ').length;

        let tecla = e.keyCode;
        if (tecla === 19) tecla = 38; if (tecla === 20) tecla = 40;
        if (tecla === 21) tecla = 37; if (tecla === 22) tecla = 39;

        switch (tecla) {
            case 37: if (idx > 0) elementos[idx - 1].focus(); e.preventDefault(); break;
            case 39: if (idx < elementos.length - 1) elementos[idx + 1].focus(); e.preventDefault(); break;
            case 38: if (idx - columnCount >= 0) elementos[idx - columnCount].focus(); e.preventDefault(); break;
            case 40: if (idx + columnCount < elementos.length) elementos[idx + columnCount].focus(); e.preventDefault(); break;
        }
    });
</script>
</body>
</html>
