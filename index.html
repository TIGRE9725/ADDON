<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamNet - Universal Player</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #E50914; --bg: #000000; --key-bg: #222; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* UTILIDADES Y TOP BAR */
        .oculto { display: none !important; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); position: sticky; top: 0; z-index: 100; }
        #p-clock { font-size: 18px; font-weight: bold; letter-spacing: 1px; }
        .btn-volver { background: transparent; color: white; border: none; font-size: 18px; cursor: pointer; display: flex; align-items: center; font-weight: bold; }
        .btn-volver .material-icons-round { margin-right: 8px; }

        /* MENÚ PRINCIPAL */
        #menu-principal { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; }
        .menu-btn { background: var(--key-bg); border: 2px solid transparent; width: 80%; max-width: 300px; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .menu-btn:hover, .menu-btn:active { border-color: var(--primary); transform: scale(1.05); }
        .menu-btn.tv { border-bottom: 4px solid #3498db; }
        .menu-btn.movies { border-bottom: 4px solid #e74c3c; }
        .menu-btn.series { border-bottom: 4px solid #9b59b6; }

        /* VISTA DE GRUPOS (CATEGORÍAS) */
        #vista-grupos { height: 100vh; overflow-y: auto; padding-bottom: 50px; }
        .grid-grupos { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px; }
        .grupo-card { background: var(--key-bg); padding: 25px 15px; text-align: center; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; border-left: 5px solid var(--primary); transition: 0.2s; text-transform: uppercase; box-shadow: 0 4px 6px rgba(0,0,0,0.3); }
        .grupo-card:hover { background: #333; transform: scale(1.05); border-left-color: #fff; }

        /* VISTA DE CATÁLOGO (CANALES/PELÍCULAS) */
        #vista-catalogo { height: 100vh; overflow-y: auto; padding-bottom: 50px; }
        .grid-contenido { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; padding: 20px; }
        .card { background: var(--key-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; position: relative; }
        .card:hover { transform: scale(1.05); border: 1px solid var(--primary); }
        .card img { width: 100%; height: 190px; object-fit: cover; }
        .card.tv img { height: 90px; object-fit: contain; background: #fff; padding: 15px; }
        .card-info { padding: 10px; font-size: 14px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* VISTA DE DETALLES DE SERIE */
        #vista-serie { height: 100vh; overflow-y: auto; padding-bottom: 50px; }
        .serie-header { display: flex; gap: 20px; margin: 0 20px 20px 20px; }
        .serie-header img { width: 140px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .temporada-titulo { margin: 20px 20px 10px 20px; font-size: 22px; font-weight: bold; color: var(--primary); }
        
        .ep-list { display: flex; flex-direction: column; gap: 15px; padding: 0 20px; }
        .ep-card { display: flex; background: var(--key-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: background 0.2s; align-items: center; }
        .ep-card:hover { background: #333; }
        .ep-thumb { width: 140px; height: 80px; object-fit: cover; background: #000; flex-shrink: 0; }
        .ep-info { padding: 10px 15px; flex-grow: 1; }
        .ep-info h4 { margin: 0 0 5px 0; font-size: 15px; }
        .ep-info p { margin: 0; font-size: 13px; color: #aaa; }
        .ep-progress-bg { width: 100%; height: 3px; background: #444; margin-top: 8px; border-radius: 2px; }
        .ep-progress-bar { height: 100%; background: var(--primary); border-radius: 2px; }

        /* REPRODUCTOR */
        #video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: black; }
        #video { width: 100%; height: 100%; }
        #btn-cerrar-player { position: absolute; top: 20px; left: 20px; z-index: 10000; background: rgba(0,0,0,0.6); color: white; border: none; padding: 12px; border-radius: 50%; cursor: pointer; }
        #controles-serie { position: absolute; bottom: 80px; right: 20px; z-index: 10000; display: flex; gap: 10px; }
        .btn-ep { background: rgba(0,0,0,0.8); color: white; border: 1px solid var(--primary); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-ep:hover { background: var(--primary); }
    </style>
</head>
<body>

    <div id="menu-principal">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/08/Netflix_2015_logo.svg" width="180" style="margin-bottom: 20px; filter: grayscale(1) brightness(2);">
        <div class="menu-btn tv" onclick="abrirCategoriaPrincipal('tv')">TV EN VIVO</div>
        <div class="menu-btn movies" onclick="abrirCategoriaPrincipal('movies')">PELÍCULAS</div>
        <div class="menu-btn series" onclick="abrirCategoriaPrincipal('series')">SERIES</div>
    </div>

    <div id="vista-grupos" class="oculto">
        <div class="top-bar">
            <button class="btn-volver" onclick="irAMenuPrincipal()"><span class="material-icons-round">arrow_back</span> Menú</button>
            <div class="p-clock">--:--</div>
        </div>
        <h2 id="titulo-grupos" style="padding-left: 20px; margin-bottom: 0;"></h2>
        <div id="grid-grupos" class="grid-grupos"></div>
    </div>

    <div id="vista-catalogo" class="oculto">
        <div class="top-bar">
            <button class="btn-volver" id="btn-volver-catalogo" onclick="volverDesdeCatalogo()"><span class="material-icons-round">arrow_back</span> Atrás</button>
            <div class="p-clock">--:--</div>
        </div>
        <h2 id="titulo-catalogo" style="padding-left: 20px; color: var(--primary);"></h2>
        <div id="grid-catalogo" class="grid-contenido"></div>
    </div>

    <div id="vista-serie" class="oculto">
        <div class="top-bar">
            <button class="btn-volver" onclick="cerrarSerie()"><span class="material-icons-round">arrow_back</span> Series</button>
            <div class="p-clock">--:--</div>
        </div>
        <div class="serie-header">
            <img id="serie-poster" src="">
            <div>
                <h2 id="serie-titulo" style="margin-top: 0;"></h2>
                <p id="serie-sinopsis" style="color: #bbb; line-height: 1.4; font-size: 14px;"></p>
            </div>
        </div>
        <div id="lista-temporadas"></div>
    </div>

    <div id="video-container" class="oculto" data-shaka-player-container>
        <button id="btn-cerrar-player" onclick="cerrarReproductor()"><span class="material-icons-round">arrow_back</span></button>
        <div id="controles-serie" class="oculto">
            <button class="btn-ep" onclick="changeEpisode(-1)">Anterior</button>
            <button class="btn-ep" onclick="changeEpisode(1)">Siguiente</button>
        </div>
        <video id="video" autoplay data-shaka-player></video>
    </div>

    <script>
        // ==========================================
        // SISTEMA MULTIFUENTE (JSON y M3U mezclados)
        // ==========================================
        const FUENTES = {
            tv: [
                "https://dl.dropboxusercontent.com/s/xfnhw0dfk7hrdx0zphj3l/TV-PLUS.m3u?rlkey=iqzrr4s7bjo7jljw02gd42apt&dl=1"
                // Añade más URLs aquí separadas por coma
            ],
            movies: [
                "https://gist.githubusercontent.com/TIGRE9725/1706a38ef3eee8f49e547a3837903891/raw/izzigo.m3u",
                "https://gist.githubusercontent.com/TIGRE9725/9d495adb5d3737cd9e0ece692aaf1917/raw/netvideo.pelis.m3u"
                // Añade más URLs aquí separadas por coma
            ],
            series: [
                "https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1"
                // Añade más URLs aquí separadas por coma
            ]
        };

        let db = { tv: [], movies: [], series: [] };
        let currentItem = null, currentSeasonIdx = 0, currentEpIdx = 0;
        let estadoActual = { tipo: '', grupo: '' }; // Rastrea donde está el usuario

        // Reloj
        function updateClock() { 
            const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.querySelectorAll('.p-clock').forEach(el => el.innerText = timeStr);
        }
        setInterval(updateClock, 1000);

        async function initApp() {
            shaka.polyfill.installAll();
            window.player = new shaka.Player(document.getElementById('video'));
            window.player.addEventListener('error', onErrorEvent);
            window.player.configure({ preferredAudioLanguage: 'es', preferredTextLanguage: 'es' });

            window.player.getNetworkingEngine().registerRequestFilter(function(type, request) {
                if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST || type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                    const url = request.uris[0];
                    if (url.includes('izzigo.tv')) {
                        request.headers['Referer'] = 'https://www.izzigo.tv/';
                        request.headers['Origin'] = 'https://www.izzigo.tv';
                    } else if (url.includes('sensa.com.ar')) {
                        request.headers['Referer'] = 'https://player.sensa.com.ar/';
                    }
                }
            });

            document.getElementById('video').addEventListener('timeupdate', () => {
                if (currentItem && currentItem.tipo !== 'tv' && window.player.getMediaElement().currentTime > 5) {
                    let id = currentItem.tipo === 'series' ? getEpId(currentItem.id, currentSeasonIdx, currentEpIdx) : currentItem.id;
                    saveProgress(id, window.player.getMediaElement().currentTime, window.player.getMediaElement().duration);
                }
            });

            descargarFuentesMultiples();
            updateClock();
        }

        // 1. MOTOR DE EXTRACCIÓN UNIVERSAL
        async function descargarFuentesMultiples() {
            db.tv = await procesarFuentes(FUENTES.tv, 'tv');
            db.movies = await procesarFuentes(FUENTES.movies, 'movies');
            db.series = await procesarFuentes(FUENTES.series, 'series');
            console.log("Catálogos unificados cargados:", db);
        }

        async function procesarFuentes(urls, tipoBase) {
            let itemsUnificados = [];
            for (let url of urls) {
                try {
                    let res = await fetch(url);
                    if (url.includes('.json')) {
                        let json = await res.json();
                        json.forEach(item => item.tipo = tipoBase); // Forzar el tipo
                        itemsUnificados = itemsUnificados.concat(json);
                    } else {
                        let texto = await res.text();
                        itemsUnificados = itemsUnificados.concat(parsearM3U(texto, tipoBase));
                    }
                } catch (e) { console.error("Error cargando:", url, e); }
            }
            return itemsUnificados;
        }

        function parsearM3U(texto, tipoBase) {
            let items = [], itemActual = {};
            for (let linea of texto.split('\n')) {
                linea = linea.trim();
                if (linea.startsWith('#EXTINF')) {
                    const logoMatch = linea.match(/tvg-logo="(.*?)"/);
                    const grupoMatch = linea.match(/group-title="(.*?)"/);
                    
                    itemActual.logo = logoMatch ? logoMatch[1] : '';
                    itemActual.poster = itemActual.logo; // Compatibilidad visual para películas
                    itemActual.grupo = grupoMatch ? grupoMatch[1] : 'Sin Categoría';
                    itemActual.nombre = linea.split(',').pop();
                    itemActual.tipo = tipoBase;
                } else if (linea.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                    const claves = linea.split('=')[1].split(':');
                    itemActual.drm = { clearKeys: { [claves[0]]: claves[1] } };
                } else if (linea.startsWith('http') && (linea.includes('.mpd') || linea.includes('.m3u8') || linea.includes('.mp4') || linea.includes('.mkv'))) {
                    itemActual.mpd = linea;
                    items.push(itemActual); // Guardamos haya o no DRM
                    itemActual = {}; 
                }
            }
            return items;
        }

        // ==========================================
        // SISTEMA DE NAVEGACIÓN EN CASCADA
        // ==========================================
        function ocultarTodo() {
            document.querySelectorAll('body > div').forEach(div => div.classList.add('oculto'));
        }

        function irAMenuPrincipal() {
            ocultarTodo();
            document.getElementById('menu-principal').classList.remove('oculto');
        }

        function volverDesdeCatalogo() {
            if (estadoActual.tipo === 'series') {
                irAMenuPrincipal();
            } else {
                abrirGrupos(estadoActual.tipo);
            }
        }

        // FLUJO 1: Click en el Menú Principal
        function abrirCategoriaPrincipal(tipo) {
            estadoActual.tipo = tipo;
            if (tipo === 'series') {
                // Las series van directas al catálogo
                abrirCatalogo(tipo, null);
            } else {
                // TV y Películas abren el menú de Grupos
                abrirGrupos(tipo);
            }
        }

        // FLUJO 2: Renderizar Categorías (Grupos)
        function abrirGrupos(tipo) {
            ocultarTodo();
            document.getElementById('vista-grupos').classList.remove('oculto');
            
            const titulos = { 'tv': 'Categorías de TV', 'movies': 'Géneros de Películas' };
            document.getElementById('titulo-grupos').innerText = titulos[tipo];
            
            const grid = document.getElementById('grid-grupos');
            grid.innerHTML = '';

            // Extraer grupos únicos
            const gruposUnicos = [...new Set(db[tipo].map(item => item.grupo || item.categoria || 'General'))].sort();

            gruposUnicos.forEach(grupo => {
                const btn = document.createElement('div');
                btn.className = 'grupo-card';
                // Colorear el borde dependiendo si es TV o Películas
                btn.style.borderLeftColor = tipo === 'tv' ? '#3498db' : '#e74c3c';
                btn.innerText = grupo;
                btn.onclick = () => abrirCatalogo(tipo, grupo);
                grid.appendChild(btn);
            });
        }

        // FLUJO 3: Renderizar los Items Finales
        function abrirCatalogo(tipo, grupoFiltro) {
            estadoActual.grupo = grupoFiltro;
            ocultarTodo();
            document.getElementById('vista-catalogo').classList.remove('oculto');
            
            document.getElementById('titulo-catalogo').innerText = grupoFiltro ? grupoFiltro : 'Todas las Series';
            
            const grid = document.getElementById('grid-catalogo');
            grid.innerHTML = '';

            // Filtrar los datos
            let itemsParaMostrar = db[tipo];
            if (grupoFiltro) {
                itemsParaMostrar = itemsParaMostrar.filter(item => (item.grupo || item.categoria || 'General') === grupoFiltro);
            }

            itemsParaMostrar.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `card ${tipo === 'tv' ? 'tv' : ''}`;
                
                card.onclick = () => tipo === 'series' ? abrirDetallesSerie(db.series.indexOf(item)) : prepararReproduccion(item);
                
                let imgSrc = item.poster || item.logo || item.img;
                let titulo = item.nombre || item.id || item.title;

                card.innerHTML = `<img src="${imgSrc}" onerror="this.src=''"> <div class="card-info">${titulo}</div>`;
                grid.appendChild(card);
            });
        }

        // ==========================================
        // RUTAS DE SERIES Y REPRODUCTOR (IGUAL QUE ANTES)
        // ==========================================
        function abrirDetallesSerie(index) {
            currentItem = db.series[index];
            ocultarTodo();
            document.getElementById('vista-serie').classList.remove('oculto');

            document.getElementById('serie-poster').src = currentItem.poster || currentItem.img;
            document.getElementById('serie-titulo').innerText = currentItem.id;
            document.getElementById('serie-sinopsis').innerText = currentItem.sinopsis || '';

            const lista = document.getElementById('lista-temporadas');
            lista.innerHTML = '';

            if (currentItem.estaciones) {
                currentItem.estaciones.forEach((estacion, sIdx) => {
                    lista.innerHTML += `<div class="temporada-titulo">Temporada ${estacion.número || sIdx + 1}</div>`;
                    let htmlEpisodios = '<div class="ep-list">';
                    estacion.episodios.forEach((ep, eIdx) => {
                        let prog = getProgress(getEpId(currentItem.id, sIdx, eIdx));
                        let pct = prog && prog.pct ? Math.round(prog.pct) : 0;
                        let barraProgreso = pct > 0 ? `<div class="ep-progress-bg"><div class="ep-progress-bar" style="width: ${pct}%;"></div></div>` : '';
                        let thumbnail = ep.img || currentItem.poster;
                        htmlEpisodios += `
                            <div class="ep-card" onclick="prepararReproduccion(currentItem, ${sIdx}, ${eIdx})">
                                <img src="${thumbnail}" class="ep-thumb" onerror="this.src='${currentItem.poster}'">
                                <div class="ep-info">
                                    <h4>${eIdx + 1}. ${ep.title}</h4>
                                    <p>${ep.duración || ''}</p>
                                    ${barraProgreso}
                                </div>
                            </div>
                        `;
                    });
                    htmlEpisodios += '</div>';
                    lista.innerHTML += htmlEpisodios;
                });
            }
        }

        function cerrarSerie() {
            abrirCatalogo('series', null);
        }

        function changeEpisode(dir) {
            if (!currentItem || currentItem.tipo !== 'series') return;
            let newEp = currentEpIdx + dir, newSe = currentSeasonIdx;
            if (dir === 1 && newEp >= currentItem.estaciones[newSe].episodios.length) { newSe++; newEp = 0; } 
            else if (dir === -1 && newEp < 0) { newSe--; if(newSe >= 0) newEp = currentItem.estaciones[newSe].episodios.length - 1; else return; }
            if(newSe >= 0 && newSe < currentItem.estaciones.length) prepararReproduccion(currentItem, newSe, newEp);
            else cerrarReproductor();
        }

        async function prepararReproduccion(item, sIdx = 0, eIdx = 0) {
            currentItem = item;
            let urlFinal = item.mpd;
            let drmKeys = item.drm;

            if (item.tipo === 'series') {
                currentSeasonIdx = sIdx; currentEpIdx = eIdx;
                const episodio = item.estaciones[sIdx].episodios[eIdx];
                urlFinal = episodio.mpd;
                drmKeys = episodio.drm;
                document.getElementById('controles-serie').classList.remove('oculto');
            } else { document.getElementById('controles-serie').classList.add('oculto'); }

            if (item.tipo === 'tv' && urlFinal.includes('{utc}')) {
                const ahora = new Date();
                const utcNow = Math.floor(ahora.getTime() / 1000);
                urlFinal = urlFinal.replace('{utc}', utcNow).replace('{utcend}', utcNow);
            }

            try {
                ocultarTodo();
                document.getElementById('video-container').classList.remove('oculto');

                window.player.configure({ drm: drmKeys || {} });
                await window.player.load(urlFinal);
                
                if (item.tipo !== 'tv') {
                    let id = item.tipo === 'series' ? getEpId(item.id, currentSeasonIdx, currentEpIdx) : (item.id || item.nombre);
                    let prog = getProgress(id);
                    if (prog && prog.time > 5) document.getElementById('video').currentTime = prog.time;
                }
            } catch (e) { showError(e.code); cerrarReproductor(); }
        }

        function cerrarReproductor() {
            window.player.unload();
            if (currentItem && currentItem.tipo === 'series') {
                abrirDetallesSerie(db.series.indexOf(currentItem)); 
            } else {
                abrirCatalogo(estadoActual.tipo, estadoActual.grupo);
            }
        }

        function onErrorEvent(event) { showError(event.detail.code); }
        function showError(msg) { console.log("Error interceptado:", msg); }
        function getEpId(itemId, sIdx, eIdx) { return `${itemId}_s${sIdx}e${eIdx}`; }
        function saveProgress(id, time, dur) { localStorage.setItem('prog_'+id, JSON.stringify({time, pct:(time/dur)*100})); }
        function getProgress(id) { const d = localStorage.getItem('prog_'+id); return d ? JSON.parse(d) : null; }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
