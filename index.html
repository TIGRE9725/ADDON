<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamNet - Universal Player</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #E50914; --bg: #000000; --key-bg: #222; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* UTILIDADES Y TOP BAR */
        .oculto { display: none !important; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); position: sticky; top: 0; z-index: 100; }
        #p-clock { font-size: 18px; font-weight: bold; letter-spacing: 1px; }
        .btn-volver { background: transparent; color: white; border: none; font-size: 18px; cursor: pointer; display: flex; align-items: center; font-weight: bold; }
        .btn-volver .material-icons-round { margin-right: 8px; }

        /* MENÚ PRINCIPAL */
        #menu-principal { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; }
        .menu-btn { background: var(--key-bg); border: 2px solid transparent; width: 80%; max-width: 300px; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .menu-btn:hover, .menu-btn:active { border-color: var(--primary); transform: scale(1.05); }
        .menu-btn.tv { border-bottom: 4px solid #3498db; }
        .menu-btn.movies { border-bottom: 4px solid #e74c3c; }
        .menu-btn.series { border-bottom: 4px solid #9b59b6; }

        /* VISTA DE CATÁLOGO Y GRUPOS DE TV */
        #vista-catalogo { height: 100vh; overflow-y: auto; padding-bottom: 50px; }
        .tv-grupo-titulo { grid-column: 1 / -1; font-size: 20px; font-weight: 900; color: #fff; border-left: 4px solid var(--primary); padding-left: 10px; margin: 20px 0 5px 0; text-transform: uppercase; }
        .grid-contenido { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 15px; padding: 0 20px; }
        
        .card { background: var(--key-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; position: relative; }
        .card:hover { transform: scale(1.05); border: 1px solid var(--primary); }
        .card img { width: 100%; height: 190px; object-fit: cover; }
        .card.tv img { height: 90px; object-fit: contain; background: #fff; padding: 15px; }
        .card-info { padding: 10px; font-size: 14px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* VISTA DE DETALLES DE SERIE (DISEÑO MEJORADO) */
        #vista-serie { height: 100vh; overflow-y: auto; padding-bottom: 50px; }
        .serie-header { display: flex; gap: 20px; margin: 0 20px 20px 20px; }
        .serie-header img { width: 140px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .temporada-titulo { margin: 20px 20px 10px 20px; font-size: 22px; font-weight: bold; color: var(--primary); }
        
        /* TARJETAS DE EPISODIOS CON MINIATURAS */
        .ep-list { display: flex; flex-direction: column; gap: 15px; padding: 0 20px; }
        .ep-card { display: flex; background: var(--key-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: background 0.2s; align-items: center; }
        .ep-card:hover { background: #333; }
        .ep-thumb { width: 140px; height: 80px; object-fit: cover; background: #000; flex-shrink: 0; }
        .ep-info { padding: 10px 15px; flex-grow: 1; }
        .ep-info h4 { margin: 0 0 5px 0; font-size: 15px; }
        .ep-info p { margin: 0; font-size: 13px; color: #aaa; }
        .ep-progress-bg { width: 100%; height: 3px; background: #444; margin-top: 8px; border-radius: 2px; }
        .ep-progress-bar { height: 100%; background: var(--primary); border-radius: 2px; }

        /* REPRODUCTOR */
        #video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: black; }
        #video { width: 100%; height: 100%; }
        #btn-cerrar-player { position: absolute; top: 20px; left: 20px; z-index: 10000; background: rgba(0,0,0,0.6); color: white; border: none; padding: 12px; border-radius: 50%; cursor: pointer; }
        #controles-serie { position: absolute; bottom: 80px; right: 20px; z-index: 10000; display: flex; gap: 10px; }
        .btn-ep { background: rgba(0,0,0,0.8); color: white; border: 1px solid var(--primary); padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-ep:hover { background: var(--primary); }
    </style>
</head>
<body>

    <div id="menu-principal">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/08/Netflix_2015_logo.svg" width="180" style="margin-bottom: 20px; filter: grayscale(1) brightness(2);">
        <div class="menu-btn tv" onclick="abrirCatalogo('tv')">TV EN VIVO</div>
        <div class="menu-btn movies" onclick="abrirCatalogo('movies')">PELÍCULAS</div>
        <div class="menu-btn series" onclick="abrirCatalogo('series')">SERIES</div>
    </div>

    <div id="vista-catalogo" class="oculto">
        <div class="top-bar">
            <button class="btn-volver" onclick="volverAlMenu()"><span class="material-icons-round">arrow_back</span> Atrás</button>
            <div id="p-clock-cat">--:--</div>
        </div>
        <h2 id="titulo-catalogo" style="padding-left: 20px;"></h2>
        <div id="grid-catalogo" class="grid-contenido"></div>
    </div>

    <div id="vista-serie" class="oculto">
        <div class="top-bar">
            <button class="btn-volver" onclick="cerrarSerie()"><span class="material-icons-round">arrow_back</span> Series</button>
            <div id="p-clock-serie">--:--</div>
        </div>
        <div class="serie-header">
            <img id="serie-poster" src="">
            <div>
                <h2 id="serie-titulo" style="margin-top: 0;"></h2>
                <p id="serie-sinopsis" style="color: #bbb; line-height: 1.4; font-size: 14px;"></p>
            </div>
        </div>
        <div id="lista-temporadas"></div>
    </div>

    <div id="video-container" class="oculto" data-shaka-player-container>
        <button id="btn-cerrar-player" onclick="cerrarReproductor()"><span class="material-icons-round">arrow_back</span></button>
        <div id="controles-serie" class="oculto">
            <button class="btn-ep" onclick="changeEpisode(-1)">Anterior</button>
            <button class="btn-ep" onclick="changeEpisode(1)">Siguiente</button>
        </div>
        <video id="video" autoplay data-shaka-player></video>
    </div>

    <script>
        const URL_TV = "https://dl.dropboxusercontent.com/s/xfnhw0dfk7hrdx0zphj3l/TV-PLUS.m3u?rlkey=iqzrr4s7bjo7jljw02gd42apt&dl=1";
        const URL_PELICULAS = "https://dl.dropboxusercontent.com/s/2hv588f06l7y265fx12ti/peliculas.json?rlkey=w2ob1lmu9clymri00puohuhbd&dl=1";
        const URL_SERIES = "https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1";

        let db = { tv: [], movies: [], series: [] };
        let currentItem = null, currentSeasonIdx = 0, currentEpIdx = 0;

        // 1. EL RELOJ ORIGINAL
        function updateClock() { 
            const timeStr = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            document.getElementById('p-clock-cat').innerText = timeStr;
            document.getElementById('p-clock-serie').innerText = timeStr;
        }
        setInterval(updateClock, 1000);

        async function initApp() {
            shaka.polyfill.installAll();
            window.player = new shaka.Player(document.getElementById('video'));
            window.player.addEventListener('error', onErrorEvent);

            // 2. FORZAR ESPAÑOL POR DEFECTO
            window.player.configure({
                preferredAudioLanguage: 'es',
                preferredTextLanguage: 'es'
            });

            // Filtro de Red
            window.player.getNetworkingEngine().registerRequestFilter(function(type, request) {
                if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST || type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                    const url = request.uris[0];
                    if (url.includes('izzigo.tv')) {
                        request.headers['Referer'] = 'https://www.izzigo.tv/';
                        request.headers['Origin'] = 'https://www.izzigo.tv';
                    } else if (url.includes('sensa.com.ar')) {
                        request.headers['Referer'] = 'https://player.sensa.com.ar/';
                    }
                }
            });

            // Guardado de Progreso
            document.getElementById('video').addEventListener('timeupdate', () => {
                if (currentItem && currentItem.tipo !== 'tv' && window.player.getMediaElement().currentTime > 5) {
                    let id = currentItem.tipo === 'series' ? getEpId(currentItem.id, currentSeasonIdx, currentEpIdx) : currentItem.id;
                    saveProgress(id, window.player.getMediaElement().currentTime, window.player.getMediaElement().duration);
                }
            });

            descargarCatalogos();
            updateClock();
        }

        async function descargarCatalogos() {
            try {
                const [resPeliculas, resSeries, resTV] = await Promise.all([fetch(URL_PELICULAS), fetch(URL_SERIES), fetch(URL_TV)]);
                db.movies = await resPeliculas.json();
                db.series = await resSeries.json();
                db.tv = parsearM3U(await resTV.text());
            } catch (error) { console.error("Error al descargar catálogos:", error); }
        }

        // 3. EXTRAER EL GRUPO DEL M3U
        function parsearM3U(texto) {
            let canales = [], canalActual = {};
            for (let linea of texto.split('\n')) {
                linea = linea.trim();
                if (linea.startsWith('#EXTINF')) {
                    const logoMatch = linea.match(/tvg-logo="(.*?)"/);
                    const grupoMatch = linea.match(/group-title="(.*?)"/); // <-- Captura el grupo
                    
                    canalActual.logo = logoMatch ? logoMatch[1] : '';
                    canalActual.grupo = grupoMatch ? grupoMatch[1] : 'TV GENERAL';
                    canalActual.nombre = linea.split(',').pop();
                    canalActual.tipo = 'tv';
                } else if (linea.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                    const claves = linea.split('=')[1].split(':');
                    canalActual.drm = { clearKeys: { [claves[0]]: claves[1] } };
                } else if (linea.startsWith('http') && linea.includes('.mpd')) {
                    canalActual.mpd = linea;
                    if (canalActual.drm) canales.push(canalActual);
                    canalActual = {}; 
                }
            }
            return canales;
        }

        function volverAlMenu() {
            document.getElementById('vista-catalogo').classList.add('oculto');
            document.getElementById('menu-principal').classList.remove('oculto');
        }

        // 4. AGRUPAR CANALES VISUALMENTE
        function abrirCatalogo(tipo) {
            document.getElementById('menu-principal').classList.add('oculto');
            document.getElementById('vista-catalogo').classList.remove('oculto');
            
            const titulos = { 'tv': 'TV en Vivo', 'movies': 'Películas', 'series': 'Series' };
            document.getElementById('titulo-catalogo').innerText = titulos[tipo];
            
            const grid = document.getElementById('grid-catalogo');
            grid.innerHTML = '';

            if (tipo === 'tv') {
                // Agrupar canales por la etiqueta 'group-title'
                const categoriasTV = {};
                db.tv.forEach(c => {
                    if(!categoriasTV[c.grupo]) categoriasTV[c.grupo] = [];
                    categoriasTV[c.grupo].push(c);
                });

                for (let grupo in categoriasTV) {
                    // Título que ocupa toda la fila
                    grid.innerHTML += `<div class="tv-grupo-titulo">${grupo}</div>`;
                    
                    // Tarjetas del grupo
                    categoriasTV[grupo].forEach(item => {
                        const card = document.createElement('div');
                        card.className = 'card tv';
                        card.onclick = () => prepararReproduccion(item);
                        card.innerHTML = `<img src="${item.logo}" onerror="this.src=''"> <div class="card-info">${item.nombre}</div>`;
                        grid.appendChild(card);
                    });
                }
            } else {
                // Películas y Series (Renderizado normal)
                db[tipo].forEach((item, index) => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.onclick = () => tipo === 'series' ? abrirDetallesSerie(index) : prepararReproduccion(item);
                    card.innerHTML = `<img src="${item.poster || item.img}"> <div class="card-info">${item.id || item.nombre}</div>`;
                    grid.appendChild(card);
                });
            }
        }

        // 5. NUEVO DISEÑO PARA LA LISTA DE EPISODIOS
        function abrirDetallesSerie(index) {
            currentItem = db.series[index];
            document.getElementById('vista-catalogo').classList.add('oculto');
            document.getElementById('vista-serie').classList.remove('oculto');

            document.getElementById('serie-poster').src = currentItem.poster || currentItem.img;
            document.getElementById('serie-titulo').innerText = currentItem.id;
            document.getElementById('serie-sinopsis').innerText = currentItem.sinopsis || '';

            const lista = document.getElementById('lista-temporadas');
            lista.innerHTML = '';

            if (currentItem.estaciones) {
                currentItem.estaciones.forEach((estacion, sIdx) => {
                    lista.innerHTML += `<div class="temporada-titulo">Temporada ${estacion.número || sIdx + 1}</div>`;
                    
                    let htmlEpisodios = '<div class="ep-list">';
                    estacion.episodios.forEach((ep, eIdx) => {
                        let prog = getProgress(getEpId(currentItem.id, sIdx, eIdx));
                        let pct = prog && prog.pct ? Math.round(prog.pct) : 0;
                        let barraProgreso = pct > 0 ? `<div class="ep-progress-bg"><div class="ep-progress-bar" style="width: ${pct}%;"></div></div>` : '';
                        
                        // Usa la imagen del episodio del JSON, o el poster principal si no tiene
                        let thumbnail = ep.img || currentItem.poster;

                        htmlEpisodios += `
                            <div class="ep-card" onclick="prepararReproduccion(currentItem, ${sIdx}, ${eIdx})">
                                <img src="${thumbnail}" class="ep-thumb" onerror="this.src='${currentItem.poster}'">
                                <div class="ep-info">
                                    <h4>${eIdx + 1}. ${ep.title}</h4>
                                    <p>${ep.duración || ''}</p>
                                    ${barraProgreso}
                                </div>
                            </div>
                        `;
                    });
                    htmlEpisodios += '</div>';
                    lista.innerHTML += htmlEpisodios;
                });
            }
        }

        function cerrarSerie() {
            document.getElementById('vista-serie').classList.add('oculto');
            document.getElementById('vista-catalogo').classList.remove('oculto');
            currentItem = null;
        }

        function changeEpisode(dir) {
            if (!currentItem || currentItem.tipo !== 'series') return;
            let newEp = currentEpIdx + dir, newSe = currentSeasonIdx;
            
            if (dir === 1 && newEp >= currentItem.estaciones[newSe].episodios.length) { newSe++; newEp = 0; } 
            else if (dir === -1 && newEp < 0) { newSe--; if(newSe >= 0) newEp = currentItem.estaciones[newSe].episodios.length - 1; else return; }
            
            if(newSe >= 0 && newSe < currentItem.estaciones.length) prepararReproduccion(currentItem, newSe, newEp);
            else cerrarReproductor();
        }

        async function prepararReproduccion(item, sIdx = 0, eIdx = 0) {
            currentItem = item;
            let urlFinal = item.mpd;
            let drmKeys = item.drm;

            if (item.tipo === 'series') {
                currentSeasonIdx = sIdx; currentEpIdx = eIdx;
                const episodio = item.estaciones[sIdx].episodios[eIdx];
                urlFinal = episodio.mpd;
                drmKeys = episodio.drm;
                document.getElementById('controles-serie').classList.remove('oculto');
            } else { document.getElementById('controles-serie').classList.add('oculto'); }

            if (item.tipo === 'tv' && urlFinal.includes('{utc}')) {
                const ahora = new Date();
                const utcNow = Math.floor(ahora.getTime() / 1000);
                urlFinal = urlFinal.replace('{utc}', utcNow).replace('{utcend}', utcNow);
            }

            try {
                document.getElementById('vista-catalogo').classList.add('oculto');
                document.getElementById('vista-serie').classList.add('oculto');
                document.getElementById('menu-principal').classList.add('oculto');
                document.getElementById('video-container').classList.remove('oculto');

                window.player.configure({ drm: drmKeys || {} });
                await window.player.load(urlFinal);
                
                if (item.tipo !== 'tv') {
                    let id = item.tipo === 'series' ? getEpId(item.id, currentSeasonIdx, currentEpIdx) : item.id;
                    let prog = getProgress(id);
                    if (prog && prog.time > 5) document.getElementById('video').currentTime = prog.time;
                }
            } catch (e) { showError(e.code); cerrarReproductor(); }
        }

        function cerrarReproductor() {
            window.player.unload();
            document.getElementById('video-container').classList.add('oculto');
            if (currentItem && currentItem.tipo === 'series') {
                abrirDetallesSerie(db.series.indexOf(currentItem)); 
                document.getElementById('vista-serie').classList.remove('oculto');
            } else {
                document.getElementById('vista-catalogo').classList.remove('oculto');
                currentItem = null;
            }
        }

        function onErrorEvent(event) { showError(event.detail.code); }
        function showError(msg) { console.log("Error interceptado:", msg); }
        function getEpId(itemId, sIdx, eIdx) { return `${itemId}_s${sIdx}e${eIdx}`; }
        function saveProgress(id, time, dur) { localStorage.setItem('prog_'+id, JSON.stringify({time, pct:(time/dur)*100})); }
        function getProgress(id) { const d = localStorage.getItem('prog_'+id); return d ? JSON.parse(d) : null; }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
