<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamNet - Universal Player</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #E50914; --bg: #000000; --key-bg: #222; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* UTILIDADES */
        .oculto { display: none !important; }
        .btn-volver { background: transparent; color: white; border: none; font-size: 18px; padding: 15px; cursor: pointer; display: flex; align-items: center; }
        .btn-volver .material-icons-round { margin-right: 8px; }

        /* MENÚ PRINCIPAL */
        #menu-principal { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; gap: 20px; }
        .menu-btn { background: var(--key-bg); border: 2px solid transparent; width: 80%; max-width: 300px; padding: 20px; text-align: center; font-size: 24px; font-weight: bold; border-radius: 12px; cursor: pointer; transition: 0.3s; }
        .menu-btn:hover, .menu-btn:active { border-color: var(--primary); transform: scale(1.05); }
        .menu-btn.tv { border-bottom: 4px solid #3498db; }
        .menu-btn.movies { border-bottom: 4px solid #e74c3c; }
        .menu-btn.series { border-bottom: 4px solid #9b59b6; }

        /* VISTA DE CATÁLOGO */
        #vista-catalogo { height: 100vh; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .grid-contenido { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
        .card { background: var(--key-bg); border-radius: 8px; overflow: hidden; cursor: pointer; transition: transform 0.2s; position: relative; }
        .card:hover { transform: scale(1.05); }
        .card img { width: 100%; height: 180px; object-fit: cover; }
        .card.tv img { height: 100px; object-fit: contain; background: white; padding: 10px; }
        .card-info { padding: 10px; font-size: 14px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* VISTA DE DETALLES DE SERIE */
        #vista-serie { height: 100vh; overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .serie-header { display: flex; gap: 20px; margin-bottom: 20px; }
        .serie-header img { width: 120px; border-radius: 8px; }
        .episodio-item { background: var(--key-bg); padding: 15px; border-radius: 8px; margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; }
        .episodio-item:hover { background: #333; border-left: 4px solid var(--primary); }
        .temporada-titulo { margin-top: 20px; margin-bottom: 10px; font-size: 20px; color: var(--primary); }

        /* REPRODUCTOR */
        #video-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; background: black; }
        #video { width: 100%; height: 100%; }
        #btn-cerrar-player { position: absolute; top: 20px; left: 20px; z-index: 10000; background: rgba(0,0,0,0.5); color: white; border: none; padding: 10px; border-radius: 50%; cursor: pointer; }
        
        /* Controles extra para Series (Siguiente/Anterior) */
        #controles-serie { position: absolute; bottom: 80px; right: 20px; z-index: 10000; display: flex; gap: 10px; }
        .btn-ep { background: rgba(0,0,0,0.7); color: white; border: 1px solid var(--primary); padding: 10px 15px; border-radius: 8px; cursor: pointer; }
    </style>
</head>
<body>

    <div id="menu-principal">
        <img src="https://upload.wikimedia.org/wikipedia/commons/0/08/Netflix_2015_logo.svg" width="150" style="margin-bottom: 20px; filter: grayscale(1) brightness(2);">
        <div class="menu-btn tv" onclick="abrirCatalogo('tv')">TV EN VIVO</div>
        <div class="menu-btn movies" onclick="abrirCatalogo('movies')">PELÍCULAS</div>
        <div class="menu-btn series" onclick="abrirCatalogo('series')">SERIES</div>
    </div>

    <div id="vista-catalogo" class="oculto">
        <button class="btn-volver" onclick="volverAlMenu()"><span class="material-icons-round">arrow_back</span> Menú Principal</button>
        <h2 id="titulo-catalogo"></h2>
        <div id="grid-catalogo" class="grid-contenido"></div>
    </div>

    <div id="vista-serie" class="oculto">
        <button class="btn-volver" onclick="cerrarSerie()"><span class="material-icons-round">arrow_back</span> Volver a Series</button>
        <div class="serie-header">
            <img id="serie-poster" src="">
            <div>
                <h2 id="serie-titulo"></h2>
                <p id="serie-sinopsis"></p>
            </div>
        </div>
        <div id="lista-temporadas"></div>
    </div>

    <div id="video-container" class="oculto" data-shaka-player-container>
        <button id="btn-cerrar-player" onclick="cerrarReproductor()"><span class="material-icons-round">arrow_back</span></button>
        
        <div id="controles-serie" class="oculto">
            <button class="btn-ep" onclick="changeEpisode(-1)">Anterior</button>
            <button class="btn-ep" onclick="changeEpisode(1)">Siguiente</button>
        </div>

        <video id="video" autoplay data-shaka-player></video>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIÓN Y BASES DE DATOS
        // ==========================================
        const URL_TV = "https://dl.dropboxusercontent.com/s/xfnhw0dfk7hrdx0zphj3l/TV-PLUS.m3u?rlkey=iqzrr4s7bjo7jljw02gd42apt&dl=1";
        const URL_PELICULAS = "https://dl.dropboxusercontent.com/s/2hv588f06l7y265fx12ti/peliculas.json?rlkey=w2ob1lmu9clymri00puohuhbd&dl=1";
        const URL_SERIES = "https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1";

        let db = { tv: [], movies: [], series: [] };
        let currentItem = null;
        let currentSeasonIdx = 0;
        let currentEpIdx = 0;

        // ==========================================
        // INICIALIZACIÓN Y DESCARGA DE DATOS
        // ==========================================
        async function initApp() {
            shaka.polyfill.installAll();
            window.player = new shaka.Player(document.getElementById('video'));
            window.player.addEventListener('error', onErrorEvent);

            // Filtro de red para Izzi y Sensa
            window.player.getNetworkingEngine().registerRequestFilter(function(type, request) {
                if (type === shaka.net.NetworkingEngine.RequestType.MANIFEST || type === shaka.net.NetworkingEngine.RequestType.SEGMENT) {
                    const url = request.uris[0];
                    if (url.includes('izzigo.tv')) {
                        request.headers['Referer'] = 'https://www.izzigo.tv/';
                        request.headers['Origin'] = 'https://www.izzigo.tv';
                    } else if (url.includes('sensa.com.ar')) {
                        request.headers['Referer'] = 'https://player.sensa.com.ar/';
                    }
                }
            });

            // Guardado de progreso
            document.getElementById('video').addEventListener('timeupdate', () => {
                if (currentItem && currentItem.tipo !== 'tv' && window.player.getMediaElement().currentTime > 5) {
                    let id = currentItem.tipo === 'series' ? getEpId(currentItem.id, currentSeasonIdx, currentEpIdx) : currentItem.id;
                    saveProgress(id, window.player.getMediaElement().currentTime, window.player.getMediaElement().duration);
                }
            });

            // Descargar datos en segundo plano
            descargarCatalogos();
        }

        async function descargarCatalogos() {
            try {
                const [resPeliculas, resSeries, resTV] = await Promise.all([fetch(URL_PELICULAS), fetch(URL_SERIES), fetch(URL_TV)]);
                db.movies = await resPeliculas.json();
                db.series = await resSeries.json();
                const textoTV = await resTV.text();
                db.tv = parsearM3U(textoTV);
                console.log("Bases de datos cargadas exitosamente.");
            } catch (error) {
                console.error("Error al descargar catálogos:", error);
            }
        }

        function parsearM3U(texto) {
            let canales = [], canalActual = {};
            for (let linea of texto.split('\n')) {
                linea = linea.trim();
                if (linea.startsWith('#EXTINF')) {
                    const logoMatch = linea.match(/tvg-logo="(.*?)"/);
                    canalActual.logo = logoMatch ? logoMatch[1] : '';
                    canalActual.nombre = linea.split(',').pop();
                    canalActual.tipo = 'tv';
                } else if (linea.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                    const claves = linea.split('=')[1].split(':');
                    canalActual.drm = { clearKeys: { [claves[0]]: claves[1] } };
                } else if (linea.startsWith('http') && linea.includes('.mpd')) {
                    canalActual.mpd = linea;
                    if (canalActual.drm) canales.push(canalActual);
                    canalActual = {}; 
                }
            }
            return canales;
        }

        // ==========================================
        // NAVEGACIÓN Y RENDERIZADO
        // ==========================================
        function volverAlMenu() {
            document.getElementById('vista-catalogo').classList.add('oculto');
            document.getElementById('vista-serie').classList.add('oculto');
            document.getElementById('menu-principal').classList.remove('oculto');
        }

        function abrirCatalogo(tipo) {
            document.getElementById('menu-principal').classList.add('oculto');
            document.getElementById('vista-catalogo').classList.remove('oculto');
            
            const titulos = { 'tv': 'TV en Vivo', 'movies': 'Películas', 'series': 'Series' };
            document.getElementById('titulo-catalogo').innerText = titulos[tipo];
            
            const grid = document.getElementById('grid-catalogo');
            grid.innerHTML = '';

            db[tipo].forEach((item, index) => {
                const card = document.createElement('div');
                card.className = `card ${tipo === 'tv' ? 'tv' : ''}`;
                
                // Si es serie va a los detalles, si es peli/tv va al reproductor
                if(tipo === 'series') {
                    card.onclick = () => abrirDetallesSerie(index);
                } else {
                    card.onclick = () => prepararReproduccion(item);
                }

                card.innerHTML = `
                    <img src="${item.logo || item.poster || item.img}" alt="${item.nombre || item.id}">
                    <div class="card-info">${item.nombre || item.id}</div>
                `;
                grid.appendChild(card);
            });
        }

        // ==========================================
        // LÓGICA DE SERIES
        // ==========================================
        function abrirDetallesSerie(index) {
            currentItem = db.series[index];
            document.getElementById('vista-catalogo').classList.add('oculto');
            document.getElementById('vista-serie').classList.remove('oculto');

            document.getElementById('serie-poster').src = currentItem.poster || currentItem.img;
            document.getElementById('serie-titulo').innerText = currentItem.id;
            document.getElementById('serie-sinopsis').innerText = currentItem.sinopsis || '';

            const lista = document.getElementById('lista-temporadas');
            lista.innerHTML = '';

            // Renderizar Temporadas y Episodios
            if (currentItem.estaciones) {
                currentItem.estaciones.forEach((estacion, sIdx) => {
                    lista.innerHTML += `<div class="temporada-titulo">Temporada ${estacion.número || sIdx + 1}</div>`;
                    
                    estacion.episodios.forEach((ep, eIdx) => {
                        // Revisar si hay progreso guardado para mostrarlo
                        let prog = getProgress(getEpId(currentItem.id, sIdx, eIdx));
                        let infoProgreso = prog && prog.pct > 0 ? `<span style="color:var(--primary); font-size:12px;">(${Math.round(prog.pct)}%)</span>` : '';

                        lista.innerHTML += `
                            <div class="episodio-item" onclick="prepararReproduccion(currentItem, ${sIdx}, ${eIdx})">
                                <span>${eIdx + 1}. ${ep.title} ${infoProgreso}</span>
                                <span>${ep.duración || ''}</span>
                            </div>
                        `;
                    });
                });
            }
        }

        function cerrarSerie() {
            document.getElementById('vista-serie').classList.add('oculto');
            document.getElementById('vista-catalogo').classList.remove('oculto');
            currentItem = null;
        }

        function changeEpisode(dir) {
            if (!currentItem || currentItem.tipo !== 'series') return;
            
            let newEp = currentEpIdx + dir;
            let newSe = currentSeasonIdx;
            
            if (dir === 1 && newEp >= currentItem.estaciones[newSe].episodios.length) { 
                newSe++; newEp = 0; 
            } else if (dir === -1 && newEp < 0) { 
                newSe--; 
                if(newSe >= 0) newEp = currentItem.estaciones[newSe].episodios.length - 1; 
                else return; 
            }
            
            if(newSe >= 0 && newSe < currentItem.estaciones.length) {
                prepararReproduccion(currentItem, newSe, newEp);
            } else {
                cerrarReproductor();
            }
        }

        // ==========================================
        // REPRODUCTOR UNIVERSAL
        // ==========================================
        async function prepararReproduccion(item, sIdx = 0, eIdx = 0) {
            currentItem = item;
            let urlFinal = item.mpd;
            let drmKeys = item.drm;

            // Procesar si es Serie
            if (item.tipo === 'series') {
                currentSeasonIdx = sIdx;
                currentEpIdx = eIdx;
                const episodio = item.estaciones[sIdx].episodios[eIdx];
                urlFinal = episodio.mpd;
                drmKeys = episodio.drm;
                document.getElementById('controles-serie').classList.remove('oculto');
            } else {
                document.getElementById('controles-serie').classList.add('oculto');
            }

            // Procesar Catchup Dinámico para TV
            if (item.tipo === 'tv' && urlFinal.includes('{utc}')) {
                const ahora = new Date();
                const utcStart = Math.floor(ahora.getTime() / 1000);
                const utcEnd = Math.floor(ahora.getTime() / 1000);
                urlFinal = urlFinal.replace('{utc}', utcStart).replace('{utcend}', utcEnd);
            }

            try {
                // Interfaz
                document.getElementById('vista-catalogo').classList.add('oculto');
                document.getElementById('vista-serie').classList.add('oculto');
                document.getElementById('menu-principal').classList.add('oculto');
                document.getElementById('video-container').classList.remove('oculto');

                // Cargar DRM y Video
                window.player.configure({ drm: drmKeys || {} });
                await window.player.load(urlFinal);
                
                // Restaurar Progreso
                if (item.tipo !== 'tv') {
                    let id = item.tipo === 'series' ? getEpId(item.id, currentSeasonIdx, currentEpIdx) : item.id;
                    let prog = getProgress(id);
                    if (prog && prog.time > 5) {
                        document.getElementById('video').currentTime = prog.time;
                    }
                }
            } catch (e) {
                showError(e.code);
                cerrarReproductor();
            }
        }

        function cerrarReproductor() {
            window.player.unload();
            document.getElementById('video-container').classList.add('oculto');
            
            // Volver a la vista correcta
            if (currentItem && currentItem.tipo === 'series') {
                abrirDetallesSerie(db.series.indexOf(currentItem)); // Recargar para actualizar progreso
                document.getElementById('vista-serie').classList.remove('oculto');
            } else {
                document.getElementById('vista-catalogo').classList.remove('oculto');
                currentItem = null;
            }
        }

        // ==========================================
        // UTILIDADES (Progreso y Errores)
        // ==========================================
        function onErrorEvent(event) { showError(event.detail.code); }
        function showError(msg) { console.log("Error de Shaka:", msg); }
        
        function getEpId(itemId, sIdx, eIdx) { return `${itemId}_s${sIdx}e${eIdx}`; }
        function saveProgress(id, time, dur) { localStorage.setItem('prog_'+id, JSON.stringify({time, pct:(time/dur)*100})); }
        function getProgress(id) { const d = localStorage.getItem('prog_'+id); return d ? JSON.parse(d) : null; }

        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
