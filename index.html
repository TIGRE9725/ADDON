<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamNet - Ultimate TV</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ================= ESTILOS NATIVOS (GPU ACCELERATED) ================= */
        :root { --primary: #00A8E8; --bg: #0f0f0f; --card-bg: #1a1a1a; --text: #fff; --overlay-bg: rgba(0,0,0,0.85); }
        body, html { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Roboto', sans-serif; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        /* OPTIMIZACIÓN DE RENDIMIENTO PARA TV BOX */
        .card, .channel-row, .cu-item, .focusable {
            transform: translate3d(0, 0, 0); 
            backface-visibility: hidden;
            perspective: 1000px;
            will-change: transform; /* Fuerza GPU */
            transition: transform 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94), background 0.1s;
        }

        .focusable:focus {
            outline: none; 
            transform: scale(1.03) translate3d(0,0,0);
            border: 2px solid var(--primary) !important;
            box-shadow: 0 5px 20px rgba(0,168,232,0.4); 
            z-index: 100; 
            background-color: #333;
        }

        /* HEADER */
        header { 
            position: fixed; top: 0; width: 100%; height: 60px; z-index: 500; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.95) 0%, rgba(0,0,0,0.0) 100%); 
            display: flex; align-items: center; padding: 0 30px; box-sizing: border-box;
        }
        .nav-left { display: flex; align-items: center; gap: 15px; }
        .logo { color: var(--primary); font-size: 24px; font-weight: 900; letter-spacing: 1px; text-shadow: 2px 2px 4px black; }
        .breadcrumb { font-size: 14px; color: #ddd; font-weight: 700; text-transform: uppercase; margin-left: 20px; opacity: 0.8; }
        .btn-header-back { background: rgba(255,255,255,0.1); border: none; color: white; border-radius: 50%; width: 40px; height: 40px; display: none; align-items: center; justify-content: center; }

        /* GRID PRINCIPAL */
        #app { padding-top: 80px; height: 100vh; overflow-y: auto; padding-bottom: 50px; box-sizing: border-box; }
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 0 4%; }
        .grid-view.main-menu { grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); }
        
        .card { 
            aspect-ratio: 2/3; background: var(--card-bg); border-radius: 6px; cursor: pointer; 
            position: relative; overflow: hidden; border: 2px solid transparent; 
        }
        .card.main-card { aspect-ratio: 16/9; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card-fallback-title { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; text-align: center; padding: 5px; font-size: 0.9rem; font-weight: bold; color: #aaa; z-index: 0; }
        .folder-icon { position: absolute; top: 8px; right: 8px; z-index: 20; background: rgba(0,0,0,0.7); border-radius: 50%; padding: 5px; }

        /* REPRODUCTOR (LAYER 0 - FONDO) */
        #player-container { position: fixed; inset: 0; background: black; z-index: 0; display: none; }
        #video { width: 100%; height: 100%; }
        
        /* UI SUPERPUESTA AL VIDEO */
        .player-ui { 
            position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: space-between; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent 25%, transparent 75%, rgba(0,0,0,0.9)); 
            transition: opacity 0.3s; pointer-events: none; z-index: 20;
        }
        .ui-hidden { opacity: 0; }
        
        .p-header { padding: 30px; display: flex; justify-content: space-between; align-items: flex-start; pointer-events: auto; }
        .p-info { text-align: right; text-shadow: 1px 1px 2px black; }
        .p-title { font-size: 1.5rem; font-weight: bold; }
        .p-prog { font-size: 1rem; color: var(--primary); margin-top: 5px; }
        
        .p-controls { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 30px; pointer-events: auto; }
        .ctrl-btn { width: 60px; height: 60px; border-radius: 50%; background: rgba(0,0,0,0.6); border: 2px solid #555; color: white; display: flex; align-items: center; justify-content: center; }
        
        /* GUÍA EPG (TIVIMATE STYLE OVERLAY) */
        #epg-overlay {
            position: fixed; inset: 0; background: var(--overlay-bg); z-index: 50; display: none;
            grid-template-columns: 350px 1fr; grid-template-rows: 70px 1fr; backdrop-filter: blur(5px);
        }
        .epg-header { grid-column: 1 / -1; display: flex; align-items: center; padding: 0 30px; border-bottom: 1px solid #333; font-weight: bold; font-size: 1.3rem; background: rgba(0,0,0,0.5); }
        .epg-channels { overflow-y: auto; border-right: 1px solid #333; background: rgba(0,0,0,0.3); }
        .epg-details { padding: 30px; overflow-y: auto; }
        
        .channel-row { display: flex; align-items: center; gap: 15px; padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.05); cursor: pointer; border-left: 4px solid transparent; }
        .channel-row:focus { background: rgba(255,255,255,0.1); border-left-color: var(--primary); }
        .ch-logo { width: 50px; height: 40px; object-fit: contain; }
        .ch-now { font-size: 0.8rem; color: #bbb; margin-top: 3px; }

        /* CATCHUP SIDEBAR */
        #catchup-sidebar {
            position: fixed; top: 0; right: 0; width: 400px; height: 100%; background: #151515;
            z-index: 60; transform: translateX(100%); transition: transform 0.3s;
            box-shadow: -10px 0 30px black; display: flex; flex-direction: column; border-left: 1px solid #333;
        }
        #catchup-sidebar.open { transform: translateX(0); }
        .cu-header { padding: 20px; background: var(--primary); font-weight: bold; }
        .cu-list { flex: 1; overflow-y: auto; }
        .cu-item { padding: 15px 20px; border-bottom: 1px solid #333; cursor: pointer; }
        .cu-time { font-size: 0.8rem; color: var(--primary); font-weight: bold; }

        /* DETALLES VOD */
        #details-view { position: fixed; inset: 0; background: var(--bg); z-index: 40; display: none; overflow-y: auto; }
        .details-hero { width: 100%; height: 60vh; background-size: cover; mask-image: linear-gradient(to bottom, black 40%, transparent); }
        .details-content { position: absolute; top: 40%; left: 5%; width: 50%; text-shadow: 2px 2px 4px black; }
        .btn-large { padding: 12px 30px; font-size: 1.1rem; font-weight: bold; background: white; color: black; border: none; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; margin-right: 15px; border-radius: 4px; }

        /* LOADING */
        #loading-msg { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.8); padding: 10px 20px; border-radius: 20px; display: none; z-index: 9999; font-weight: bold; border: 1px solid #333; }
        
        /* SCROLLBAR OCULTO */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
    </style>
</head>
<body>

    <header id="main-header">
        <div class="nav-left">
            <button id="btn-header-back" class="btn-header-back focusable" onclick="goBack()"><span class="material-icons-round">arrow_back</span></button>
            <div class="logo">STREAMNET</div>
            <div id="breadcrumb" class="breadcrumb">INICIO</div>
        </div>
        <div id="clock" style="font-weight:bold; font-size:1.1rem; color:#aaa;">00:00</div>
    </header>

    <div id="loading-msg">Cargando...</div>

    <div id="app"></div>

    <div id="player-container">
        <video id="video" autoplay></video>
        <div id="player-ui" class="player-ui">
            <div class="p-header">
                <button class="ctrl-btn focusable" style="width:40px; height:40px" onclick="closePlayer()"><span class="material-icons-round">arrow_back</span></button>
                <div class="p-info">
                    <div id="p-title" class="p-title">Canal</div>
                    <div id="p-program" class="p-prog"></div>
                </div>
            </div>
            <div class="p-controls">
                <button class="ctrl-btn focusable" onclick="togglePlay()"><span class="material-icons-round" id="icon-play">pause</span></button>
                <button class="ctrl-btn focusable" onclick="openCatchupMenu()" id="btn-catchup" style="display:none"><span class="material-icons-round">history</span></button>
                <button class="ctrl-btn focusable" onclick="openEPG()" id="btn-epg"><span class="material-icons-round">dvr</span></button>
            </div>
        </div>
    </div>

    <div id="epg-overlay">
        <div class="epg-header">
            <span class="material-icons-round" style="margin-right:10px">dvr</span> GUÍA DE CANALES
            <div style="flex:1"></div>
            <button class="btn-header-back focusable" style="display:block" onclick="closeEPG()"><span class="material-icons-round">close</span></button>
        </div>
        <div class="epg-channels" id="epg-list"></div>
        <div class="epg-details">
            <h2 id="epg-sel-title" style="margin-top:0">Selecciona un canal</h2>
            <p id="epg-sel-desc" style="color:#aaa; line-height:1.6; font-size:1.1rem;"></p>
            <div id="epg-actions" style="margin-top:30px; display:none;">
                <button class="btn-large focusable" onclick="playSelectedFromEPG()">
                    <span class="material-icons-round">play_arrow</span> VER AHORA
                </button>
                <button class="btn-large focusable" style="background:#333; color:white" onclick="openCatchupFromEPG()">
                    <span class="material-icons-round">history</span> GRABACIONES
                </button>
            </div>
        </div>
    </div>

    <div id="catchup-sidebar">
        <div class="cu-header"><span class="material-icons-round">history</span> Grabaciones</div>
        <div class="cu-list" id="catchup-list"></div>
    </div>

    <div id="details-view">
        <div class="details-hero" id="det-hero"></div>
        <div class="details-content">
            <h1 id="det-title" style="font-size:3.5rem; margin-bottom:10px">Título</h1>
            <p id="det-desc" style="color:#ccc; margin-bottom:20px; font-size:1.2rem;">Descripción...</p>
            <button id="btn-play-hero" class="btn-large focusable" onclick="playCurrentItem()"><span class="material-icons-round">play_arrow</span> Reproducir</button>
            <button class="btn-large focusable" style="background:#333; color:white" onclick="closeDetails()">Cerrar</button>
        </div>
    </div>

<script>
    // ================= CONFIGURACIÓN =================
    let EPG_DATA = {};
    const DEFAULT_IMG = "https://via.placeholder.com/300x450/1a1a1a/FFFFFF?text=Sin+Imagen";

    const MAIN_MENU = [
        { id: 'tv_root', title: 'TV EN VIVO', img: 'https://img.icons8.com/color/480/tv.png', type: 'folder' },
        { id: 'movies_root', title: 'PELÍCULAS', img: 'https://img.icons8.com/color/480/movie-projector.png', type: 'folder' },
        { id: 'series_root', title: 'SERIES', img: 'https://img.icons8.com/color/480/tv-show.png', type: 'folder' }
    ];

    const PROVIDERS_DATA = {
        'tv_root': [
            { 
                title: 'IZZI TV', type: 'folder', img: 'https://i.imgur.com/LOGO_IZZI.png', 
                source_type: 'm3u', 
                url: 'https://dl.dropboxusercontent.com/scl/fi/9y6dlas2jujl5tlsmrgse/IZZI.m3u?rlkey=qmbog8h21oha6upqxr0y54o2o&st=lgx3ekfe&dl=1', 
                epg_url: 'https://raw.githubusercontent.com/TIGRE9725/guia/main/guia_izzi.xml' 
            },
            { 
                title: 'DISH', type: 'folder', img: 'https://i.imgur.com/LOGO_DISH.png',
                source_type: 'm3u', 
                url: 'https://dl.dropboxusercontent.com/s/8vkt6055ift44x9yd5gm8/DISH.m3u?rlkey=66ltvgj7q8lsw352j5gvvm4ri&dl=1',
                epg_url: 'https://raw.githubusercontent.com/TIGRE9725/guia/main/guia_dish.xml'
            },
            { 
                title: 'CLARO TV', type: 'folder', img: 'https://i.imgur.com/LOGO_CLARO.png',
                source_type: 'm3u', 
                url: 'https://dl.dropboxusercontent.com/s/eh5mm29jasa9y2gesiih0/CLAROTV.m3u?rlkey=eqn05qohgj10vbsa7279ij5qh&dl=1',
                epg_url: 'https://raw.githubusercontent.com/TIGRE9725/guia/main/guia_claro.xml'
            },
            { 
                title: 'STAR TV', type: 'folder', img: 'https://i.imgur.com/LOGO_STARTV.png',
                source_type: 'm3u', 
                url: 'https://dl.dropboxusercontent.com/s/vnmo8y2l2z25dpzkv52hl/STARTV.m3u?rlkey=d3oj0vqgldbnmuqf30qaeqqti&dl=1',
                epg_url: 'https://raw.githubusercontent.com/TIGRE9725/guia/main/guia_startv.xml'
            },
            { title: 'DIRECTV', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/avcnlb0d4bjrftmvzyau1/DTVGO.m3u?rlkey=xastr4qmw5e47772el989a0p5&dl=1', img: 'https://i.imgur.com/LOGO_DIRECTV.png' },
            { title: 'AMAZON', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/agoem2v71esupgmbj1gck/AMAZON.m3u?rlkey=7tzh7zpan9quxz7l019sgndnh&dl=1', img: 'https://i.imgur.com/LOGO_AMAZON.png' },
            { title: 'SENSA (ARG)', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/dv2o6zl6zaekmenag4xkg/ARG.m3u?rlkey=hj1u6yyshizmco48qkrbhkyft&dl=1', img: 'https://i.imgur.com/LOGO_SENSA.png' },
            { title: 'INTERNET (MX)', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/q7xiqcsb8ymwo0g/MX-TPLAY.m3u?dl=1', img: 'https://i.imgur.com/LOGO_INTERNET.png' }
        ],
        'movies_root': [
            { title: 'IZZI GO', type: 'folder', source_type: 'json', url: 'https://gist.githubusercontent.com/TIGRE9725/f7c1267ddd3460062c44d6c93e932c95/raw/izzigo.json', img: 'https://i.imgur.com/LOGO_IZZIGO.png' },
            { title: 'NETVIDEO', type: 'folder', source_type: 'm3u', url: 'https://gist.githubusercontent.com/TIGRE9725/9d495adb5d3737cd9e0ece692aaf1917/raw/netvideo.pelis.m3u', img: 'https://i.imgur.com/LOGO_NETVIDEO.png' },
            { title: 'SERVIDOR 1', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/playlist_peliculas.m3u', img: 'https://via.placeholder.com/300?text=S1' },
            { title: 'SERVIDOR 2', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_server.m3u', img: 'https://via.placeholder.com/300?text=S2' },
            { title: 'SERVIDOR 3', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_dyndns.m3u', img: 'https://via.placeholder.com/300?text=S3' }
        ],
        'series_root': [
            { title: 'IZZI GO', type: 'folder', source_type: 'json', url: 'https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1', img: 'https://i.imgur.com/LOGO_IZZIGO.png' },
            { title: 'NETVIDEO', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/PELIS/main/netvideo.series.m3u', img: 'https://i.imgur.com/LOGO_NETVIDEO.png' },
            { title: 'SERVER 1', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/playlist_series.m3u', img: 'https://via.placeholder.com/300?text=S1' },
            { title: 'SERVER 2', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_server_series.m3u', img: 'https://via.placeholder.com/300?text=S2' },
            { title: 'SERVER 3', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_dyndns_series.m3u', img: 'https://via.placeholder.com/300?text=S3' }
        ]
    };

    let navigationStack = [];
    let player = null;
    let isPlaying = false;
    let selectedItem = null;
    let uiTimer = null;

    window.onload = () => {
        initShaka();
        openFolder("INICIO", MAIN_MENU);
        setInterval(() => {
            const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            document.getElementById('clock').innerText = time;
        }, 1000);
    };

    // ================= EPG (DINÁMICA + PARSER) =================
    async function loadEPG(url) {
        if(!url) return;
        document.getElementById('loading-msg').innerText = "Cargando Guía...";
        document.getElementById('loading-msg').style.display = 'block';
        EPG_DATA = {}; 
        
        try {
            const resp = await fetch(url);
            const text = await resp.text();
            const parser = new DOMParser();
            const xml = parser.parseFromString(text, "text/xml");
            const programmes = xml.querySelectorAll('programme');
            
            programmes.forEach(prog => {
                const channel = prog.getAttribute('channel');
                if (!EPG_DATA[channel]) EPG_DATA[channel] = [];
                EPG_DATA[channel].push({
                    title: prog.querySelector('title')?.textContent || "Sin Título",
                    desc: prog.querySelector('desc')?.textContent || "",
                    start: parseXMLTVDate(prog.getAttribute('start')),
                    end: parseXMLTVDate(prog.getAttribute('stop'))
                });
            });
        } catch (e) { console.error("EPG Error", e); }
        finally { document.getElementById('loading-msg').style.display = 'none'; }
    }

    function parseXMLTVDate(dateStr) {
        const y = dateStr.substring(0,4), m = dateStr.substring(4,6), d = dateStr.substring(6,8);
        const h = dateStr.substring(8,10), min = dateStr.substring(10,12), s = dateStr.substring(12,14);
        return new Date(`${y}-${m}-${d}T${h}:${min}:${s}`).getTime() / 1000;
    }

    function getCurrentProgram(channelId) {
        if (!EPG_DATA[channelId]) return null;
        const now = Date.now() / 1000;
        return EPG_DATA[channelId].find(p => p.start <= now && p.end > now);
    }

    // ================= NAVEGACIÓN =================
    function openFolder(title, items) {
        navigationStack.push({ title, items });
        renderGrid(items);
        updateHeader();
    }

    function goBack() {
        if (document.getElementById('epg-overlay').style.display === 'grid') { closeEPG(); return; }
        if (document.getElementById('catchup-sidebar').classList.contains('open')) { closeCatchupMenu(); return; }
        
        if (navigationStack.length > 1) {
            navigationStack.pop();
            renderGrid(navigationStack[navigationStack.length-1].items);
            updateHeader();
            return true;
        }
        return false;
    }

    function updateHeader() {
        const path = navigationStack.map(x => x.title).join(' / ');
        document.getElementById('breadcrumb').innerHTML = path;
        document.getElementById('btn-header-back').style.display = navigationStack.length > 1 ? 'block' : 'none';
    }

    function renderGrid(items) {
        document.getElementById('player-container').style.display = 'none'; // Ocultar player si salimos al menu
        const app = document.getElementById('app');
        app.style.display = 'block';
        app.innerHTML = '';
        const isMain = navigationStack.length === 1;
        const grid = document.createElement('div');
        grid.className = 'grid-view ' + (isMain ? 'main-menu' : '');

        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card focusable ' + (isMain ? 'main-card' : '');
            card.tabIndex = 0;
            card.onclick = () => handleItemClick(item);
            
            const img = (isMain && item.backdrop) ? item.backdrop : (item.poster || item.img || DEFAULT_IMG);
            const titleHtml = isMain ? `<div class="card-fallback-title" style="background:rgba(0,0,0,0.5); width:100%; bottom:0; top:auto;">${item.title}</div>` : `<div class="card-fallback-title">${item.title}</div>`;
            const iconHtml = (item.type==='folder' && !isMain) ? '<div class="folder-icon"><span class="material-icons-round">folder</span></div>' : '';

            card.innerHTML = `${titleHtml}<img src="${img}" onerror="this.style.display='none'">${iconHtml}`;
            grid.appendChild(card);
        });
        app.appendChild(grid);
        setTimeout(()=>document.querySelector('.card')?.focus(), 100);
    }

    async function handleItemClick(item) {
        if (item.type === 'folder') {
            if (item.children) { openFolder(item.title, item.children); return; }
            if (PROVIDERS_DATA[item.id]) { openFolder(item.title, PROVIDERS_DATA[item.id]); return; }
            
            if (item.url) {
                if (item.epg_url) loadEPG(item.epg_url); // Carga EPG en background
                
                document.getElementById('loading-msg').innerText = "Cargando Lista...";
                document.getElementById('loading-msg').style.display = 'block';
                const content = await fetchAndParseContent(item);
                document.getElementById('loading-msg').style.display = 'none';
                
                if(content.length) openFolder(item.title, content);
                else alert("Lista vacía");
                return;
            }
        }
        selectedItem = item;
        const isTV = navigationStack.some(x=>x.title==="TV EN VIVO");
        if(isTV) startPlayer(item, true); // Play directo
        else openDetails(item);
    }

    // ================= EPG OVERLAY =================
    function openEPG() {
        const overlay = document.getElementById('epg-overlay');
        const list = document.getElementById('epg-list');
        list.innerHTML = '';
        
        // Obtener canales de la carpeta actual
        const currentItems = navigationStack[navigationStack.length-1].items;
        
        currentItems.forEach(item => {
            if(item.type === 'stream') {
                const row = document.createElement('div');
                row.className = 'channel-row focusable';
                row.tabIndex = 0;
                
                const prog = getCurrentProgram(item.tvgId);
                const progTitle = prog ? prog.title : "Sin información";
                
                row.innerHTML = `
                    <img src="${item.poster || DEFAULT_IMG}" class="ch-logo"> 
                    <div class="ch-info">
                        <span style="font-weight:bold">${item.title}</span>
                        <span class="ch-now">${progTitle}</span>
                    </div>`;
                
                row.onclick = () => { 
                    selectedItem = item;
                    document.getElementById('epg-sel-title').innerText = item.title;
                    document.getElementById('epg-sel-desc').innerText = prog ? prog.desc : "No hay info.";
                    document.getElementById('epg-actions').style.display = 'block';
                };
                
                row.ondblclick = () => { closeEPG(); startPlayer(item, true); };
                list.appendChild(row);
            }
        });
        
        overlay.style.display = 'grid';
        setTimeout(()=>document.querySelector('.channel-row')?.focus(), 100);
    }

    function closeEPG() { document.getElementById('epg-overlay').style.display = 'none'; }
    function playSelectedFromEPG() { closeEPG(); startPlayer(selectedItem, true); }
    function openCatchupFromEPG() { closeEPG(); openCatchupMenu(); }

    // ================= CATCHUP =================
    function openCatchupMenu() {
        const sidebar = document.getElementById('catchup-sidebar');
        const list = document.getElementById('catchup-list');
        list.innerHTML = '';
        
        if (!selectedItem.catchupSource || !selectedItem.tvgId || !EPG_DATA[selectedItem.tvgId]) {
            list.innerHTML = '<div style="padding:20px; color:#777">No disponible.</div>';
        } else {
            const programs = EPG_DATA[selectedItem.tvgId];
            const now = Date.now() / 1000;
            const pastPrograms = programs.filter(p => p.end < now && p.start > (now - 604800)).reverse();
            
            pastPrograms.forEach(p => {
                const date = new Date(p.start * 1000);
                const item = document.createElement('div');
                item.className = 'cu-item focusable';
                item.tabIndex = 0;
                item.onclick = () => playCatchupStream(p.start, p.end - p.start, p.title);
                item.innerHTML = `<div class="cu-time">${date.toLocaleTimeString([], {weekday:'short', hour:'2-digit', minute:'2-digit'})}</div><div class="cu-title">${p.title}</div>`;
                list.appendChild(item);
            });
        }
        sidebar.classList.add('open');
        setTimeout(()=>document.querySelector('.cu-item')?.focus(), 100);
    }

    function closeCatchupMenu() { document.getElementById('catchup-sidebar').classList.remove('open'); }

    function playCatchupStream(start, duration, title) {
        let url = selectedItem.catchupSource.replace(/{utc}|{start}/g, start).replace(/{duration}/g, duration).replace(/{lutc}|{timestamp}/g, Math.floor(Date.now()/1000));
        player.load(url).then(() => {
            document.getElementById('video').play();
            closeCatchupMenu();
            document.getElementById('p-title').innerText = title + " (Grabación)";
        }).catch(e => console.error(e));
    }

    // ================= REPRODUCTOR =================
    function initShaka() {
        shaka.polyfill.installAll();
        if(shaka.Player.isBrowserSupported()){
            const video = document.getElementById('video');
            player = new shaka.Player(video);
            // CONFIGURACIÓN OPTIMIZADA (MEMORIA BAJA)
            player.configure({ 
                preferredAudioLanguage: 'es',
                streaming: { bufferingGoal: 20, rebufferingGoal: 2, bufferBehind: 10, retryParameters: {maxAttempts:5} }
            });
        }
    }

    async function startPlayer(item, isLive) {
        document.getElementById('app').style.display = 'none';
        document.getElementById('main-header').style.display = 'none';
        document.getElementById('details-view').style.display = 'none';
        document.getElementById('player-container').style.display = 'block';
        
        document.getElementById('p-title').innerText = item.title;
        document.getElementById('btn-catchup').style.display = (isLive && item.catchupSource) ? 'flex' : 'none';
        
        if (isLive && item.tvgId) {
            const prog = getCurrentProgram(item.tvgId);
            document.getElementById('p-program').innerText = prog ? prog.title : "";
        }

        isPlaying = true;
        resetUiTimer();

        try {
            const url = item.source?.url || item.mpd;
            if(item.source?.drm?.clearKeys) player.configure({ drm: { clearKeys: item.source.drm.clearKeys } });
            else player.configure({ drm: {} });
            
            await player.load(url);
            document.getElementById('video').play();
        } catch(e) {
            console.error(e);
            closePlayer();
        }
    }

    function togglePlay() { const v = document.getElementById('video'); if(v.paused) v.play(); else v.pause(); }

    function closePlayer() {
        player.unload();
        document.getElementById('player-container').style.display = 'none';
        isPlaying = false;
        
        if(document.getElementById('details-view').style.display === 'block') { /* VOD */ }
        else {
            document.getElementById('app').style.display = 'block';
            document.getElementById('main-header').style.display = 'flex';
            setTimeout(()=>document.querySelector('.card')?.focus(), 100);
        }
    }

    // ================= PARSERS =================
    async function fetchAndParseContent(provider) {
        try {
            const resp = await fetch(provider.url);
            const text = await resp.text();
            if(text.trim().startsWith('[')) return JSON.parse(text).map(processItem);

            const lines = text.split('\n');
            const groups = {}; const root = [];
            let curr = null;

            for(let line of lines) {
                line = line.trim();
                if(line.startsWith('#EXTINF')) {
                    curr = { type: 'stream', drm: {} };
                    const parts = line.split(',');
                    curr.title = parts[parts.length-1].trim();
                    const logo = line.match(/tvg-logo="([^"]+)"/);
                    if(logo) curr.poster = logo[1];
                    const grp = line.match(/group-title="([^"]+)"/);
                    curr.group = grp ? grp[1].replace('IZZI-','') : 'General';
                    const tvgid = line.match(/tvg-id="([^"]+)"/);
                    if(tvgid) curr.tvgId = tvgid[1];
                    const catchSrc = line.match(/catchup-source="([^"]+)"/);
                    if(catchSrc) curr.catchupSource = catchSrc[1];

                } else if(line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                    if(curr) {
                        const keys = line.split('=')[1].split(',');
                        const ck = {};
                        keys.forEach(k=>{ const[id,v]=k.split(':'); if(id&&v) ck[id]=v; });
                        curr.drm.clearKeys = ck;
                    }
                } else if(line.startsWith('http')) {
                    if(curr) {
                        curr.mpd = line.split('|')[0].split('?')[0]; 
                        if(curr.group) {
                            if(!groups[curr.group]) groups[curr.group] = [];
                            groups[curr.group].push(curr);
                        } else root.push(curr);
                        curr = null;
                    }
                }
            }
            const struct = [];
            for(const [k,v] of Object.entries(groups)) struct.push({title:k, type:'folder', children:v, img:v[0].poster});
            return [...struct, ...root];
        } catch(e){ console.error(e); return []; }
    }

    function processItem(item) {
        return {
            title: item.title || item.titulo,
            poster: item.images?.poster || item.poster || item.img,
            backdrop: item.images?.backdrop || item.backdrop,
            mpd: item.source?.url || item.mpd,
            drm: item.source?.drm || item.drm,
            type: 'stream'
        };
    }

    // ================= DETALLES & INPUTS =================
    function openDetails(item) {
        document.getElementById('det-title').innerText = item.title;
        document.getElementById('det-hero').style.backgroundImage = `url('${item.poster || DEFAULT_IMG}')`;
        document.getElementById('details-view').style.display = 'block';
        document.getElementById('app').style.display = 'none';
        document.getElementById('main-header').style.display = 'none';
        document.getElementById('btn-play-hero').onclick = () => startPlayer(item, false);
        setTimeout(()=>document.getElementById('btn-play-hero').focus(), 100);
    }
    
    function closeDetails() {
        document.getElementById('details-view').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('main-header').style.display = 'flex';
    }

    function resetUiTimer() {
        const ui = document.querySelector('.player-ui');
        ui.classList.remove('ui-hidden');
        clearTimeout(uiTimer);
        uiTimer = setTimeout(()=>ui.classList.add('ui-hidden'), 4000);
    }
    document.getElementById('player-container').addEventListener('mousemove', resetUiTimer);
    document.getElementById('player-container').addEventListener('keydown', resetUiTimer);

    window.addEventListener('keydown', (e) => {
        const k = e.keyCode;
        if(k === 71 && !isPlaying) { openEPG(); return; } // G for Guide

        if([8, 27, 461, 10009].includes(k)) {
            e.preventDefault();
            if(isPlaying) { closePlayer(); return; }
            if(document.getElementById('epg-overlay').style.display === 'grid') { closeEPG(); return; }
            if(document.getElementById('catchup-sidebar').classList.contains('open')) { closeCatchupMenu(); return; }
            goBack();
        }
        
        if(k === 13 || k === 23) { document.activeElement?.click(); }
        
        if([37,38,39,40].includes(k)) {
            if(isPlaying) {
                if(k === 39) openCatchupMenu(); 
                if(k === 38) openEPG();
                return;
            }
            const items = Array.from(document.querySelectorAll('.focusable'));
            const idx = items.indexOf(document.activeElement);
            if(idx === -1) { items[0]?.focus(); return; }
            
            let next = idx;
            if(k===39) next++; 
            if(k===37) next--;
            if(k===40) next+=5; 
            if(k===38) next-=5;
            
            if(next >= 0 && next < items.length) items[next].focus();
        }
    });
</script>
</body>
</html>
