<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamNet - Diseño Original + Mejoras</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS GENERALES --- */
        :root { --primary: #E50914; --bg: #141414; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Roboto', sans-serif; overflow-x: hidden; user-select: none; }
        
        /* FOCO TV */
        .focusable:focus {
            outline: none; border: 3px solid white; transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0,0,0,0.8); z-index: 100;
            background-color: rgba(255,255,255,0.1);
        }

        /* HEADER */
        header { position: fixed; top: 0; width: 100%; height: 60px; z-index: 1000; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent); display: flex; align-items: center; justify-content: space-between; padding: 0 4%; box-sizing: border-box; }
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .logo { color: var(--primary); font-size: 24px; font-weight: 900; text-decoration: none; margin-right: 10px; text-shadow: 2px 2px 4px black; }
        .nav-btn { background: transparent; border: none; color: #ccc; font-size: 14px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .nav-btn.active { color: white; font-size: 15px; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .search-box { display: flex; align-items: center; background: rgba(0,0,0,0.5); border: 1px solid #333; padding: 5px 10px; border-radius: 4px; }
        .search-box input { background: transparent; border: none; color: white; outline: none; width: 120px; font-size: 14px; }

        /* CONTENEDOR PRINCIPAL */
        #app { padding-top: 80px; min-height: 100vh; padding-bottom: 50px; }
        
        /* ESTILOS HOME (HORIZONTAL) - RESTAURADOS */
        .section-title { margin-left: 4%; font-size: 1.3rem; color: #e5e5e5; margin-bottom: 10px; margin-top: 20px; text-shadow: 1px 1px 2px black; font-weight: bold;}
        .horizontal-scroll { display: flex; gap: 10px; overflow-x: auto; padding: 10px 4%; scroll-behavior: smooth; }
        .horizontal-scroll::-webkit-scrollbar { height: 0px; } /* Ocultar scrollbar */
        
        /* ESTILOS GRID (SECCIONES) */
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 20px 4%; }
        
        /* TARJETAS */
        .card { 
            min-width: 140px; height: 210px; /* Tamaño fijo para scroll horizontal */
            background: #222; border-radius: 6px; cursor: pointer; position: relative; overflow: hidden; 
            transition: transform 0.2s; border: 3px solid transparent; 
            display: flex; align-items: center; justify-content: center;
        }
        .card img { width: 100%; height: 100%; object-fit: cover; background: #333; }
        
        /* Barra de progreso en la tarjeta */
        .progress-track { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background: rgba(255,255,255,0.3); z-index: 5; display: none; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; }

        /* --- NUEVA VISTA DE DETALLES (PANTALLA COMPLETA) --- */
        #details-view {
            position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; overflow-y: auto;
        }
        .details-hero {
            width: 100%; height: 65vh; background-size: cover; background-position: center top; position: relative;
        }
        .hero-gradient {
            position: absolute; inset: 0;
            background: linear-gradient(to top, var(--bg) 5%, rgba(20,20,20,0.8) 20%, transparent 100%),
                        linear-gradient(to right, var(--bg) 0%, rgba(20,20,20,0.6) 40%, transparent 80%);
        }
        .details-content { position: absolute; bottom: 20px; left: 4%; max-width: 700px; padding-right: 4%; }
        .details-title { font-size: 3rem; font-weight: 900; margin-bottom: 10px; text-shadow: 2px 2px 10px black; line-height: 1; }
        .details-meta { color: #ccc; font-weight: bold; font-size: 1.1rem; margin-bottom: 15px; }
        .details-desc { font-size: 1.1rem; line-height: 1.4; color: #ddd; margin-bottom: 25px; text-shadow: 1px 1px 2px black; max-width: 600px; }
        
        .btn-large {
            padding: 12px 30px; font-size: 1.2rem; font-weight: bold; border-radius: 4px; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; margin-right: 15px;
        }
        .btn-primary { background: white; color: black; border: 3px solid transparent; }
        .btn-secondary { background: rgba(109, 109, 110, 0.7); color: white; border: 3px solid transparent; }
        .action-row { display: flex; margin-bottom: 30px; }

        /* EPISODIOS EN PANTALLA COMPLETA */
        #series-container { padding: 0 4% 50px 4%; display: none; position: relative; top: -20px; }
        .season-selector { padding: 10px; background: #333; color: white; border: 2px solid #555; font-size: 1rem; border-radius: 4px; margin-bottom: 20px; }
        .episode-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #333; cursor: pointer; border: 3px solid transparent; border-radius: 6px; gap: 15px; }
        .episode-item:hover { background: #333; }
        .ep-thumb { width: 140px; height: 80px; object-fit: cover; border-radius: 4px; background: #222; }

        /* REPRODUCTOR */
        #player-container { position: fixed; inset: 0; background: black; z-index: 5000; display: none; }
        #video { width: 100%; height: 100%; }
        .player-ui-layer { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 30px; }
        .btn-back-player { pointer-events: auto; background: rgba(0,0,0,0.5); color: white; border: 3px solid transparent; border-radius: 50%; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .player-info { margin-left: 20px; text-shadow: 2px 2px 4px black; }
        .player-top { display: flex; align-items: center; }
        .fade-out { opacity: 0; transition: opacity 0.5s; }
        
        /* ERROR TOAST */
        .error-msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(50,0,0,0.95); padding: 30px; border-radius: 8px; text-align: center; z-index: 6000; display: none; border: 1px solid #555; box-shadow: 0 0 20px black; }

    </style>
</head>
<body>

    <header id="main-header">
        <div class="nav-left">
            <a href="#" class="logo">STREAMNET</a>
            <button class="nav-btn focusable active" onclick="loadView('home')">Inicio</button>
            <button class="nav-btn focusable" onclick="loadView('series')">Series</button>
            <button class="nav-btn focusable" onclick="loadView('movies')">Películas</button>
        </div>
        <div class="search-box">
            <span class="material-icons-round">search</span>
            <input type="text" id="search" class="focusable" placeholder="Buscar...">
        </div>
    </header>

    <div id="app">
        <h2 style="text-align:center; margin-top:100px; color:#777;" id="loading-msg">Cargando catálogo...</h2>
    </div>

    <div id="details-view">
        <div class="details-hero" id="det-hero">
            <div class="hero-gradient"></div>
            <div class="details-content">
                <h1 class="details-title" id="det-title">TITULO</h1>
                <div class="details-meta" id="det-meta">METADATA</div>
                <p class="details-desc" id="det-desc">Descripción...</p>
                
                <div class="action-row">
                    <button id="btn-play-hero" class="btn-large btn-primary focusable">
                        <span class="material-icons-round">play_arrow</span> Reproducir
                    </button>
                    <button id="btn-back-details" class="btn-large btn-secondary focusable" onclick="closeDetails()">
                        <span class="material-icons-round">arrow_back</span> Volver
                    </button>
                </div>
            </div>
        </div>

        <div id="series-container">
            <h3 class="section-title">Episodios</h3>
            <select id="season-select" class="season-selector focusable"></select>
            <div id="episodes-list"></div>
        </div>
    </div>

    <div id="player-container">
        <video id="video" autoplay></video>
        <div id="player-ui" class="player-ui-layer">
            <div class="player-top">
                <button class="btn-back-player focusable" onclick="exitPlayer()">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <div class="player-info">
                    <h2 id="p-title" style="margin:0">Titulo</h2>
                    <span id="p-sub" style="color:#ccc"></span>
                </div>
            </div>
        </div>
    </div>

    <div id="error-toast" class="error-msg">
        <h3 style="margin-top:0; color:#ff5555">Error de Reproducción</h3>
        <p id="error-text" style="color:#ddd; margin-bottom:20px;"></p>
        <button class="btn-primary focusable" style="padding:10px 20px; border-radius:4px; border:none;" onclick="document.getElementById('error-toast').style.display='none'; exitPlayer()">Cerrar</button>
    </div>

    <script>
        const DEFAULT_IMG = "https://via.placeholder.com/300x450/333333/FFFFFF?text=Sin+Imagen";
        let catalog = [];
        let currentView = 'home'; 
        let currentItem = null;
        let player = null;
        let uiTimer;
        
        // Variables series
        let currentSeasonIdx = 0;
        let currentEpIdx = 0;

        // TECLAS
        const KEYS = { BACK: 8, BACK_WEBOS: 461, BACK_TIZEN: 10009, ENTER: 13, LEFT: 37, UP: 38, RIGHT: 39, DOWN: 40, ESC: 27 };

        window.onload = async () => {
            initShaka();
            document.addEventListener('keydown', handleRemote);
            await loadData();
        };

        // --- SISTEMA DE ATRÁS ARREGLADO ---
        function handleRemote(e) {
            const k = e.keyCode;
            
            // Si es un botón de volver
            if (k === KEYS.BACK || k === KEYS.BACK_TIZEN || k === KEYS.BACK_WEBOS || k === KEYS.ESC) {
                e.preventDefault(); 
                if (document.getElementById('error-toast').style.display === 'block') {
                    document.getElementById('error-toast').style.display = 'none';
                    exitPlayer();
                } else if (currentView === 'player') {
                    exitPlayer(); // De video a detalles
                } else if (currentView === 'details') {
                    closeDetails(); // De detalles a home
                } else {
                    console.log("Ya estás en home"); // Aquí podrías poner un confirm de salir
                }
                return;
            }

            // Navegación
            if([KEYS.UP, KEYS.DOWN, KEYS.LEFT, KEYS.RIGHT].includes(k)) {
                e.preventDefault();
                moveFocus(k);
            }
            if(k === KEYS.ENTER && document.activeElement) {
                document.activeElement.click();
            }
        }

        function moveFocus(dir) {
            const focusables = Array.from(document.querySelectorAll('.focusable'))
                .filter(el => el.offsetParent !== null);
            
            if (focusables.length === 0) return;

            const current = document.activeElement;
            const idx = focusables.indexOf(current);
            
            if (idx === -1) { focusables[0].focus(); return; }

            // Lógica simple para moverse al siguiente elemento visible
            // En Grid y Flex nativos, el navegador hace un buen trabajo si se usan flechas,
            // pero esto fuerza el foco si el navegador falla.
            let next = null;
            
            // Nota: Para una navegación 100% perfecta en grillas complejas se requiere cálculo geométrico.
            // Para simplificar y que funcione el scroll horizontal nativo:
            if(dir === KEYS.RIGHT && idx < focusables.length - 1) next = focusables[idx + 1];
            if(dir === KEYS.LEFT && idx > 0) next = focusables[idx - 1];
            
            // Para arriba y abajo en listas largas, intentamos saltar filas (aprox 5 items)
            if(dir === KEYS.DOWN) {
                let target = Math.min(idx + 1, focusables.length - 1);
                // Si es grid view, saltar más
                if(current.closest('.grid-view')) target = Math.min(idx + 5, focusables.length - 1);
                next = focusables[target];
            }
            if(dir === KEYS.UP) {
                let target = Math.max(idx - 1, 0);
                if(current.closest('.grid-view')) target = Math.max(idx - 5, 0);
                next = focusables[target];
            }

            if(next) {
                next.focus();
                next.scrollIntoView({behavior: 'smooth', block: 'center', inline: 'center'});
            }
        }

        // --- CARGA DATOS ---
        async function loadData() {
            try {
                // TUS ENLACES DE DROPBOX
                const [r1, r2] = await Promise.all([
                    fetch('https://dl.dropboxusercontent.com/s/2hv588f06l7y265fx12ti/peliculas.json?rlkey=w2ob1lmu9clymri00puohuhbd&dl=0'),
                    fetch('https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=0')
                ]);
                const d1 = await r1.json();
                const d2 = await r2.json();
                
                catalog = [...d1, ...d2].map(normalizeItem);
                document.getElementById('loading-msg').style.display = 'none';
                loadView('home');

            } catch(e) {
                document.getElementById('loading-msg').innerText = "Error cargando datos: " + e.message;
            }
        }

        function normalizeItem(i) {
            let type = 'movie';
            if(i.tipo && i.tipo.toLowerCase().includes('serie')) type = 'series';
            
            let img = i.poster || i.img || DEFAULT_IMG;
            let seasons = [];
            if(i.estaciones) {
                seasons = i.estaciones.map(s => ({ num: s.número||s.number, episodes: s.episodios||s.episodes }));
                if(!img && seasons[0]?.episodes[0]?.img) img = seasons[0].episodes[0].img;
            }

            return {
                id: i.id, title: i.titulo || i.title || i.id, desc: i.sinopsis || "...",
                poster: img, hero: img, type: type, year: i.year || '',
                mpd: i.mpd, drm: i.drm, seasons: seasons
            };
        }

        // --- VISTAS ---
        function loadView(view) {
            currentView = view === 'player' ? 'player' : (view === 'details' ? 'details' : 'home');
            const app = document.getElementById('app');
            app.innerHTML = '';
            
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            if(view === 'home') {
                // DISEÑO ORIGINAL: Filas Horizontales
                document.querySelectorAll('.nav-btn')[0].classList.add('active');
                
                const watching = catalog.filter(x => { const p = getProgress(x.id); return p.pct > 1 && p.pct < 95; });
                if(watching.length > 0) createRow("Continuar Viendo", watching);
                
                createRow("Series", catalog.filter(x => x.type === 'series'));
                createRow("Películas", catalog.filter(x => x.type === 'movie'));
                
            } else if(view === 'series') {
                document.querySelectorAll('.nav-btn')[1].classList.add('active');
                createGrid(catalog.filter(x => x.type === 'series'));
            } else if(view === 'movies') {
                document.querySelectorAll('.nav-btn')[2].classList.add('active');
                createGrid(catalog.filter(x => x.type === 'movie'));
            }
            
            // Foco inicial
            setTimeout(() => { document.querySelector('.card')?.focus(); }, 100);
        }

        function createRow(title, items) {
            if(items.length === 0) return;
            const html = `
                <div style="margin-bottom:20px;">
                    <h3 class="section-title">${title}</h3>
                    <div class="horizontal-scroll">
                        ${items.map(item => getCardHTML(item)).join('')}
                    </div>
                </div>
            `;
            document.getElementById('app').insertAdjacentHTML('beforeend', html);
        }

        function createGrid(items) {
            const html = `<div class="grid-view">${items.map(item => getCardHTML(item)).join('')}</div>`;
            document.getElementById('app').innerHTML = html;
        }

        function getCardHTML(item) {
            const p = getProgress(item.id);
            const bar = p.pct > 0 ? `<div class="progress-track" style="display:block"><div class="progress-fill" style="width:${p.pct}%"></div></div>` : '';
            // Importante: onclick llama a openDetails ahora
            return `<div class="card focusable" tabindex="0" onclick="openDetails('${item.id}')">
                        <img src="${item.poster}" loading="lazy" onerror="this.src='${DEFAULT_IMG}'">
                        ${bar}
                    </div>`;
        }

        // --- DETALLES (FULL SCREEN) ---
        function openDetails(id) {
            const item = catalog.find(x => x.id === id);
            if(!item) return;
            currentItem = item;
            currentView = 'details';

            document.getElementById('app').style.display = 'none';
            document.getElementById('main-header').style.display = 'none'; // Ocultar header en detalles
            const det = document.getElementById('details-view');
            det.style.display = 'block';
            det.scrollTop = 0;

            document.getElementById('det-hero').style.backgroundImage = `url('${item.hero}')`;
            document.getElementById('det-title').innerText = item.title;
            document.getElementById('det-meta').innerText = `${item.year} | ${item.type==='series'?'Serie':'Película'}`;
            document.getElementById('det-desc').innerText = item.desc;

            const btnPlay = document.getElementById('btn-play-hero');
            const seriesC = document.getElementById('series-container');

            if(item.type === 'series') {
                btnPlay.innerText = "Reproducir T1 E1";
                btnPlay.onclick = () => playEpisode(0,0);
                seriesC.style.display = 'block';
                renderSeasons(item);
            } else {
                btnPlay.innerHTML = '<span class="material-icons-round">play_arrow</span> Reproducir';
                const p = getProgress(item.id);
                if(p.pct > 1 && p.pct < 98) btnPlay.innerHTML += " (Reanudar)";
                btnPlay.onclick = () => startPlayer(item.mpd, item.drm, item.title);
                seriesC.style.display = 'none';
            }
            
            setTimeout(() => btnPlay.focus(), 100);
        }

        function closeDetails() {
            currentView = 'home'; // O la vista que tuviera antes
            document.getElementById('details-view').style.display = 'none';
            document.getElementById('app').style.display = 'block';
            document.getElementById('main-header').style.display = 'flex';
            // Enfocar la tarjeta del item actual
            /* (Lógica simple: enfocar primera carta visible) */
            setTimeout(() => document.querySelector('.card')?.focus(), 100);
        }

        function renderSeasons(item) {
            const sel = document.getElementById('season-select');
            sel.innerHTML = '';
            if(!item.seasons.length) return;
            item.seasons.forEach((s, idx) => {
                sel.innerHTML += `<option value="${idx}">Temporada ${s.num}</option>`;
            });
            sel.onchange = () => renderEpisodes(item, sel.value);
            sel.value = 0;
            renderEpisodes(item, 0);
        }

        function renderEpisodes(item, sIdx) {
            const list = document.getElementById('episodes-list');
            list.innerHTML = '';
            const s = item.seasons[sIdx];
            if(!s) return;
            s.episodes.forEach((ep, idx) => {
                const row = document.createElement('div');
                row.className = 'episode-item focusable';
                row.tabIndex = 0;
                row.innerHTML = `<span style="font-size:1.5rem; color:#777; font-weight:bold">${idx+1}</span>
                                 <img src="${ep.img||item.poster}" class="ep-thumb" onerror="this.src='${DEFAULT_IMG}'">
                                 <div><h4 style="margin:0">${ep.title||'Episodio '+(idx+1)}</h4><small style="color:#aaa">${ep.duration||''}</small></div>`;
                row.onclick = () => playEpisode(sIdx, idx);
                list.appendChild(row);
            });
        }

        // --- PLAYER ---
        function initShaka() {
            shaka.polyfill.installAll();
            if(shaka.Player.isBrowserSupported()) {
                player = new shaka.Player(document.getElementById('video'));
                player.addEventListener('error', onError);
                const vid = document.getElementById('video');
                vid.addEventListener('timeupdate', () => {
                    if(!vid.paused && currentItem && currentItem.type === 'movie') saveProgress(currentItem.id, vid.currentTime, vid.duration);
                });
                vid.addEventListener('play', resetUiTimer);
                vid.addEventListener('pause', () => clearTimeout(uiTimer));
                document.getElementById('player-container').addEventListener('mousemove', resetUiTimer);
                document.getElementById('player-container').addEventListener('keydown', resetUiTimer);
            }
        }

        async function startPlayer(mpd, drm, title) {
            if(!mpd) return showToast("No hay URL de video disponible.");
            if(window.location.protocol === 'file:') return showToast("ERROR (Shaka 7000): No se puede reproducir desde 'file://'. Usa un servidor local o GitHub Pages.");

            document.getElementById('player-container').style.display = 'block';
            document.getElementById('p-title').innerText = title;
            currentView = 'player';

            let config = {};
            if(drm && drm.clearKeys) config.drm = { clearKeys: drm.clearKeys };
            player.configure(config);

            try {
                await player.load(mpd);
                const vid = document.getElementById('video');
                if(currentItem.type === 'movie') {
                    const saved = getProgress(currentItem.id);
                    if(saved.pct > 1 && saved.pct < 98) vid.currentTime = saved.time;
                }
                vid.play();
                resetUiTimer();
            } catch(e) { onError(e); }
        }

        async function playEpisode(sIdx, eIdx) {
            currentSeasonIdx = parseInt(sIdx);
            currentEpIdx = parseInt(eIdx);
            const ep = currentItem.seasons[currentSeasonIdx].episodes[currentEpIdx];
            if(ep) startPlayer(ep.mpd, ep.drm, `${currentItem.title} - T${currentItem.seasons[currentSeasonIdx].num} E${currentEpIdx+1}`);
        }

        function exitPlayer() {
            player.unload();
            document.getElementById('player-container').style.display = 'none';
            // Volver a detalles
            currentView = 'details';
            document.getElementById('btn-play-hero').focus();
        }

        function onError(e) {
            const err = e.detail || e;
            console.error(err);
            let msg = "Error desconocido.";
            if(err.code === 7000) msg = "Error de Red (CORS) o Enlace Roto. Si estás en PC abriendo el archivo HTML directamente, esto fallará. Súbelo a un servidor.";
            if(err.code === 6007) msg = "Error de Licencia DRM.";
            showToast(msg);
        }

        function showToast(msg) {
            const t = document.getElementById('error-toast');
            document.getElementById('error-text').innerText = msg;
            t.style.display = 'block';
            t.querySelector('button').focus();
        }

        function resetUiTimer() {
            const ui = document.getElementById('player-ui');
            ui.classList.remove('fade-out');
            clearTimeout(uiTimer);
            if(!document.getElementById('video').paused) {
                uiTimer = setTimeout(() => ui.classList.add('fade-out'), 3000);
            }
        }

        // Helpers
        function saveProgress(id, time, dur) { localStorage.setItem('prog_'+id, JSON.stringify({time, pct:(time/dur)*100})); }
        function getProgress(id) { const d = localStorage.getItem('prog_'+id); return d ? JSON.parse(d) : {time:0, pct:0}; }

    </script>
</body>
</html>