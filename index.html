<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1" name="viewport">
    <meta content="no-referrer" name="referrer">
    <title>Tizen IPTV Player</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.11.2/controls.min.css" rel="stylesheet">
    <link href="https://dbghelp.github.io/xml-epg.css" rel="stylesheet">
    
    <style>
        body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; background-color: #282c34; overflow: hidden; }
        
        /* Playlist Styles */
        #playlist { width: 350px; background-color: #282c34; color: #fff; overflow-y: auto; border-right: 1px solid #444; padding: 20px; box-shadow: 2px 0 5px rgb(0 0 0 / .2); display: flex; flex-direction: column; }
        
        /* Ocultamos inputs que no son fáciles de usar en TV, pero los dejamos en el DOM por si acaso */
        .input-container, #search-input, #fetch-button, #epg-button { display: none !important; }

        /* Video Area */
        #video-container { flex: 1; display: flex; flex-direction: column; z-index: 2; position: relative;}
        #video { flex: 1; width: 100%; height: 100%; background-color: #000; }
        
        /* Lista de Canales */
        #video-list { list-style: none; padding: 0; margin: 0; }
        #video-list li { 
            padding: 10px; margin: 5px 0; border-radius: 5px; 
            border: 2px solid transparent; /* Borde invisible para evitar saltos al enfocar */
            display: flex; align-items: center; 
            transition: all 0.2s ease;
        }
        
        #video-list img { width: 50px; height: 50px; margin-right: 10px; border-radius: 5px; object-fit: contain; }
        .video-title { font-size: 1.1em; }

        /* ESTADOS ACTIVOS Y DE FOCO PARA TV (MUY IMPORTANTE) */
        #video-list li.active { background-color: #4fa3c4; color: white; }
        
        /* Cuando seleccionas con el mando */
        #video-list li:focus { 
            background-color: #61dafb; 
            transform: scale(1.02); 
            border: 2px solid white; 
            outline: none;
            color: black;
        }

        /* Overlays */
        #overlay { display: none; flex-direction: column; align-items: center; overflow-y: auto; z-index: 2; flex: 1; padding: 20px; color: white; background: rgba(0,0,0,0.9); position: absolute; top:0; left:0; right:0; bottom:0;}
        #epg-container { display: none; z-index: 1000; position: fixed; width: 100%; height: 100%; overflow-y: scroll; background-color: #282c34; }

        /* Toast Message */
        .toast-container { position: absolute; top: 20px; right: 20px; z-index: 9999; pointer-events: none;}
        .toast { background-color: #333; color: #fff; padding: 10px 20px; border-radius: 5px; margin-bottom: 10px; font-size: 16px; box-shadow: 0 4px 6px rgb(0 0 0 / .1); opacity: 0; animation: fadeIn 0.5s forwards, fadeOut 3s forwards 2s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
    </style>
</head>
<body>

    <div id="playlist">
        <div class="input-container">
            <input id="url-input">
            <input id="file-input" type="file">
            <button id="upload-button">↑</button>
        </div>
        <button id="fetch-button">Load</button>
        <button id="epg-button" onclick="openEPG()">EPG</button>
        <input id="search-input">
        
        <h3 style="margin-top:0">Canales</h3>
        <ul id="video-list"></ul>
    </div>

    <div id="video-container">
        <video autoplay controls id="video"></video>
        <div id="overlay">
            <h2>Información del Programa</h2>
            <div id="overlay-content"></div>
        </div>
    </div>

    <div id="epg-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.11/shaka-player.compiled.js"></script>
    <script src="https://dbghelp.github.io/M3U8Interpreter.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.0.4/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://dbghelp.github.io/xml-epg.js"></script>

    <script>
        // --- CONFIGURACIÓN TIZEN ---
        var xmlepg = new XMLEPG();
        var overlay = document.getElementById('overlay');
        var videoContainer = document.getElementById('video-container');
        var epgContainer = document.getElementById('epg-container');
        var videoElement = document.getElementById('video');
        var videoList = document.getElementById('video-list');
        var player;
        var channels;

        // Códigos de tecla Tizen Samsung
        const KEY = {
            LEFT: 37, UP: 38, RIGHT: 39, DOWN: 40,
            ENTER: 13, RETURN: 10009,
            PLAY: 415, PAUSE: 19, PLAY_PAUSE: 10252
        };

        document.addEventListener('DOMContentLoaded', () => {
            player = new shaka.Player(videoElement);
            shaka.polyfill.installAll();

            // URL Hardcoded (Dropbox)
            const m3u8Link = 'https://dl.dropboxusercontent.com/s/5wcyoevb2z4wf7qo82nlv/TVU.m3u?rlkey=mkxpksws68zbrix9qisj4e7vp';
            setPlaylistFromUrl(m3u8Link);

            // Manejador de Errores de Shaka
            player.addEventListener('error', (event) => {
                console.error('Error code', event.detail.code, 'object', event.detail);
            });
        });

        // --- LÓGICA DE NAVEGACIÓN TIZEN ---
        document.addEventListener('keydown', function(e) {
            const active = document.activeElement;
            
            switch(e.keyCode) {
                case KEY.DOWN:
                    if (active.tagName === 'LI' && active.nextElementSibling) {
                        active.nextElementSibling.focus();
                        active.nextElementSibling.scrollIntoView({block: "center"});
                    }
                    break;
                    
                case KEY.UP:
                    if (active.tagName === 'LI' && active.previousElementSibling) {
                        active.previousElementSibling.focus();
                        active.previousElementSibling.scrollIntoView({block: "center"});
                    }
                    break;

                case KEY.ENTER:
                    if (active.tagName === 'LI') {
                        active.click(); // Dispara la carga del video
                    }
                    break;
                
                case KEY.RIGHT:
                    // Usar FLECHA DERECHA para ver info (Overlay) si hay EPG
                    if (active.tagName === 'LI') {
                        const channelData = channels.find(c => c.channelName === active.textContent.trim());
                        if(channelData) {
                             showOverlayInfo(channelData.tvgId);
                        }
                    }
                    break;

                case KEY.LEFT:
                case KEY.RETURN:
                    // Cerrar Overlay o Salir
                    if (overlay.style.display === 'flex') {
                        overlay.style.display = 'none';
                        videoContainer.querySelector('video').style.display = 'block';
                    } else if (epgContainer.style.display === 'block') {
                        epgContainer.style.display = 'none';
                    } else {
                        // Salir de la app (requiere privilegios Tizen, si falla no hace nada)
                        try { tizen.application.getCurrentApplication().exit(); } catch (err) { console.log("Back pressed"); }
                    }
                    break;
            }
        });

        // --- FUNCIONES CORE ---

        async function setPlaylistFromUrl(url) {
            try {
                const response = await fetch(url);
                if (response.ok) {
                    const text = await response.text();
                    parseAndSetPlaylist(text);
                } else {
                    showToast('Error cargando lista');
                }
            } catch (error) {
                console.error('Error fetching playlist:', error);
            }
        }

        async function parseAndSetPlaylist(content) {
            const m3u8Interpreter = new M3U8Interpreter(content);
            m3u8Interpreter.parse();
            channels = m3u8Interpreter.getChannels();
            const urls = m3u8Interpreter.getUrlTvg();
            
            xmlepg.setPlaylistChannels(channels);
            if(urls) {
                xmlepg.load(urls).then(() => {
                    xmlepg.displayAllPrograms('epg-container', 'xmlepg');
                });
            }

            updatePlaylist(channels);
        }

        function updatePlaylist(channels) {
            videoList.innerHTML = '';
            channels.forEach((channel, index) => {
                const listItem = document.createElement('li');
                // tabindex="0" hace que el elemento sea "enfocable" por la TV
                listItem.setAttribute('tabindex', '0'); 
                
                listItem.innerHTML = `
                    <img src="${channel.tvgLogo || 'data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs='}" alt="Logo" onerror="this.style.display='none'">
                    <span class="video-title">${channel.channelName}</span>
                `;

                // Evento Click (Enter en el mando)
                listItem.onclick = () => {
                    loadVideo(channel.manifestUrl, channel.licenseKey);
                    
                    // Gestionar clase visual 'active'
                    const allItems = videoList.querySelectorAll('li');
                    allItems.forEach(i => i.classList.remove('active'));
                    listItem.classList.add('active');
                };

                videoList.appendChild(listItem);
            });

            // Enfocar el primer elemento automáticamente después de cargar
            setTimeout(() => {
                const first = videoList.querySelector('li');
                if(first) first.focus();
            }, 500);
        }

        window.loadVideo = function(manifestUrl, licenseKey) {
            if (licenseKey != null && !Array.isArray(licenseKey)) {
                licenseKey = JSON.parse(decodeURIComponent(licenseKey));
            }
            if (licenseKey) {
                licenseKey.forEach(pair => {
                    player.configure({ drm: { clearKeys: { [pair.keyId]: pair.key } } });
                });
            } else {
                player.configure({ drm: { clearKeys: {} } }); // Limpiar claves anteriores
            }
            
            player.load(manifestUrl).then(() => {
                videoElement.play();
            }).catch(e => console.error('Error cargando video', e));
        };

        function showOverlayInfo(tvgId) {
            // Mostrar EPG en overlay
            xmlepg.displayPrograms('overlay', tvgId); 
            overlay.style.display = 'flex';
            // Ocultar video temporalmente si tapa el overlay (depende de layout, aqui lo dejamos de fondo)
            // videoElement.style.display = 'none'; 
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.classList.add('toast');
            toast.textContent = message;
            
            let container = document.querySelector('.toast-container');
            if (!container) {
                container = document.createElement('div');
                container.classList.add('toast-container');
                document.body.appendChild(container);
            }
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }
    </script>
</body>
</html>
