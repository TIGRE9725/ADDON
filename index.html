<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Launcher TV-PLUS</title>
    <style>
        /* --- ESTILOS GENERALES --- */
        :root {
            --bg-color: #1a1a1a;
            --card-bg: #2d2d2d;
            --text-color: #ffffff;
            --accent-color: #007bff;
            --hover-color: #3d3d3d;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        h1 {
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-size: 1.5rem;
        }

        /* --- ESTADO DE CARGA --- */
        #mensaje-estado {
            font-size: 1.2rem;
            color: #aaa;
            margin-top: 50px;
        }

        /* --- GRILLA RESPONSIVA --- */
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 20px;
            width: 100%;
            max-width: 1200px;
        }

        /* --- TARJETAS (RECT츼NGULOS) --- */
        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
            text-decoration: none;
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: transform 0.15s, background-color 0.15s, box-shadow 0.15s;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            aspect-ratio: 1 / 1;
            border: 3px solid transparent;
            outline: none; /* Quitamos el borde por defecto del navegador */
        }

        /* Efecto al pasar el mouse O al enfocar con el control remoto de TV */
        .card:hover, .card:focus {
            transform: translateY(-5px) scale(1.05);
            background-color: var(--hover-color);
            box-shadow: 0 10px 20px rgba(0,0,0,0.6);
            border-color: var(--accent-color);
            z-index: 10;
        }

        /* --- ICONOS Y TEXTO --- */
        .card-icon {
            font-size: 3rem;
            margin-bottom: 12px;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 70px;
        }
        
        .card-icon img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: bold;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2; /* M치ximo 2 l칤neas para que no rompa la tarjeta */
            -webkit-box-orient: vertical;
        }
    </style>
</head>
<body>

    <h1>TV-PLUS (Izzi)</h1>
    
    <div id="mensaje-estado">Descargando lista M3U desde Dropbox...</div>
    <div class="grid-container" id="app-grid"></div>

<script>
    // URL de tu lista M3U
    const URL_M3U = "https://dl.dropboxusercontent.com/s/xfnhw0dfk7hrdx0zphj3l/TV-PLUS.m3u?rlkey=iqzrr4s7bjo7jljw02gd42apt&dl=1";
    
    document.addEventListener('DOMContentLoaded', cargarListaM3U);

    async function cargarListaM3U() {
        const estado = document.getElementById('mensaje-estado');
        try {
            const respuesta = await fetch(URL_M3U);
            if (!respuesta.ok) throw new Error("No se pudo conectar a Dropbox");
            
            const textoM3U = await respuesta.text();
            estado.innerText = "Procesando llaves DRM...";
            
            const canales = parsearM3UIzzi(textoM3U);
            
            if (canales.length > 0) {
                estado.style.display = 'none';
                renderizarGrilla(canales);
            } else {
                estado.innerText = "La lista se descarg칩 pero no se encontraron canales compatibles.";
            }

        } catch (error) {
            console.error(error);
            estado.innerText = "Error cr칤tico al cargar la lista. Verifica tu conexi칩n o el enlace.";
        }
    }

    // --- EL CEREBRO EXTRACTOR DE LLAVES ---
    function parsearM3UIzzi(contenido) {
        const lineas = contenido.split('\n');
        const canales = [];
        let canalActual = {};

        for (let i = 0; i < lineas.length; i++) {
            let linea = lineas[i].trim();
            if (!linea) continue;

            if (linea.startsWith('#EXTINF')) {
                // Sacar nombre
                const partes = linea.split(',');
                canalActual.nombre = partes[partes.length - 1].trim();
                
                // Sacar Logo (si existe)
                const matchLogo = linea.match(/tvg-logo="([^"]+)"/);
                if (matchLogo && matchLogo[1]) {
                    canalActual.iconoHtml = `<img src="${matchLogo[1]}" loading="lazy">`;
                } else {
                    canalActual.iconoHtml = "游닠"; // Icono por defecto
                }
            } 
            // Cazar la llave ClearKey de Izzi
            else if (linea.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                const llaveSucia = linea.replace('#KODIPROP:inputstream.adaptive.license_key=', '');
                
                try {
                    // Formato JSON de tu lista Izzi {"keys":[{"kty":"oct","kid":"...","k":"..."}]}
                    const keyJson = JSON.parse(llaveSucia);
                    if (keyJson.keys && keyJson.keys.length > 0) {
                        // Agarramos el primer par de llaves
                        canalActual.kid = keyJson.keys[0].kid;
                        canalActual.key = keyJson.keys[0].k;
                    }
                } catch (e) {
                    // Por si alg칰n canal tiene el formato simple kid:k
                    const partesLlave = llaveSucia.split(':');
                    if (partesLlave.length === 2) {
                        canalActual.kid = partesLlave[0];
                        canalActual.key = partesLlave[1];
                    }
                }
            } 
            // Si la l칤nea no empieza con #, es la URL del MPD
            else if (!linea.startsWith('#')) {
                canalActual.mpd = linea;
                
                // Solo a침adimos el canal si tiene MPD y nombre
                if (canalActual.mpd && canalActual.nombre) {
                    canales.push(canalActual);
                }
                
                // Limpiamos la variable para el pr칩ximo canal
                canalActual = {};
            }
        }
        return canales;
    }

    // --- DIBUJAR LA INTERFAZ ---
    function renderizarGrilla(canales) {
        const gridContainer = document.getElementById('app-grid');
        gridContainer.innerHTML = ''; // Limpiar grilla

        canales.forEach((canal, index) => {
            const card = document.createElement('a');
            card.className = 'card';
            card.setAttribute('tabindex', '0'); // Hacerlo seleccionable por el control remoto
            if(index === 0) card.id = "first-item";

            // Armar la URL din치mica hacia tu reproductor.html con las llaves inyectadas
            let link = `reproductor.html?mpd=${encodeURIComponent(canal.mpd)}`;
            if (canal.kid && canal.key) {
                link += `&kid=${encodeURIComponent(canal.kid)}&key=${encodeURIComponent(canal.key)}`;
            }
            card.href = link;

            card.innerHTML = `
                <div class="card-icon">${canal.iconoHtml}</div>
                <div class="card-title">${canal.nombre}</div>
            `;

            // Navegaci칩n con control remoto (Enter = Click)
            card.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    window.location.href = card.href;
                }
            });

            gridContainer.appendChild(card);
        });

        // Enfocar el primer canal autom치ticamente al cargar
        setTimeout(() => {
            const first = document.getElementById('first-item');
            if(first) first.focus();
        }, 100);
    }

    // --- NAVEGACI칍N D-PAD B츼SICA PARA LA GRILLA ---
    document.addEventListener('keydown', (e) => {
        // Obtenemos todos los elementos con tabindex=0 (las tarjetas)
        const elementosFocusables = Array.from(document.querySelectorAll('.card'));
        if (elementosFocusables.length === 0) return;

        let currentIndex = elementosFocusables.indexOf(document.activeElement);

        // Si no hay nada enfocado, enfocar el primero y salir
        if (currentIndex === -1) {
            elementosFocusables[0].focus();
            return;
        }

        // Calcular cu치ntas columnas hay en la grilla din치micamente
        const gridStyle = window.getComputedStyle(document.getElementById('app-grid'));
        const columnCount = gridStyle.getPropertyValue('grid-template-columns').split(' ').length;

        // Traductor de teclas de Android TV
        let tecla = e.keyCode;
        if (tecla === 19) tecla = 38; // Up
        if (tecla === 20) tecla = 40; // Down
        if (tecla === 21) tecla = 37; // Left
        if (tecla === 22) tecla = 39; // Right

        switch (tecla) {
            case 37: // Izquierda
                if (currentIndex > 0) elementosFocusables[currentIndex - 1].focus();
                e.preventDefault();
                break;
            case 39: // Derecha
                if (currentIndex < elementosFocusables.length - 1) elementosFocusables[currentIndex + 1].focus();
                e.preventDefault();
                break;
            case 38: // Arriba
                if (currentIndex - columnCount >= 0) elementosFocusables[currentIndex - columnCount].focus();
                e.preventDefault();
                break;
            case 40: // Abajo
                if (currentIndex + columnCount < elementosFocusables.length) elementosFocusables[currentIndex + columnCount].focus();
                e.preventDefault();
                break;
        }
    });
</script>
</body>
</html>
