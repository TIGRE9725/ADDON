<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamNet - VOD Player</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* === ESTILOS GENERALES === */
        :root { --primary: #E50914; --bg: #0f0f0f; --key-bg: #222; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; user-select: none; }
        
        /* FOCO (Borde Blanco Brillante) */
        .focusable:focus {
            outline: none; border: 3px solid white !important; transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0,0,0,0.9); z-index: 9999;
            background-color: rgba(255,255,255,0.1);
        }

        /* HEADER */
        header { position: fixed; top: 0; width: 100%; height: 70px; z-index: 100; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent); display: flex; align-items: center; justify-content: space-between; padding: 0 4%; box-sizing: border-box; }
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .logo { color: var(--primary); font-size: 28px; font-weight: 900; letter-spacing: 1px; text-decoration: none; text-shadow: 2px 2px 4px black; }
        .nav-btn { background: transparent; border: 2px solid transparent; color: #aaa; font-size: 16px; cursor: pointer; font-weight: bold; padding: 8px 20px; border-radius: 4px; transition: 0.2s; }
        .nav-btn.active { color: white; background: rgba(255,255,255,0.1); border-bottom: 2px solid var(--primary); }
        
        .search-btn-header { background: rgba(255,255,255,0.1); border: 2px solid transparent; color: white; padding: 10px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        /* CONTENEDOR PRINCIPAL */
        #app { padding-top: 90px; height: 100vh; overflow-y: auto; padding-bottom: 50px; box-sizing: border-box; }
        .section-title { margin-left: 4%; font-size: 1.4rem; color: #ddd; margin-bottom: 15px; margin-top: 30px; font-weight: bold; }
        
        /* CAROUSEL HORIZONTAL (HOME) */
        .horizontal-scroll { display: flex; gap: 15px; overflow-x: auto; padding: 10px 4%; scroll-behavior: smooth; padding-bottom: 30px; }
        .horizontal-scroll::-webkit-scrollbar { height: 0px; }
        
        /* GRID VERTICAL (CATEGORIAS) */
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; padding: 20px 4%; }
        
        /* TARJETAS */
        .card { 
            min-width: 150px; height: 225px; background: #1a1a1a; border-radius: 8px; 
            cursor: pointer; position: relative; overflow: hidden; 
            transition: transform 0.2s; border: 3px solid transparent; 
        }
        .card-fallback-title { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; text-align: center; padding: 5px; font-size: 0.9rem; font-weight: bold; color: #555; z-index: 0; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: relative; z-index: 10; background: #1a1a1a; }
        
        /* BARRA PROGRESO */
        .progress-track { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background: rgba(0,0,0,0.5); z-index: 20; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; }

        /* BUSQUEDA */
        #search-interface { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; padding: 80px 5%; }
        .search-container { display: flex; height: 100%; gap: 40px; }
        .keyboard-panel { flex: 0 0 350px; }
        .search-input-display { font-size: 2.5rem; color: white; border-bottom: 2px solid var(--primary); padding-bottom: 10px; margin-bottom: 20px; font-weight: bold; }
        .keyboard-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; }
        .key-btn { height: 50px; background: #222; color: white; border: 2px solid transparent; border-radius: 50%; font-size: 1.1rem; cursor: pointer; }
        .key-btn.wide { grid-column: span 2; border-radius: 25px; }
        .results-panel { flex: 1; overflow: hidden; display: flex; flex-direction: column; }
        #search-results-grid { overflow-y: auto; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; padding: 10px; }
        #search-results-grid .card { min-width: auto; height: 180px; width: 100%; }

        /* VISTA DETALLES */
        #details-view { position: fixed; inset: 0; background: #000; z-index: 200; display: none; overflow-y: auto; }
        .details-hero { width: 100%; height: 60vh; background-size: cover; background-position: center top; mask-image: linear-gradient(to bottom, black 20%, transparent); -webkit-mask-image: linear-gradient(to bottom, black 20%, transparent); }
        .details-content { position: absolute; top: 25%; left: 5%; width: 50%; z-index: 10; }
        .details-title { font-size: 3.5rem; font-weight: 900; margin-bottom: 10px; line-height: 1; text-shadow: 2px 2px 10px black; }
        .details-meta { font-size: 1.2rem; color: #ccc; margin-bottom: 20px; display: flex; gap: 15px; }
        .tag { background: rgba(255,255,255,0.15); padding: 4px 12px; border-radius: 4px; font-size: 0.9rem; font-weight: bold; }
        .details-desc { font-size: 1.1rem; line-height: 1.5; color: #ddd; margin-bottom: 30px; max-width: 800px; text-shadow: 1px 1px 2px black; }
        
        .action-row { display: flex; gap: 20px; }
        .btn-large { padding: 12px 35px; font-size: 1.2rem; font-weight: bold; border-radius: 4px; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; }
        .btn-primary { background: white; color: black; }
        .btn-secondary { background: rgba(255,255,255,0.2); color: white; }

        /* SERIES UI */
        #series-container { position: relative; margin-top: -50px; padding: 0 5% 50px 5%; z-index: 20; display: none; }
        .season-selector { background: #222; color: white; border: 1px solid #444; padding: 10px 20px; border-radius: 4px; font-size: 1.1rem; margin-bottom: 20px; cursor: pointer; }
        .episode-scroller { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; }
        .episode-card { min-width: 250px; background: #222; border-radius: 6px; overflow: hidden; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .episode-card:focus { transform: scale(1.05); border-color: white; }
        .ep-thumb { width: 100%; height: 140px; object-fit: cover; }
        .ep-info { padding: 10px; }
        .ep-title { font-weight: bold; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* PLAYER */
        #player-container { position: fixed; inset: 0; background: black; z-index: 5000; display: none; }
        #video { width: 100%; height: 100%; }
        
        .player-ui { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: space-between; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent, rgba(0,0,0,0.9)); transition: opacity 0.3s; pointer-events: none; }
        .ui-hidden { opacity: 0; }
        .p-header { padding: 30px; display: flex; justify-content: space-between; align-items: center; pointer-events: auto; }
        .p-title { font-size: 1.5rem; font-weight: bold; }
        .p-controls { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 40px; pointer-events: auto; }
        
        .ctrl-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(0,0,0,0.6); border: 2px solid #aaa; color: white; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s; }
        .ctrl-btn:focus { background: var(--primary); border-color: white; transform: scale(1.1); }

        #loading-msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #222; padding: 20px; border-radius: 10px; z-index: 9999; font-weight: bold; }
    </style>
</head>
<body>

    <header id="main-header">
        <div class="nav-left">
            <div class="logo">STREAMNET</div>
            <button class="nav-btn focusable active" onclick="renderView('home')">Inicio</button>
            <button class="nav-btn focusable" onclick="renderView('movies')">Películas</button>
            <button class="nav-btn focusable" onclick="renderView('series')">Series</button>
        </div>
        <button class="search-btn-header focusable" onclick="openSearch()">
            <span class="material-icons-round">search</span>
        </button>
    </header>

    <div id="app">
        <div id="loading-msg">Cargando contenido...</div>
    </div>

    <div id="search-interface">
        <div class="search-container">
            <div class="keyboard-panel">
                <div class="search-input-display" id="search-input"></div>
                <div class="keyboard-grid" id="keyboard"></div>
            </div>
            <div class="results-panel">
                <h3 id="search-status" style="color:#777">Resultados...</h3>
                <div id="search-results-grid"></div>
            </div>
        </div>
    </div>

    <div id="details-view">
        <div class="details-hero" id="det-hero"></div>
        <div class="details-content">
            <h1 class="details-title" id="det-title">Titulo</h1>
            <div class="details-meta">
                <span class="tag" id="det-year">2024</span>
                <span class="tag" id="det-type">Película</span>
            </div>
            <p class="details-desc" id="det-desc">...</p>
            <div class="action-row">
                <button id="btn-play-hero" class="btn-large btn-primary focusable">
                    <span class="material-icons-round">play_arrow</span> <span id="play-text">Reproducir</span>
                </button>
                <button class="btn-large btn-secondary focusable" onclick="closeDetails()">
                    <span class="material-icons-round">arrow_back</span> Volver
                </button>
            </div>
        </div>
        
        <div id="series-container">
            <div class="season-header">
                <select id="season-select" class="season-selector focusable"></select>
            </div>
            <div id="episodes-list" class="episode-scroller"></div>
        </div>
    </div>

    <div id="player-container">
        <video id="video" autoplay></video>
        <div id="player-ui" class="player-ui">
            <div class="p-header">
                <button class="ctrl-btn focusable" style="width:50px; height:50px;" onclick="exitPlayer()">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <div class="p-title" id="p-title">Título</div>
            </div>
            <div class="p-controls">
                <button id="btn-prev" class="ctrl-btn focusable" onclick="changeEpisode(-1)"><span class="material-icons-round">skip_previous</span></button>
                <button class="ctrl-btn focusable" onclick="togglePlay()"><span class="material-icons-round" id="icon-play">pause</span></button>
                <button id="btn-next" class="ctrl-btn focusable" onclick="changeEpisode(1)"><span class="material-icons-round">skip_next</span></button>
            </div>
            <div style="height:50px"></div>
        </div>
    </div>

<script>
    // CONFIGURACIÓN Y DATOS
    const DEFAULT_IMG = "https://via.placeholder.com/300x450/222/FFF?text=No+Image";
    let catalog = [], currentView = 'home', activeCategory = 'home';
    let currentItem = null, player = null, uiTimer = null;
    let currentSeason = 0, currentEp = 0;
    let searchStr = "";

    // TECLADO VIRTUAL
    const KEYS = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","1","2","3","4","5","6","7","8","9","0","SPACE","DEL","BORRAR"];

    window.onload = async () => {
        initShaka();
        await loadData();
        setupKeyboard();
        
        document.addEventListener('keydown', handleKeys);
        document.getElementById('player-container').addEventListener('mousemove', showUI);
    };

    // --- CARGA DE DATOS ---
    async function loadData() {
        try {
            const [r1, r2] = await Promise.all([
                fetch('https://dl.dropboxusercontent.com/s/2hv588f06l7y265fx12ti/peliculas.json?rlkey=w2ob1lmu9clymri00puohuhbd&dl=1'),
                fetch('https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1')
            ]);
            const d1 = await r1.json();
            const d2 = await r2.json();
            
            // PROCESAR Y UNIFICAR
            catalog = [
                ...d1.map(i => processItem(i, 'movie')),
                ...d2.map(i => processItem(i, 'series'))
            ];
            
            document.getElementById('loading-msg').style.display = 'none';
            renderView('home');
        } catch(e) {
            document.getElementById('loading-msg').innerText = "Error cargando datos.";
        }
    }

    function processItem(i, type) {
        // Detectar si es serie aunque venga en pelis (por seguridad)
        if(i.estaciones || i.seasons || (i.tipo && i.tipo.includes('serie'))) type = 'series';
        
        let seasons = [];
        if(type === 'series') {
            const rawSeasons = i.estaciones || i.seasons || [];
            seasons = rawSeasons.map((s, idx) => ({
                num: s.numero || s.season_number || idx+1,
                episodes: (s.episodios || s.episodes || []).map(e => ({
                    title: e.title || e.titulo,
                    img: e.img || e.image || i.poster,
                    url: e.url || e.mpd || e.source?.url,
                    drm: e.drm || e.source?.drm
                }))
            }));
        }

        return {
            id: i.id || Math.random().toString(36),
            title: i.titulo || i.title,
            desc: i.sinopsis || i.description || "Sin descripción",
            poster: i.poster || i.img || i.images?.poster || DEFAULT_IMG,
            hero: i.backdrop || i.poster || DEFAULT_IMG,
            year: i.year || '',
            type: type,
            url: i.url || i.mpd || i.source?.url,
            drm: i.drm || i.source?.drm,
            seasons: seasons
        };
    }

    // --- RENDERIZADO ---
    function renderView(view) {
        activeCategory = view; 
        currentView = view;
        const app = document.getElementById('app');
        app.innerHTML = '';
        
        // Actualizar header
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        if(view === 'home') document.querySelectorAll('.nav-btn')[0].classList.add('active');
        if(view === 'series') document.querySelectorAll('.nav-btn')[1].classList.add('active');
        if(view === 'movies') document.querySelectorAll('.nav-btn')[2].classList.add('active');

        document.getElementById('search-interface').style.display = 'none';
        document.getElementById('details-view').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('main-header').style.display = 'flex';

        if(view === 'home') {
            // Carruseles Home
            const continueWatch = catalog.filter(x => getProgress(x.id).pct > 1 && getProgress(x.id).pct < 95);
            if(continueWatch.length) createRow("Continuar Viendo", continueWatch);
            
            createRow("Series Agregadas", catalog.filter(x => x.type === 'series').slice(0, 15));
            createRow("Películas Nuevas", catalog.filter(x => x.type === 'movie').slice(0, 15));
        } else {
            // Grilla completa
            const list = catalog.filter(x => view === 'movies' ? x.type === 'movie' : x.type === 'series');
            app.innerHTML = `<div class="grid-view">${list.map(cardHtml).join('')}</div>`;
        }
        
        setTimeout(() => {
            const first = document.querySelector('.card');
            if(first) first.focus();
        }, 100);
    }

    function createRow(title, items) {
        if(!items.length) return;
        const html = `<div><h3 class="section-title">${title}</h3><div class="horizontal-scroll">${items.map(cardHtml).join('')}</div></div>`;
        document.getElementById('app').insertAdjacentHTML('beforeend', html);
    }

    function cardHtml(item) {
        const p = getProgress(item.id);
        const bar = p.pct > 0 ? `<div class="progress-track" style="display:block"><div class="progress-fill" style="width:${p.pct}%"></div></div>` : '';
        return `
            <div class="card focusable" tabindex="0" onclick="openDetails('${item.id}')">
                <div class="card-fallback-title">${item.title}</div>
                <img src="${item.poster}" onerror="this.src='${DEFAULT_IMG}'">
                ${bar}
            </div>
        `;
    }

    // --- DETALLES ---
    function openDetails(id) {
        currentItem = catalog.find(x => x.id === id);
        if(!currentItem) return;
        
        currentView = 'details';
        document.getElementById('app').style.display = 'none';
        document.getElementById('details-view').style.display = 'block';
        
        document.getElementById('det-title').innerText = currentItem.title;
        document.getElementById('det-desc').innerText = currentItem.desc;
        document.getElementById('det-hero').style.backgroundImage = `url('${currentItem.hero}')`;
        document.getElementById('det-type').innerText = currentItem.type === 'series' ? 'Serie' : 'Película';
        document.getElementById('det-year').innerText = currentItem.year;

        const btnPlay = document.getElementById('btn-play-hero');
        const sCont = document.getElementById('series-container');

        if(currentItem.type === 'series') {
            sCont.style.display = 'block';
            renderSeasons();
            
            // Botón Play reanuda serie
            const last = getLastSeen(currentItem.id);
            btnPlay.innerHTML = `<span class="material-icons-round">play_arrow</span> Reanudar T${currentItem.seasons[last.s].num} E${last.e+1}`;
            btnPlay.onclick = () => playEpisode(last.s, last.e);
        } else {
            sCont.style.display = 'none';
            const prog = getProgress(currentItem.id);
            btnPlay.innerHTML = `<span class="material-icons-round">play_arrow</span> ${prog.pct > 0 ? 'Reanudar' : 'Reproducir'}`;
            btnPlay.onclick = () => startPlayer(currentItem.url, currentItem.drm, currentItem.title);
        }
        
        setTimeout(() => btnPlay.focus(), 100);
    }

    function renderSeasons() {
        const sel = document.getElementById('season-select');
        sel.innerHTML = '';
        currentItem.seasons.forEach((s, idx) => {
            sel.innerHTML += `<option value="${idx}">Temporada ${s.num}</option>`;
        });
        
        const last = getLastSeen(currentItem.id);
        sel.value = last.s;
        sel.onchange = () => renderEpisodes(sel.value);
        renderEpisodes(last.s);
    }

    function renderEpisodes(sIdx) {
        const list = document.getElementById('episodes-list');
        list.innerHTML = '';
        const season = currentItem.seasons[sIdx];
        
        season.episodes.forEach((ep, idx) => {
            const div = document.createElement('div');
            div.className = 'episode-card focusable';
            div.tabIndex = 0;
            div.innerHTML = `
                <img src="${ep.img}" class="ep-thumb" onerror="this.src='${DEFAULT_IMG}'">
                <div class="ep-info"><div class="ep-title">${idx+1}. ${ep.title}</div></div>
            `;
            div.onclick = () => playEpisode(sIdx, idx);
            list.appendChild(div);
        });
    }

    function closeDetails() {
        document.getElementById('details-view').style.display = 'none';
        renderView(activeCategory);
    }

    // --- REPRODUCTOR ---
    function initShaka() {
        shaka.polyfill.installAll();
        if(shaka.Player.isBrowserSupported()) {
            player = new shaka.Player(document.getElementById('video'));
            player.configure({ streaming: { bufferingGoal: 30 } });
            // UI Overlay
            const ui = new shaka.ui.Overlay(player, document.getElementById('player-container'), document.getElementById('video'));
            ui.configure({controlPanelElements: ['time_and_duration','spacer','mute','fullscreen']});
            
            // Eventos
            document.getElementById('video').addEventListener('timeupdate', saveCurrentProgress);
            document.getElementById('video').addEventListener('ended', onVideoEnded);
            player.addEventListener('error', e => console.error(e));
        }
    }

    async function startPlayer(url, drm, title) {
        document.getElementById('player-container').style.display = 'block';
        currentView = 'player';
        
        // UI
        document.getElementById('p-title').innerText = title;
        document.getElementById('p-sub').innerText = currentItem.type === 'series' ? `T${currentItem.seasons[currentSeason].num}` : '';
        document.getElementById('btn-prev').style.display = currentItem.type === 'series' ? 'flex' : 'none';
        document.getElementById('btn-next').style.display = currentItem.type === 'series' ? 'flex' : 'none';

        try {
            await player.unload();
            if(drm && drm.clearKeys) player.configure({drm:{clearKeys:drm.clearKeys}});
            await player.load(url);
            
            const vid = document.getElementById('video');
            const saveId = currentItem.type === 'series' ? getEpId(currentItem.id, currentSeason, currentEp) : currentItem.id;
            const prog = getProgress(saveId);
            if(prog.pct > 1 && prog.pct < 95) vid.currentTime = prog.time;
            
            vid.play();
            showUI();
            setTimeout(()=>document.getElementById('btn-play-center').focus(), 100);
        } catch(e) { console.error("Error player", e); exitPlayer(); }
    }

    function playEpisode(s, e) {
        currentSeason = parseInt(s);
        currentEp = parseInt(e);
        const ep = currentItem.seasons[currentSeason].episodes[currentEp];
        if(ep) startPlayer(ep.url, ep.drm, ep.title);
    }

    function changeEpisode(dir) {
        let ns = currentSeason, ne = currentEp + dir;
        const season = currentItem.seasons[ns];
        
        if (ne >= season.episodes.length) { // Next Season
            if (ns + 1 < currentItem.seasons.length) { ns++; ne = 0; } else return;
        } else if (ne < 0) { // Prev Season
            if (ns > 0) { ns--; ne = currentItem.seasons[ns].episodes.length - 1; } else return;
        }
        playEpisode(ns, ne);
    }

    function exitPlayer() {
        document.getElementById('video').pause();
        player.unload();
        document.getElementById('player-container').style.display = 'none';
        // Volver a detalles
        document.getElementById('details-view').style.display = 'block';
        currentView = 'details';
        setTimeout(()=>document.getElementById('btn-play-hero').focus(), 100);
    }

    function showUI() {
        const ui = document.getElementById('player-ui');
        ui.classList.remove('ui-fade-out');
        clearTimeout(uiTimer);
        if(!document.getElementById('video').paused) uiTimer = setTimeout(()=>ui.classList.add('ui-fade-out'), 3000);
    }
    
    function togglePlay() { 
        const v = document.getElementById('video'); 
        v.paused ? v.play() : v.pause(); 
        showUI();
    }
    
    function onVideoEnded() {
        if(currentItem.type === 'series') changeEpisode(1);
        else exitPlayer();
    }

    // --- DATA UTILS ---
    function getEpId(id, s, e) { return `${id}_s${s}_e${e}`; }
    function saveCurrentProgress() {
        const vid = document.getElementById('video');
        if(vid.paused) return;
        
        let id = currentItem.id;
        if(currentItem.type === 'series') {
            id = getEpId(currentItem.id, currentSeason, currentEp);
            localStorage.setItem('last_seen_'+currentItem.id, JSON.stringify({s:currentSeason, e:currentEp}));
        }
        localStorage.setItem('prog_'+id, JSON.stringify({time: vid.currentTime, pct: (vid.currentTime/vid.duration)*100}));
    }
    function getProgress(id) { 
        const d = localStorage.getItem('prog_'+id); 
        return d ? JSON.parse(d) : {time:0, pct:0}; 
    }
    function getLastSeen(id) {
        const d = localStorage.getItem('last_seen_'+id);
        return d ? JSON.parse(d) : {s:0, e:0};
    }

    // --- SEARCH ---
    function openSearch() {
        currentView = 'search';
        document.getElementById('app').style.display = 'none';
        document.getElementById('search-interface').style.display = 'block';
        searchStr = ""; renderKeyboard(); updateSearchDisplay();
        setTimeout(()=>document.querySelector('.key-btn').focus(), 100);
    }
    function closeSearch() {
        document.getElementById('search-interface').style.display = 'none';
        renderView(activeCategory);
    }
    function setupKeyboard() { renderKeyboard(); }
    function renderKeyboard() {
        const grid = document.getElementById('keyboard-grid');
        grid.innerHTML = KEYS.map(k => `<button class="key-btn focusable ${k.length>1?'wide':''}" onclick="typeKey('${k}')">${k}</button>`).join('');
    }
    function typeKey(k) {
        if(k === 'BORRAR') closeSearch();
        else if(k === 'DEL') searchStr = searchStr.slice(0, -1);
        else if(k === 'SPACE') searchStr += ' ';
        else searchStr += k;
        updateSearchDisplay();
    }
    function updateSearchDisplay() {
        document.getElementById('virtual-input-display').innerText = searchStr + "_";
        const res = document.getElementById('search-results-grid');
        const term = searchStr.toLowerCase();
        
        if(!term) { 
            res.innerHTML = ''; 
            document.getElementById('results-count-text').innerText = "Escribe para buscar..."; 
            return; 
        }
        
        const hits = catalog.filter(i => i.title.toLowerCase().includes(term));
        document.getElementById('results-count-text').innerText = `${hits.length} Resultados`;
        res.innerHTML = hits.map(cardHtml).join('');
    }

    // --- INPUTS ---
    function handleKeys(e) {
        const k = e.keyCode;
        
        // BACK
        if([8, 461, 10009, 27].includes(k)) {
            e.preventDefault();
            if(currentView === 'player') exitPlayer();
            else if(currentView === 'details') closeDetails();
            else if(currentView === 'search') closeSearch();
            else if(currentView !== 'home') renderView('home');
            return;
        }

        // NAVIGATION
        if([37,38,39,40].includes(k)) {
            e.preventDefault();
            if(currentView === 'player') { showUI(); return; }

            const items = Array.from(document.querySelectorAll('.focusable:not([style*="display: none"])'));
            const current = document.activeElement;
            const idx = items.indexOf(current);
            
            if(idx === -1 && items.length) { items[0].focus(); return; }

            let next = idx;
            if(k === 39) next++; // Right
            if(k === 37) next--; // Left
            
            // Grid logic
            if(k === 40 || k === 38) {
                // Estimar columnas basado en ancho (aprox 150px por item + gap)
                const containerW = document.body.clientWidth;
                const cols = Math.floor(containerW / 170); 
                if(k === 40) next += cols;
                if(k === 38) next -= cols;
            }

            if(next >= 0 && next < items.length) {
                items[next].focus();
                items[next].scrollIntoView({behavior: 'smooth', block: 'center'});
            }
        }

        // ENTER
        if(k === 13 || k === 23) {
            document.activeElement.click();
        }
        
        // PLAYER KEYS
        if(currentView === 'player') {
            if(k === 415 || k === 19 || k === 85) togglePlay(); // Play/Pause
            if(k === 413) exitPlayer(); // Stop
            if(k === 417) document.getElementById('video').currentTime += 10; // FF
            if(k === 412) document.getElementById('video').currentTime -= 10; // RW
        }
    }

</script>
</body>
</html>
