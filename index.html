<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StreamNet - Universal Player</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ================= ESTILOS GENERALES ================= */
        :root { --primary: #E50914; --bg: #000000; --overlay: rgba(0,0,0,0.7); }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; user-select: none; }
        
        .focusable:focus {
            outline: none; border: 3px solid white !important; transform: scale(1.05);
            box-shadow: 0 0 20px rgba(0,0,0,0.8); z-index: 100;
        }

        /* HEADER */
        header { position: fixed; top: 0; width: 100%; height: 60px; z-index: 50; background: linear-gradient(to bottom, rgba(0,0,0,0.9), transparent); display: flex; align-items: center; padding: 0 4%; }
        .logo { color: var(--primary); font-size: 24px; font-weight: 900; margin-right: 20px; text-shadow: 2px 2px 4px black; }
        .breadcrumb { font-size: 14px; color: #ccc; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .breadcrumb span { color: var(--primary); }

        /* GRID VIEW */
        #app { padding-top: 80px; height: 100vh; overflow-y: auto; padding-bottom: 50px; box-sizing: border-box; }
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; padding: 0 4%; }
        
        .card { 
            aspect-ratio: 2/3; background: #222; border-radius: 6px; position: relative; cursor: pointer; border: 3px solid transparent; overflow: hidden; transition: transform 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .card img { width: 100%; height: 100%; object-fit: cover; z-index: 1; }
        .card-title { position: absolute; z-index: 0; text-align: center; color: #777; font-size: 0.9rem; padding: 5px; width: 100%; }
        .folder-icon { position: absolute; top: 5px; right: 5px; z-index: 2; background: rgba(0,0,0,0.6); border-radius: 50%; padding: 4px; }

        /* VISTA DE DETALLES (RECUPERADA) */
        #details-view { position: fixed; inset: 0; background: var(--bg); z-index: 200; display: none; overflow-y: auto; }
        .details-hero { width: 100%; height: 60vh; background-size: cover; background-position: center top; mask-image: linear-gradient(to bottom, black 50%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%); }
        .details-content { position: absolute; top: 40%; left: 5%; width: 90%; z-index: 10; }
        .details-title { font-size: 3rem; font-weight: 900; margin-bottom: 10px; text-shadow: 2px 2px 10px black; }
        .details-desc { font-size: 1.1rem; color: #ddd; max-width: 600px; margin-bottom: 20px; text-shadow: 1px 1px 2px black; }
        .btn-large { padding: 12px 30px; font-size: 1.2rem; font-weight: bold; background: white; color: black; border: none; border-radius: 4px; cursor: pointer; display: inline-flex; align-items: center; gap: 10px; }
        .btn-secondary { background: rgba(100,100,100,0.6); color: white; margin-left: 15px; }

        /* REPRODUCTOR PERSONALIZADO (RECUPERADO) */
        #player-container { position: fixed; inset: 0; background: black; z-index: 5000; display: none; }
        #video { width: 100%; height: 100%; }
        
        .player-ui { 
            position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: space-between; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent 20%, transparent 80%, rgba(0,0,0,0.8));
            pointer-events: none; opacity: 1; transition: opacity 0.3s; z-index: 6000;
        }
        .ui-hidden { opacity: 0; }

        .p-header { padding: 30px; display: flex; justify-content: space-between; align-items: flex-start; }
        .p-clock { font-size: 1.5rem; font-weight: bold; text-shadow: 2px 2px 4px black; }
        .p-title { font-size: 1.5rem; font-weight: bold; text-align: right; text-shadow: 2px 2px 4px black; }

        .p-controls { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            display: flex; gap: 40px; align-items: center; pointer-events: auto; 
        }
        .ctrl-btn { 
            width: 70px; height: 70px; border-radius: 50%; background: rgba(0,0,0,0.5); border: 2px solid rgba(255,255,255,0.3); color: white; 
            display: flex; align-items: center; justify-content: center; cursor: pointer; transition: transform 0.2s;
        }
        .ctrl-btn:focus { background: var(--primary); transform: scale(1.1); border-color: white; }
        .ctrl-btn.mini { width: 50px; height: 50px; }

        /* LOADING & ERROR */
        #loading-msg { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.8); padding: 20px; border-radius: 10px; z-index: 2000; display: none; font-weight: bold; }
        
    </style>
</head>
<body>

    <header id="main-header">
        <div class="logo">STREAMNET</div>
        <div id="breadcrumb" class="breadcrumb">Inicio</div>
    </header>

    <div id="loading-msg">Cargando...</div>

    <div id="app"></div>

    <div id="details-view">
        <div class="details-hero" id="det-hero"></div>
        <div class="details-content">
            <div class="details-title" id="det-title">Título</div>
            <div class="details-desc" id="det-desc">Descripción...</div>
            <div>
                <button id="btn-play-hero" class="btn-large focusable" onclick="playCurrentItem()">
                    <span class="material-icons-round">play_arrow</span> Reproducir
                </button>
                <button class="btn-large btn-secondary focusable" onclick="closeDetails()">
                    <span class="material-icons-round">arrow_back</span> Volver
                </button>
            </div>
        </div>
    </div>

    <div id="player-container">
        <video id="video" autoplay></video>
        
        <div id="player-ui" class="player-ui">
            <div class="p-header">
                <button class="ctrl-btn mini focusable" onclick="closePlayer()" style="pointer-events: auto;">
                    <span class="material-icons-round">arrow_back</span>
                </button>
                <div class="p-clock" id="p-clock">00:00</div>
                <div class="p-title" id="p-title-display">Canal</div>
            </div>

            <div class="p-controls">
                <button id="btn-prev" class="ctrl-btn mini focusable" style="display:none">
                    <span class="material-icons-round">skip_previous</span>
                </button>
                
                <button id="btn-play-center" class="ctrl-btn focusable" onclick="togglePlay()">
                    <span class="material-icons-round" id="icon-play">pause</span>
                </button>
                
                <button id="btn-next" class="ctrl-btn mini focusable" style="display:none">
                    <span class="material-icons-round">skip_next</span>
                </button>
            </div>
        </div>
    </div>

<script>
    // ================= CONFIGURACIÓN =================
    const MAIN_MENU = [
        { id: 'tv_root', title: 'TV En Vivo', img: 'https://img.icons8.com/color/480/tv.png', type: 'folder' },
        { id: 'movies_root', title: 'Películas', img: 'https://img.icons8.com/color/480/movie-projector.png', type: 'folder' },
        { id: 'series_root', title: 'Series', img: 'https://img.icons8.com/color/480/tv-show.png', type: 'folder' }
    ];

    const PROVIDERS_DATA = {
        'tv_root': [
            { title: 'IZZI TV', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/scl/fi/9y6dlas2jujl5tlsmrgse/IZZI.m3u?rlkey=qmbog8h21oha6upqxr0y54o2o&st=lgx3ekfe&dl=1', img: 'https://i.imgur.com/LOGO_IZZI.png' },
            { title: 'DISH', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/8vkt6055ift44x9yd5gm8/DISH.m3u?rlkey=66ltvgj7q8lsw352j5gvvm4ri&dl=1', img: 'https://i.imgur.com/LOGO_DISH.png' },
            { title: 'STAR TV', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/vnmo8y2l2z25dpzkv52hl/STARTV.m3u?rlkey=d3oj0vqgldbnmuqf30qaeqqti&dl=1', img: 'https://i.imgur.com/LOGO_STARTV.png' },
            { title: 'DIRECTV', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/avcnlb0d4bjrftmvzyau1/DTVGO.m3u?rlkey=xastr4qmw5e47772el989a0p5&dl=1', img: 'https://i.imgur.com/LOGO_DIRECTV.png' },
            { title: 'CLARO TV', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/eh5mm29jasa9y2gesiih0/CLAROTV.m3u?rlkey=eqn05qohgj10vbsa7279ij5qh&dl=1', img: 'https://i.imgur.com/LOGO_CLARO.png' },
            { title: 'AMAZON', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/agoem2v71esupgmbj1gck/AMAZON.m3u?rlkey=7tzh7zpan9quxz7l019sgndnh&dl=1', img: 'https://i.imgur.com/LOGO_AMAZON.png' },
            { title: 'SENSA (ARG)', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/dv2o6zl6zaekmenag4xkg/ARG.m3u?rlkey=hj1u6yyshizmco48qkrbhkyft&dl=1', img: 'https://i.imgur.com/LOGO_SENSA.png' },
            { title: 'INTERNET (MX)', type: 'folder', source_type: 'm3u', url: 'https://dl.dropboxusercontent.com/s/q7xiqcsb8ymwo0g/MX-TPLAY.m3u?dl=1', img: 'https://i.imgur.com/LOGO_INTERNET.png' }
        ],
        'movies_root': [
            { title: 'IZZI GO', type: 'folder', source_type: 'json', url: 'https://gist.githubusercontent.com/TIGRE9725/f7c1267ddd3460062c44d6c93e932c95/raw/izzigo.json', img: 'https://i.imgur.com/LOGO_IZZIGO.png' },
            { title: 'NETVIDEO', type: 'folder', source_type: 'm3u', url: 'https://gist.githubusercontent.com/TIGRE9725/9d495adb5d3737cd9e0ece692aaf1917/raw/netvideo.pelis.m3u', img: 'https://i.imgur.com/LOGO_NETVIDEO.png' },
            { title: 'SERVIDOR 1', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/playlist_peliculas.m3u', img: 'https://via.placeholder.com/300?text=S1' },
            { title: 'SERVIDOR 2', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_server.m3u', img: 'https://via.placeholder.com/300?text=S2' },
            { title: 'SERVIDOR 3', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_dyndns.m3u', img: 'https://via.placeholder.com/300?text=S3' }
        ],
        'series_root': [
            { title: 'IZZI GO', type: 'folder', source_type: 'json', url: 'https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1', img: 'https://i.imgur.com/LOGO_IZZIGO.png' },
            { title: 'NETVIDEO', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/PELIS/main/netvideo.series.m3u', img: 'https://i.imgur.com/LOGO_NETVIDEO.png' },
            { title: 'SERVER 1', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/playlist_series.m3u', img: 'https://via.placeholder.com/300?text=S1' },
            { title: 'SERVER 2', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_server_series.m3u', img: 'https://via.placeholder.com/300?text=S2' },
            { title: 'SERVER 3', type: 'folder', source_type: 'm3u', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_dyndns_series.m3u', img: 'https://via.placeholder.com/300?text=S3' }
        ]
    };

    let navigationStack = [];
    let player = null;
    let isPlaying = false;
    let isLiveContent = false; // Bandera para saber si es TV en Vivo
    let selectedItem = null;   // Item seleccionado para ver detalles
    let uiTimer = null;
    const DEFAULT_IMG = "https://via.placeholder.com/300x450/333333/FFFFFF?text=Sin+Imagen";

    window.onload = () => {
        initShaka();
        openFolder("Inicio", MAIN_MENU);
        setInterval(() => {
            document.getElementById('p-clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        }, 1000);
    };

    // ================= NAVEGACIÓN =================
    function openFolder(title, items) {
        navigationStack.push({ title, items });
        renderGrid(items);
        updateBreadcrumb();
    }

    function goBack() {
        if (navigationStack.length > 1) {
            navigationStack.pop();
            const prev = navigationStack[navigationStack.length - 1];
            renderGrid(prev.items);
            updateBreadcrumb();
            return true;
        }
        return false;
    }

    function renderGrid(items) {
        const app = document.getElementById('app');
        app.innerHTML = '';
        
        const grid = document.createElement('div');
        grid.className = 'grid-view';

        if(!items || items.length === 0) {
            app.innerHTML = '<h3 style="text-align:center; color:#666; margin-top:50px;">Carpeta Vacía</h3>';
            return;
        }

        items.forEach((item) => {
            const card = document.createElement('div');
            card.className = 'card focusable';
            card.tabIndex = 0;
            card.onclick = () => handleItemClick(item);

            const isFolder = item.type === 'folder';
            const imgSrc = item.poster || item.img || "";
            const iconHTML = isFolder ? '<div class="folder-icon"><span class="material-icons-round">folder_open</span></div>' : '';

            card.innerHTML = `
                <div class="card-title">${item.title}</div>
                <img src="${imgSrc}" loading="lazy" onerror="this.style.display='none'">
                ${iconHTML}
            `;
            grid.appendChild(card);
        });
        app.appendChild(grid);
        
        setTimeout(() => { const f = document.querySelector('.card'); if(f) f.focus(); }, 100);
    }

    function updateBreadcrumb() {
        const path = navigationStack.map(x => x.title).join(' <span class="material-icons-round" style="font-size:14px">chevron_right</span> ');
        document.getElementById('breadcrumb').innerHTML = path;
    }

    // ================= MANEJO DE SELECCIÓN =================
    async function handleItemClick(item) {
        // 1. CARPETAS
        if (item.type === 'folder') {
            if (item.children) {
                openFolder(item.title, item.children);
            } else if (item.url) {
                document.getElementById('loading-msg').style.display = 'block';
                const content = await fetchAndParseContent(item);
                document.getElementById('loading-msg').style.display = 'none';
                if(content.length > 0) openFolder(item.title, content);
            }
            return;
        }

        // 2. CONTENIDO (TV, PELIS, SERIES)
        selectedItem = item;

        // Si es TV EN VIVO -> Reproducir directo
        // Detectamos si viene de la rama "TV En Vivo" mirando el historial
        const isTV = navigationStack.some(x => x.title === "TV En Vivo");
        
        if (isTV) {
            startPlayer(item, true); // true = ES LIVE
        } else {
            // Si es Película o Serie -> Mostrar Detalles primero
            openDetails(item);
        }
    }

    function openDetails(item) {
        const view = document.getElementById('details-view');
        document.getElementById('det-hero').style.backgroundImage = `url('${item.poster || DEFAULT_IMG}')`;
        document.getElementById('det-title').innerText = item.title;
        document.getElementById('det-desc').innerText = item.desc || "Sin descripción disponible.";
        
        document.getElementById('app').style.display = 'none';
        document.getElementById('main-header').style.display = 'none';
        view.style.display = 'block';
        
        setTimeout(() => document.getElementById('btn-play-hero').focus(), 100);
    }

    function closeDetails() {
        document.getElementById('details-view').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('main-header').style.display = 'flex';
        setTimeout(() => { const f = document.querySelector('.card'); if(f) f.focus(); }, 100);
    }

    function playCurrentItem() {
        // Reproducir desde la vista de detalles (VOD)
        startPlayer(selectedItem, false); // false = NO ES LIVE (es VOD)
    }

    // ================= REPRODUCTOR =================
    function initShaka() {
        shaka.polyfill.installAll();
        if (shaka.Player.isBrowserSupported()) {
            const video = document.getElementById('video');
            player = new shaka.Player(video);
            // No cargamos UI de Shaka por defecto, usaremos la nuestra
            player.addEventListener('error', onErrorEvent);
        }
    }

    async function startPlayer(item, liveMode) {
        isLiveContent = liveMode;
        
        // Ocultar todo lo demás
        document.getElementById('app').style.display = 'none';
        document.getElementById('main-header').style.display = 'none';
        document.getElementById('details-view').style.display = 'none';
        document.getElementById('player-container').style.display = 'block';

        // Configurar UI según modo
        document.getElementById('p-title-display').innerText = item.title;
        const btnPrev = document.getElementById('btn-prev');
        const btnNext = document.getElementById('btn-next');
        
        if (isLiveContent) {
            // MODO LIVE: Ocultar botones de navegar, configurar buffer bajo
            btnPrev.style.display = 'none';
            btnNext.style.display = 'none';
            
            // CONFIGURACIÓN CLAVE PARA EVITAR CIRCULO DE CARGA EN LIVE
            player.configure({
                streaming: {
                    bufferingGoal: 10, // Solo 10s para live (antes 60s)
                    rebufferingGoal: 2, // Reanudar rápido
                    lowLatencyMode: true
                }
            });
        } else {
            // MODO VOD: Buffer alto
            btnPrev.style.display = 'flex';
            btnNext.style.display = 'flex'; // Aquí podrías poner lógica de episodios
            
            player.configure({
                streaming: {
                    bufferingGoal: 60,
                    rebufferingGoal: 5,
                    lowLatencyMode: false
                }
            });
        }

        // Cargar Video
        const video = document.getElementById('video');
        isPlaying = true;
        resetUiTimer();

        try {
            // Check Nativo vs Shaka
            const ext = item.mpd.split('?')[0].split('.').pop().toLowerCase();
            const isNative = ['mp4','mkv','avi','mov'].includes(ext);

            if (isNative) {
                await player.unload();
                video.src = item.mpd;
            } else {
                if(item.drm && item.drm.clearKeys) {
                    player.configure({ drm: { clearKeys: item.drm.clearKeys } });
                } else {
                    player.configure({ drm: {} });
                }
                await player.load(item.mpd);
            }
            video.play();
            document.getElementById('btn-play-center').focus();

        } catch (e) {
            console.error(e);
            alert("Error al reproducir");
            closePlayer();
        }
    }

    function togglePlay() {
        const vid = document.getElementById('video');
        const icon = document.getElementById('icon-play');
        
        if (vid.paused) {
            vid.play();
            icon.innerText = 'pause';
        } else {
            // SI ES LIVE, NO PAUSAMOS REALMENTE EL BUFFER, SOLO EL VIDEO
            // O podemos optar por no hacer nada si quieres bloquear pausa total
            vid.pause();
            icon.innerText = 'play_arrow';
        }
    }

    function closePlayer() {
        const vid = document.getElementById('video');
        vid.pause();
        vid.src = "";
        player.unload();
        document.getElementById('player-container').style.display = 'none';
        isPlaying = false;
        
        // Volver a donde estábamos
        if (document.getElementById('details-view').style.display === 'none') {
            // Estábamos en grid (TV)
            document.getElementById('app').style.display = 'block';
            document.getElementById('main-header').style.display = 'flex';
        } else {
            // Estábamos en detalles (Pelis)
            document.getElementById('details-view').style.display = 'block';
        }
    }

    function resetUiTimer() {
        const ui = document.getElementById('player-ui');
        ui.classList.remove('ui-hidden');
        clearTimeout(uiTimer);
        uiTimer = setTimeout(() => {
            ui.classList.add('ui-hidden');
        }, 4000);
    }

    // Mostrar UI al mover mouse/teclado
    document.getElementById('player-container').addEventListener('mousemove', resetUiTimer);
    document.getElementById('player-container').addEventListener('keydown', resetUiTimer);


    // ================= PARSER M3U (IGUAL QUE ANTES) =================
    async function fetchAndParseContent(provider) {
        try {
            const response = await fetch(provider.url);
            const text = await response.text();
            if (provider.source_type === 'json' || text.trim().startsWith('[')) return JSON.parse(text).map(processJsonItem);

            const lines = text.split('\n');
            const groups = {}; const rootItems = [];
            let currentItem = null;

            for (let line of lines) {
                line = line.trim();
                if (line.startsWith('#EXTINF')) {
                    currentItem = { type: 'stream', drm: {} };
                    const title = line.match(/,(.+)$/);
                    currentItem.title = title ? title[1].trim() : "Canal";
                    const logo = line.match(/tvg-logo="([^"]+)"/);
                    if(logo) currentItem.poster = logo[1];
                    const group = line.match(/group-title="([^"]+)"/);
                    currentItem.group = group ? group[1].trim() : "General";
                } else if (line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                    if (currentItem) {
                        const keys = line.split('=')[1].split(',');
                        const clearKeys = {};
                        keys.forEach(k => { const [id, val] = k.split(':'); if(id&&val) clearKeys[id]=val; });
                        currentItem.drm.clearKeys = clearKeys;
                    }
                } else if (line.startsWith('http')) {
                    if (currentItem) {
                        if (line.includes('|')) {
                            const [url, params] = line.split('|');
                            currentItem.mpd = url;
                            const p = new URLSearchParams(params);
                            const ck = p.get('clearkey');
                            if(ck) { const [id, val] = ck.split(':'); if(id&&val) currentItem.drm.clearKeys = {[id]:val}; }
                        } else { currentItem.mpd = line; }
                        
                        if(currentItem.group) {
                            if(!groups[currentItem.group]) groups[currentItem.group] = [];
                            groups[currentItem.group].push(currentItem);
                        } else rootItems.push(currentItem);
                        currentItem = null;
                    }
                }
            }
            const structure = [];
            for (const [key, val] of Object.entries(groups)) {
                structure.push({ title: key, type: 'folder', children: val, img: val[0]?.poster });
            }
            return [...structure, ...rootItems];
        } catch (e) { console.error(e); return []; }
    }
    
    function processJsonItem(item) {
        return { title: item.title||item.titulo, poster: item.img||item.poster, type: 'stream', mpd: item.mpd||item.url, drm: item.drm||{} };
    }
    function onErrorEvent(e) { console.error("Shaka Error", e); }

    // ================= INPUTS =================
    window.addEventListener('keydown', (e) => {
        const k = e.keyCode;
        
        // BACK
        if ([8, 27, 461, 10009, 4].includes(k)) {
            e.preventDefault();
            if(isPlaying) { closePlayer(); return; }
            if(document.getElementById('details-view').style.display === 'block') { closeDetails(); return; }
            if(goBack()) return;
        }

        // ENTER
        if (k === 13 || k === 23 || k === 66) {
            const act = document.activeElement;
            if(act && act.classList.contains('card')) act.click();
        }

        // FLECHAS
        if ([37,38,39,40].includes(k)) {
            // BLOQUEO EN VIVO: Si es live, flechas izq/der no hacen nada en el player
            if (isPlaying && isLiveContent && (k === 37 || k === 39)) {
                e.preventDefault();
                return; 
            }
            
            // Navegación normal
            if (!isPlaying) {
                e.preventDefault();
                navigateGrid(k);
            }
        }
    });

    function navigateGrid(key) {
        const cards = Array.from(document.querySelectorAll('.card, .btn-large'));
        if (!cards.length) return;
        const cur = document.activeElement;
        const idx = cards.indexOf(cur);
        if (idx === -1) { cards[0].focus(); return; }
        
        let next = idx;
        if(key === 39) next++;
        if(key === 37) next--;
        if(key === 40) next+=4; // Approx cols
        if(key === 38) next-=4;
        
        if(next >= 0 && next < cards.length) cards[next].focus();
    }

</script>
</body>
</html>
