<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reproductor Izzi Pro</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; background: #000; overflow: hidden; }
        #video-container { width: 100%; height: 100%; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #status { position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.7); padding: 10px; font-family: sans-serif; z-index: 10; border-radius: 5px; }
    </style>
</head>
<body>

    <div id="status">Iniciando...</div>
    <div id="video-container">
        <video id="reproductor" autoplay playsinline></video>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const urlMpd = urlParams.get('mpd');
        const rawKeys = urlParams.get('keys');
        const ref = urlParams.get('ref');
        const ori = urlParams.get('ori');
        const ua = urlParams.get('ua');

        // FUNCIÃ“N CLAVE: Convierte Base64 (de la lista) a Hexadecimal (lo que pide el motor)
        function base64ToHex(base64) {
            const raw = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
            let result = '';
            for (let i = 0; i < raw.length; i++) {
                const hex = raw.charCodeAt(i).toString(16);
                result += (hex.length === 2 ? hex : '0' + hex);
            }
            return result.toLowerCase();
        }

        async function initPlayer() {
            const video = document.getElementById('reproductor');
            const player = new shaka.Player(video);
            const status = document.getElementById('status');

            // ConfiguraciÃ³n de Headers (FalsificaciÃ³n de identidad)
            player.getNetworkingEngine().registerRequestFilter((type, request) => {
                if (ref) request.headers['Referer'] = ref;
                if (ori) request.headers['Origin'] = ori;
                // Nota: User-Agent a veces es bloqueado por el navegador en HTTP, pero en App funciona
                request.allowCrossSiteCredentials = true;
            });

            const config = {
                streaming: { bufferingGoal: 15, rebufferingGoal: 2 },
                drm: { clearKeys: {} }
            };

            // PROCESAMIENTO DE LLAVES
            if (rawKeys) {
                try {
                    const keyJson = JSON.parse(rawKeys);
                    if (keyJson.keys) {
                        keyJson.keys.forEach(kObj => {
                            // Convertimos Kid y K de Base64 a el Hexadecimal que me diste
                            const kidHex = base64ToHex(kObj.kid);
                            const keyHex = base64ToHex(kObj.k);
                            config.drm.clearKeys[kidHex] = keyHex;
                            console.log(`ðŸ”‘ Inyectada: ${kidHex}:${keyHex}`);
                        });
                        status.innerText = "Llaves inyectadas correctamente.";
                    }
                } catch (e) {
                    status.innerText = "Error en formato de llaves.";
                }
            }

            player.configure(config);

            try {
                await player.load(urlMpd);
                status.style.display = 'none';
                console.log("Â¡Reproduciendo!");
            } catch (error) {
                console.error("Error Shaka:", error);
                status.innerText = `Error: ${error.code}. Revisa la consola.`;
                if(error.code == 6001) status.innerText = "Error DRM: Llaves invÃ¡lidas o formato incorrecto.";
            }
        }

        document.addEventListener('DOMContentLoaded', initPlayer);
    </script>
</body>
</html>
