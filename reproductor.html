<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reproductor Izzi - Fix CORS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.3.5/shaka-player.compiled.js"></script>
    <style>
        body, html { margin: 0; padding: 0; width: 100vw; height: 100vh; background: #000; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: contain; }
        #status { position: absolute; top: 10px; left: 10px; color: #0f0; font-family: monospace; z-index: 100; background: rgba(0,0,0,0.5); }
    </style>
</head>
<body>
    <div id="status">Iniciando...</div>
    <video id="reproductor" autoplay playsinline></video>

<script>
    const urlParams = new URLSearchParams(window.location.search);
    const mpd = urlParams.get('mpd');
    const rawKeys = urlParams.get('keys');
    const ref = urlParams.get('ref');
    const ori = urlParams.get('ori');

    function base64ToHex(base64) {
        try {
            const raw = atob(base64.replace(/-/g, '+').replace(/_/g, '/'));
            let result = '';
            for (let i = 0; i < raw.length; i++) {
                const hex = raw.charCodeAt(i).toString(16);
                result += (hex.length === 2 ? hex : '0' + hex);
            }
            return result.toLowerCase();
        } catch (e) { return ''; }
    }

    async function init() {
        const video = document.getElementById('reproductor');
        const player = new shaka.Player(video);
        const status = document.getElementById('status');

        // --- SOLUCIÓN AL ERROR 1002 / CORS ---
        player.getNetworkingEngine().registerRequestFilter((type, request) => {
            // 1. Forzamos a que NO incluya credenciales para que el navegador no bloquee el fetch
            request.allowCrossSiteCredentials = false; 

            // 2. Inyectamos los escudos de Izzi
            if (ref) request.headers['Referer'] = ref;
            if (ori) request.headers['Origin'] = ori;
        });

        const config = {
            streaming: { 
                bufferingGoal: 10,
                // Esto ayuda en navegadores con bloqueos estrictos
                dispatchAllEmsgBoxes: true 
            },
            drm: { clearKeys: {} }
        };

        if (rawKeys) {
            try {
                const keyJson = JSON.parse(rawKeys);
                keyJson.keys.forEach(k => {
                    const kid = base64ToHex(k.kid);
                    const key = base64ToHex(k.k);
                    if (kid && key) {
                        config.drm.clearKeys[kid] = key;
                        console.log(`✅ DRM Hex: ${kid}:${key}`);
                    }
                });
            } catch (e) { console.error("Error parseando llaves"); }
        }

        player.configure(config);

        try {
            await player.load(mpd);
            status.style.display = 'none';
        } catch (e) {
            console.error("Error Shaka:", e);
            status.innerHTML = `<span style="color:red">Error ${e.code}: ${e.message}</span>`;
            
            if (e.code === 1002) {
                status.innerHTML += "<br>CORS bloqueó el archivo. Prueba usando una extensión de 'Allow CORS' en Chrome.";
            }
        }
    }

    document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
