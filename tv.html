<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TV en Vivo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    <style>
        body { margin: 0; background: #0f0f0f; color: white; font-family: sans-serif; overflow: hidden; }
        .focusable:focus { outline: 4px solid #00A8E8; transform: scale(1.05); z-index: 100; background: #333; }
        
        #menu { padding: 50px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .card { aspect-ratio: 16/9; background: #222; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-direction: column; }
        .card img { height: 50px; object-fit: contain; margin-bottom: 10px; }
        
        #channels { position: fixed; left: 0; top: 0; bottom: 0; width: 350px; background: rgba(0,0,0,0.95); z-index: 50; transform: translateX(-100%); transition: transform 0.2s; overflow-y: auto; }
        #channels.open { transform: translateX(0); }
        .ch-row { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; gap: 10px; align-items: center; }
        .ch-logo { width: 40px; height: 30px; object-fit: contain; background: black; }
        
        #player { position: fixed; inset: 0; background: black; z-index: 0; display: none; }
        video { width: 100%; height: 100%; }
        
        #loading { position: fixed; top: 20px; right: 20px; background: #00A8E8; padding: 5px; border-radius: 4px; display: none; z-index: 999; color: black; }
    </style>
</head>
<body>

    <div id="loading">Cargando...</div>

    <div id="menu">
        </div>

    <div id="channels"></div>

    <div id="player"><video id="video" autoplay></video></div>

<script>
    const PROVS = [
        { title: 'IZZI TV', url: 'https://dl.dropboxusercontent.com/scl/fi/9y6dlas2jujl5tlsmrgse/IZZI.m3u?rlkey=qmbog8h21oha6upqxr0y54o2o&st=lgx3ekfe&dl=1', img: 'https://i.imgur.com/LOGO_IZZI.png' },
        { title: 'DISH', url: 'https://dl.dropboxusercontent.com/s/8vkt6055ift44x9yd5gm8/DISH.m3u?rlkey=66ltvgj7q8lsw352j5gvvm4ri&dl=1', img: 'https://i.imgur.com/LOGO_DISH.png' },
        { title: 'DIRECTV', url: 'https://dl.dropboxusercontent.com/s/avcnlb0d4bjrftmvzyau1/DTVGO.m3u?rlkey=xastr4qmw5e47772el989a0p5&dl=1', img: 'https://i.imgur.com/LOGO_DIRECTV.png' }
        // Agrega los demás aquí...
    ];

    let player;
    let currentList = [];

    window.onload = () => {
        shaka.polyfill.installAll();
        if(shaka.Player.isBrowserSupported()) player = new shaka.Player(document.getElementById('video'));
        
        const menu = document.getElementById('menu');
        PROVS.forEach(p => {
            const c = document.createElement('div');
            c.className = 'card focusable';
            c.tabIndex = 0;
            c.innerHTML = `<img src="${p.img}"><b>${p.title}</b>`;
            c.onclick = () => loadProvider(p.url);
            menu.appendChild(c);
        });
        document.querySelector('.card').focus();
    };

    async function loadProvider(url) {
        document.getElementById('loading').style.display = 'block';
        try {
            const res = await fetch(url);
            const text = await res.text();
            parseM3U(text);
            document.getElementById('menu').style.display = 'none';
            renderChannels();
        } catch(e) { alert("Error al cargar lista"); }
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    function parseM3U(text) {
        const lines = text.split('\n');
        currentList = [];
        let curr = null;
        for(let line of lines) {
            line = line.trim();
            if(line.startsWith('#EXTINF')) {
                curr = { drm: {} };
                const parts = line.split(',');
                curr.title = parts[parts.length-1];
                const logo = line.match(/tvg-logo="([^"]+)"/);
                curr.logo = logo ? logo[1] : '';
            } else if(line.startsWith('#KODIPROP:inputstream.adaptive.license_key=')) {
                if(curr) {
                    const k = line.split('=')[1].split(':');
                    curr.drm.clearKeys = { [k[0]]: k[1] };
                }
            } else if(line.startsWith('http')) {
                if(curr) {
                    curr.url = line.split('|')[0];
                    currentList.push(curr);
                    curr = null;
                }
            }
        }
    }

    function renderChannels() {
        const list = document.getElementById('channels');
        list.innerHTML = '';
        list.classList.add('open');
        currentList.forEach(ch => {
            const row = document.createElement('div');
            row.className = 'ch-row focusable';
            row.tabIndex = 0;
            row.innerHTML = `<img src="${ch.logo}" class="ch-logo"> ${ch.title}`;
            row.onclick = () => playChannel(ch);
            list.appendChild(row);
        });
        setTimeout(()=>document.querySelector('.ch-row').focus(), 100);
    }

    async function playChannel(ch) {
        document.getElementById('channels').classList.remove('open');
        document.getElementById('player').style.display = 'block';
        try {
            await player.unload();
            if(ch.drm.clearKeys) player.configure({drm:{clearKeys:ch.drm.clearKeys}});
            await player.load(ch.url);
        } catch(e) { console.log(e); }
    }

    window.addEventListener('keydown', e => {
        if(e.keyCode===8 || e.keyCode===27) { // BACK
            if(document.getElementById('player').style.display==='block') {
                document.getElementById('channels').classList.add('open');
                document.querySelector('.ch-row').focus();
                return;
            }
            if(document.getElementById('channels').classList.contains('open')) {
                document.getElementById('channels').classList.remove('open');
                document.getElementById('menu').style.display='grid';
                document.querySelector('.card').focus();
                return;
            }
            window.location.href = 'index.html';
        }
        if(e.keyCode===13) document.activeElement.click();
        if([38,40].includes(e.keyCode)) {
            e.preventDefault();
            const items = Array.from(document.querySelectorAll('.focusable')); // visibles
            const idx = items.indexOf(document.activeElement);
            if(e.keyCode===40) items[idx+1]?.focus();
            if(e.keyCode===38) items[idx-1]?.focus();
        }
    });
</script>
</body>
</html>
