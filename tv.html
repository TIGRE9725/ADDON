<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>TV en Vivo</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        /* ESTILO TIVIMATE */
        body { margin: 0; background: #000; color: #eee; font-family: sans-serif; overflow: hidden; }
        .focusable:focus { outline: 4px solid #00A8E8; background: #333; transform: scale(1.05); z-index: 100; }
        
        #menu { padding: 50px; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .prov-card { aspect-ratio: 16/9; background: #1a1a1a; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 2px solid transparent; }
        .prov-card img { height: 50px; object-fit: contain; margin-bottom: 10px; }
        
        #ui-layer { position: fixed; inset: 0; display: none; grid-template-columns: 350px 1fr; z-index: 50; }
        .ch-list { background: rgba(15,15,15,0.95); overflow-y: auto; border-right: 1px solid #333; }
        .ch-item { padding: 12px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .ch-item:focus { background: #00A8E8; color: black; font-weight: bold; }
        .ch-logo { width: 40px; height: 30px; object-fit: contain; background: black; }
        
        .info-bar { position: absolute; bottom: 0; left: 350px; right: 0; height: 180px; background: linear-gradient(to top, rgba(0,0,0,0.95), transparent); padding: 20px 40px; display: flex; flex-direction: column; justify-content: flex-end; pointer-events: none; }
        .prog-title { font-size: 2rem; font-weight: bold; margin-bottom: 5px; text-shadow: 2px 2px 4px black; }
        .prog-meta { color: #00A8E8; font-weight: bold; margin-bottom: 10px; text-shadow: 1px 1px 2px black; }
        
        #player-container { position: fixed; inset: 0; background: black; z-index: 0; display: none; }
        #video { width: 100%; height: 100%; }
        #loading { position: fixed; top: 20px; right: 20px; background: #00A8E8; color: black; padding: 5px 15px; border-radius: 4px; display: none; z-index: 9999; font-weight: bold; }
    </style>
</head>
<body>

    <div id="loading">Cargando...</div>

    <div id="menu"></div>

    <div id="ui-layer">
        <div class="ch-list" id="channel-list"></div>
        <div class="info-bar">
            <div class="prog-title" id="lbl-title">Canal</div>
            <div class="prog-meta" id="lbl-meta">En Vivo</div>
        </div>
    </div>

    <div id="player-container"><video id="video" autoplay></video></div>

<script>
    // TUS ENLACES REALES (TV)
    const PROVS = [
        { title: 'IZZI TV', url: 'https://dl.dropboxusercontent.com/scl/fi/9y6dlas2jujl5tlsmrgse/IZZI.m3u?rlkey=qmbog8h21oha6upqxr0y54o2o&st=lgx3ekfe&dl=0', epg: 'https://raw.githubusercontent.com/TIGRE9725/guia/main/guia_izzi.xml', img: 'https://i.imgur.com/LOGO_IZZI.png' },
        { title: 'DISH', url: 'https://dl.dropboxusercontent.com/s/8vkt6055ift44x9yd5gm8/DISH.m3u?rlkey=66ltvgj7q8lsw352j5gvvm4ri', epg: 'https://raw.githubusercontent.com/TIGRE9725/guia/main/guia_dish.xml', img: 'https://i.imgur.com/LOGO_DISH.png' },
        { title: 'STARTV', url: 'https://dl.dropboxusercontent.com/s/vnmo8y2l2z25dpzkv52hl/STARTV.m3u?rlkey=d3oj0vqgldbnmuqf30qaeqqti', epg: 'https://raw.githubusercontent.com/TIGRE9725/guia/main/guia_startv.xml', img: 'https://i.imgur.com/LOGO_STARTV.png' },
        { title: 'DIRECTV', url: 'https://dl.dropboxusercontent.com/s/avcnlb0d4bjrftmvzyau1/DTVGO.m3u?rlkey=xastr4qmw5e47772el989a0p5', img: 'https://i.imgur.com/LOGO_DIRECTV.png' },
        { title: 'CLARO', url: 'https://dl.dropboxusercontent.com/s/eh5mm29jasa9y2gesiih0/CLAROTV.m3u?rlkey=eqn05qohgj10vbsa7279ij5qh', epg: 'https://raw.githubusercontent.com/TIGRE9725/guia/main/guia_claro.xml', img: 'https://i.imgur.com/LOGO_CLARO.png' },
        { title: 'AMAZON', url: 'https://dl.dropboxusercontent.com/s/agoem2v71esupgmbj1gck/AMAZON.m3u?rlkey=7tzh7zpan9quxz7l019sgndnh', img: 'https://i.imgur.com/LOGO_AMAZON.png' },
        { title: 'SENSA', url: 'https://dl.dropboxusercontent.com/s/dv2o6zl6zaekmenag4xkg/ARG.m3u?rlkey=hj1u6yyshizmco48qkrbhkyft', img: 'https://i.imgur.com/LOGO_SENSA.png' },
        { title: 'INTERNET', url: 'https://dl.dropboxusercontent.com/s/q7xiqcsb8ymwo0g/MX-TPLAY.m3u?dl=0', img: 'https://i.imgur.com/LOGO_INTERNET.png' }
    ];

    let player;
    let currentList = [];
    let EPG = {};

    window.onload = () => {
        initShaka();
        const menu = document.getElementById('menu');
        PROVS.forEach(p => {
            const c = document.createElement('div');
            c.className = 'prov-card focusable';
            c.tabIndex = 0;
            c.innerHTML = `<img src="${p.img}"><b>${p.title}</b>`;
            c.onclick = () => loadProvider(p);
            menu.appendChild(c);
        });
        setTimeout(()=>document.querySelector('.prov-card')?.focus(), 100);
    };

    async function loadProvider(p) {
        document.getElementById('loading').style.display = 'block';
        try {
            const [m3uData, epgData] = await Promise.all([
                fetch(p.url).then(r=>r.text()),
                p.epg ? fetch(p.epg).then(r=>r.text()) : Promise.resolve(null)
            ]);
            
            parseM3U(m3uData);
            if(epgData) parseEPG(epgData);
            
            document.getElementById('menu').style.display = 'none';
            document.getElementById('ui-layer').style.display = 'grid';
            renderChannels();
        } catch(e){}
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    function parseM3U(text) {
        currentList = [];
        const lines = text.split('\n');
        let curr = null;
        for(let l of lines) {
            l = l.trim();
            if(l.startsWith('#EXTINF')) {
                curr = { drm: {} };
                const logo = l.match(/tvg-logo="([^"]+)"/);
                curr.logo = logo ? logo[1] : '';
                const tvgid = l.match(/tvg-id="([^"]+)"/);
                curr.tvgid = tvgid ? tvgid[1] : null;
                curr.title = l.split(',')[1];
            } else if(l.startsWith('#KODIPROP')) {
                if(curr) {
                    const keys = l.split('=')[1].split(',');
                    const ck = {};
                    keys.forEach(k => { const p=k.split(':'); if(p[0]&&p[1]) ck[p[0]]=p[1]; });
                    curr.drm.clearKeys = ck;
                }
            } else if(l.startsWith('http')) {
                if(curr) { curr.url = l; currentList.push(curr); curr = null; }
            }
        }
    }

    function parseEPG(xml) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(xml, "text/xml");
        EPG = {};
        doc.querySelectorAll('programme').forEach(p => {
            const id = p.getAttribute('channel');
            if(!EPG[id]) EPG[id] = [];
            EPG[id].push({
                title: p.querySelector('title')?.textContent,
                start: parseDate(p.getAttribute('start')),
                end: parseDate(p.getAttribute('stop'))
            });
        });
    }

    function parseDate(s) {
        const y=s.substr(0,4), m=s.substr(4,2), d=s.substr(6,2), h=s.substr(8,2), min=s.substr(10,2);
        return new Date(`${y}-${m}-${d}T${h}:${min}:00`).getTime()/1000;
    }

    function renderChannels() {
        const list = document.getElementById('channel-list');
        list.innerHTML = '';
        currentList.forEach(ch => {
            const row = document.createElement('div');
            row.className = 'ch-item focusable';
            row.tabIndex = 0;
            row.innerHTML = `<img src="${ch.logo}" class="ch-logo"> ${ch.title}`;
            row.onclick = () => playChannel(ch);
            row.onfocus = () => updateInfo(ch);
            list.appendChild(row);
        });
        setTimeout(()=>document.querySelector('.ch-item')?.focus(), 100);
    }

    function updateInfo(ch) {
        document.getElementById('lbl-title').innerText = ch.title;
        let info = "En Vivo";
        if(ch.tvgid && EPG[ch.tvgid]) {
            const now = Date.now()/1000;
            const prog = EPG[ch.tvgid].find(p => p.start <= now && p.end > now);
            if(prog) info = prog.title;
        }
        document.getElementById('lbl-meta').innerText = info;
    }

    function initShaka() {
        shaka.polyfill.installAll();
        if(shaka.Player.isBrowserSupported()) player = new shaka.Player(document.getElementById('video'));
    }

    async function playChannel(ch) {
        document.getElementById('ui-layer').style.display = 'none';
        document.getElementById('player-container').style.display = 'block';
        try {
            await player.unload();
            if(ch.drm.clearKeys) player.configure({drm:{clearKeys:ch.drm.clearKeys}});
            else player.configure({drm:{}});
            await player.load(ch.url);
            document.getElementById('video').play();
        } catch(e){}
    }

    window.addEventListener('keydown', e => {
        if(e.keyCode===8 || e.keyCode===27 || e.keyCode===461) {
            if(document.getElementById('player-container').style.display==='block') {
                document.getElementById('player-container').style.display='none';
                document.getElementById('ui-layer').style.display='grid';
                document.querySelector('.ch-item').focus();
            } else window.location.href='index.html';
        }
        if(e.keyCode===13 || e.keyCode===23) document.activeElement.click();
        if([38,40].includes(e.keyCode)) {
            e.preventDefault();
            const items = Array.from(document.querySelectorAll('.focusable'));
            const idx = items.indexOf(document.activeElement);
            if(e.keyCode===40) items[idx+1]?.focus();
            if(e.keyCode===38) items[idx-1]?.focus();
        }
    });
</script>
</body>
</html>
