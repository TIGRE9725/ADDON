<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Series</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <style>
        /* ... (Usa el bloque <style> completo de peliculas.html) ... */
        :root { --primary: #E50914; --bg: #000000; --key-bg: #222; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; user-select: none; }
        .focusable:focus { outline: none; border: 3px solid white !important; transform: scale(1.05); box-shadow: 0 0 20px rgba(0,0,0,0.9); z-index: 9999; background-color: rgba(255,255,255,0.2); }
        header { position: fixed; top: 0; width: 100%; height: 60px; z-index: 100; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent); display: flex; align-items: center; justify-content: space-between; padding: 0 4%; box-sizing: border-box; }
        .nav-left { display: flex; align-items: center; gap: 20px; }
        .logo { color: #FFD700; font-size: 24px; font-weight: 900; margin-right: 10px; text-shadow: 2px 2px 4px black; }
        .search-btn-header { background: rgba(255,255,255,0.1); border: 2px solid transparent; color: white; padding: 8px 12px; border-radius: 4px; cursor: pointer; }
        #app { padding-top: 80px; height: 100vh; overflow-y: auto; padding-bottom: 50px; box-sizing: border-box; }
        .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 20px 4%; }
        .card { min-width: 140px; height: 210px; background: #222; border-radius: 6px; cursor: pointer; position: relative; overflow: hidden; transition: transform 0.2s; border: 3px solid transparent; display: flex; align-items: center; justify-content: center; }
        .card-fallback-title { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; text-align: center; padding: 10px; font-size: 0.9rem; font-weight: bold; color: #aaa; z-index: 0; word-wrap: break-word; }
        .card img { width: 100%; height: 100%; object-fit: cover; position: relative; z-index: 10; background: #222; }
        .progress-track { position: absolute; bottom: 0; left: 0; right: 0; height: 4px; background: rgba(255,255,255,0.3); z-index: 20; display: none; }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; }
        
        /* SEARCH (Igual que peliculas) */
        #search-interface { position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #000; z-index: 2000; display: none; padding: 80px 4% 20px 4%; box-sizing: border-box; }
        .search-container { display: flex; height: 100%; gap: 30px; }
        .keyboard-panel { flex: 0 0 320px; display: flex; flex-direction: column; }
        .search-display-area { margin-bottom: 20px; }
        .search-instruction { color: #888; font-size: 0.9rem; margin-bottom: 5px; }
        .search-input-display { font-size: 2rem; color: white; border-bottom: 2px solid var(--primary); padding-bottom: 10px; min-height: 40px; font-weight: bold; }
        .keyboard-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; justify-items: center; }
        .key-btn { width: 45px; height: 45px; background: var(--key-bg); color: #ddd; border: 2px solid transparent; border-radius: 50%; font-size: 1rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .key-btn.wide { grid-column: span 2; width: auto; padding: 0 20px; border-radius: 30px; }
        .key-btn.action { background: #333; }
        .results-panel { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .results-header { color: #888; margin-bottom: 15px; font-size: 1.1rem; }
        #search-results-grid { padding: 10px; overflow-y: auto; height: 100%; display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); grid-auto-rows: 150px; gap: 10px; align-content: start; }
        #search-results-grid .card { min-width: auto; height: 100%; width: 100%; }

        /* DETAILS */
        #details-view { position: fixed; inset: 0; background: var(--bg); z-index: 200; display: none; overflow-x: hidden; overflow-y: auto; }
        .details-hero { position: absolute; inset: 0; width: 100%; height: 100%; background-size: cover; background-position: center top; mask-image: linear-gradient(to bottom, black 50%, transparent 100%); -webkit-mask-image: linear-gradient(to bottom, black 50%, transparent 100%); }
        .hero-gradient { position: absolute; inset: 0; }
        .details-content { position: absolute; top: 1%; left: 5%; width: 90%; z-index: 10; display: flex; flex-direction: column; bottom: 240px; justify-content: flex-start; }
        .details-title { font-size: 3rem; font-weight: 900; margin-bottom: 5px; text-shadow: 2px 2px 10px black; line-height: 1; }
        .details-desc { font-size: 1rem; line-height: 1.4; color: #ddd; margin-bottom: 20px; overflow: hidden; text-overflow: ellipsis; display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; text-shadow: 1px 1px 2px black; }
        .action-row { display: flex; gap: 15px; margin-bottom: 5px; flex-wrap: wrap; }
        .btn-large { padding: 10px 25px; font-size: 1rem; font-weight: bold; border-radius: 4px; border: none; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .btn-primary { background: white; color: black; }
        .btn-secondary { background: rgba(100, 100, 100, 0.6); color: white; }

        /* SERIES SPECIFIC */
        #series-container { position: absolute; bottom: 20px; left: 5%; right: 5%; z-index: 20; background: transparent; }
        .season-header { display: flex; align-items: center; gap: 15px; margin-bottom: 10px; }
        .season-selector { background: #333; color: white; border: 2px solid #555; padding: 12px 30px; border-radius: 4px; font-size: 1.1rem; font-weight: bold; cursor: pointer; min-width: 220px; }
        .episode-scroller { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; scroll-behavior: smooth; }
        .episode-scroller::-webkit-scrollbar { height: 0; }
        .episode-card { min-width: 220px; max-width: 220px; background: rgba(30,30,30,0.8); border-radius: 6px; overflow: hidden; cursor: pointer; border: 3px solid transparent; transition: transform 0.2s; display: flex; flex-direction: column; position: relative; }
        .episode-card:hover, .episode-card:focus { transform: scale(1.05); border-color: white; background: #333; z-index: 50; }
        .ep-thumb { width: 100%; height: 125px; object-fit: cover; }
        .ep-info { padding: 10px; }
        .ep-title { font-size: 0.9rem; font-weight: bold; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* PLAYER */
        #player-container { position: fixed; inset: 0; background: black; z-index: 5000; display: none; }
        #video { width: 100%; height: 100%; }
        .player-ui { position: absolute; inset: 0; display: flex; flex-direction: column; justify-content: space-between; background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 25%, transparent 75%, rgba(0,0,0,0.9) 100%); transition: opacity 0.3s ease; z-index: 99999 !important; pointer-events: none; }
        .ui-fade-out { opacity: 0 !important; pointer-events: none; }
        .p-header { display: flex; justify-content: space-between; align-items: flex-start; padding: 30px; position: relative; }
        .btn-back-p { width: 60px; height: 60px; border-radius: 50%; background: rgba(255,255,255,0.15); color: white; border: 2px solid transparent; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 100000; pointer-events: auto !important; }
        .p-clock { font-size: 1.5rem; font-weight: bold; color: #ccc; text-shadow: 2px 2px 4px black; position: absolute; left: 50%; top: 40px; transform: translateX(-50%); z-index: 1; }
        .p-meta { text-align: right; text-shadow: 1px 1px 3px black; max-width: 40%; z-index: 2; }
        .p-controls-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; gap: 40px; align-items: center; pointer-events: none; }
        .ctrl-btn { width: 70px; height: 70px; border-radius: 50%; background: rgba(0,0,0,0.6); color: white; border: 3px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; pointer-events: auto !important; }
        .ctrl-btn:focus { background: var(--primary); border-color: white; transform: scale(1.15); }
        .shaka-controls-container .focusable:focus { outline: none !important; border: 2px solid var(--primary) !important; background-color: rgba(255, 255, 255, 0.2); transform: scale(1.1); }
    </style>
</head>
<body>

    <header id="main-header">
        <div class="nav-left">
            <div class="logo">SERIES</div>
        </div>
        <button class="search-btn-header focusable" onclick="openSearchInterface()">
            <span class="material-icons-round">search</span>
        </button>
    </header>

    <div id="app">
        <h2 style="text-align:center; margin-top:100px; color:#777;" id="loading-msg">Cargando Series...</h2>
        <div id="content-grid" class="grid-view"></div>
    </div>

    <div id="search-interface">
        <div class="search-container">
            <div class="keyboard-panel">
                <div class="search-display-area">
                    <div class="search-instruction">Escribe para buscar...</div>
                    <div id="virtual-input-display" class="search-input-display"></div>
                </div>
                <div id="keyboard-grid" class="keyboard-grid"></div>
            </div>
            <div class="results-panel">
                <div class="results-header" id="results-count-text">Resultados</div>
                <div id="search-results-grid"></div>
            </div>
        </div>
    </div>

    <div id="details-view">
        <div class="details-hero" id="det-hero"></div>
        <div class="hero-gradient"></div>
        <div class="details-content">
            <h1 class="details-title" id="det-title">TITULO</h1>
            <p class="details-desc" id="det-desc">Descripción...</p>
            <div class="action-row">
                <button id="btn-play-hero" class="btn-large btn-primary focusable">
                    <span class="material-icons-round">play_arrow</span> <span id="play-text">Reproducir</span>
                </button>
                <button id="btn-back-details" class="btn-large btn-secondary focusable" onclick="closeDetails()">
                    <span class="material-icons-round">arrow_back</span> Volver
                </button>
            </div>
        </div>
        <div id="series-container">
            <div class="season-header">
                <select id="season-select" class="season-selector focusable"></select>
                <h3 style="margin:0;">Episodios</h3>
            </div>
            <div id="episodes-list" class="episode-scroller"></div>
        </div>
    </div>

    <div id="player-container">
        <video id="video" autoplay></video>
        <div id="player-ui" class="player-ui">
            <div class="p-header">
                <button id="btn-back-player" class="btn-back-p focusable"><span class="material-icons-round">arrow_back</span></button>
                <div class="p-clock" id="p-clock">00:00</div>
                <div class="p-meta"><h2 id="p-title">Título</h2></div>
            </div>
            <div class="p-controls-center">
                <button id="btn-prev" class="ctrl-btn focusable" onclick="changeEpisode(-1)"><span class="material-icons-round">skip_previous</span></button>
                <button id="btn-play-center" class="ctrl-btn focusable" onclick="togglePlay()"><span class="material-icons-round" id="icon-play">pause</span></button>
                <button id="btn-next" class="ctrl-btn focusable" onclick="changeEpisode(1)"><span class="material-icons-round">skip_next</span></button>
            </div>
            <div style="height: 50px;"></div>
        </div>
    </div>

    <div id="error-modal" class="error-modal">
        <h3 style="color:#ff5555; margin-top:0">Error</h3>
        <p id="error-msg">...</p>
        <button class="btn-primary focusable" onclick="document.getElementById('error-modal').style.display='none'; exitPlayer()">Cerrar</button>
    </div>

<script>
    // CONFIGURACIÓN DE SERIES
    const SOURCES = [
        { url: 'https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1', type: 'json' },
        { url: 'https://raw.githubusercontent.com/TIGRE9725/PELIS/main/netvideo.series.m3u', type: 'm3u' },
        { url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/playlist_series.m3u', type: 'm3u' },
        { url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_server_series.m3u', type: 'm3u' },
        { url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_dyndns_series.m3u', type: 'm3u' }
    ];

    let catalog = [];
    let currentView = 'home';
    let currentItem = null;
    let player = null;
    let uiTimer = null;
    let clockInterval = null;
    let currentSeasonIdx = 0;
    let currentEpIdx = 0;
    const DEFAULT_IMG = "https://via.placeholder.com/300x450/333333/FFFFFF?text=Sin+Imagen";
    let searchString = "";
    
    const KEYMAP = { LEFT:[37], UP:[38], RIGHT:[39], DOWN:[40], ENTER:[13,23,66], BACK:[8,461,10009,27,4], PLAY:[415,19,85,179,126], PAUSE:[19,85,179,127], STOP:[413,86], REWIND:[412,89], FAST_FWD:[417,90], PREV:[177,88], NEXT:[176,87] };
    const KEYBOARD_LAYOUT = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","1","2","3","4","5","6","7","8","9","0","SPACE","DEL","VOLVER"];

    window.addEventListener('keydown', handleRemote, true);
    window.onload = async () => {
        initShaka();
        generateKeyboard();
        document.getElementById('btn-back-player').onclick = exitPlayer;
        
        const grid = document.getElementById('content-grid');
        for(const src of SOURCES) {
            try {
                const res = await fetch(src.url);
                const text = await res.text();
                let items = [];
                // Parser M3U simple para series
                if(src.type==='m3u' || text.trim().startsWith('#')) items = parseM3USeries(text);
                else items = JSON.parse(text);
                
                items.forEach(item => {
                    const processed = processItem(item);
                    if(processed.type === 'series') {
                        catalog.push(processed);
                        grid.insertAdjacentHTML('beforeend', cardHtml(processed));
                    }
                });
            } catch(e){}
        }
        document.getElementById('loading-msg').style.display = 'none';
        setTimeout(() => { const el = document.querySelector('.card'); if(el) el.focus(); }, 200);
    };

    function parseM3USeries(text) {
        // Agrupa por group-title para formar series
        const lines = text.split('\n');
        const groups = {};
        let curr = null;
        for(let l of lines) {
            l = l.trim();
            if(l.startsWith('#EXTINF')) {
                curr = { drm: {} };
                const logo = l.match(/tvg-logo="([^"]+)"/);
                const grp = l.match(/group-title="([^"]+)"/);
                curr.poster = logo ? logo[1] : '';
                curr.group = grp ? grp[1] : "Otras Series";
                curr.title = l.split(',')[1];
            } else if(l.startsWith('#KODIPROP')) {
                if(curr) {
                    const keys = l.split('=')[1].split(',');
                    const ck = {};
                    keys.forEach(k => { const p=k.split(':'); if(p[0]&&p[1]) ck[p[0]]=p[1]; });
                    curr.drm.clearKeys = ck;
                }
            } else if(l.startsWith('http')) {
                if(curr) {
                    curr.url = l;
                    if(!groups[curr.group]) groups[curr.group] = { title: curr.group, poster: curr.poster, seasons: [{ num: 1, episodes: [] }] };
                    // Usar logo del episodio si la serie no tiene
                    if(!groups[curr.group].poster && curr.poster) groups[curr.group].poster = curr.poster;
                    groups[curr.group].seasons[0].episodes.push(curr);
                    curr = null;
                }
            }
        }
        return Object.values(groups);
    }

    function processItem(item) {
        let type = 'movie'; 
        if (item.estaciones || item.seasons || item.tipo?.includes('serie')) type = 'series';
        if (!type === 'series') return {type:'movie'}; // Ignorar pelis

        // Normalizar estaciones
        let seasons = [];
        if(item.estaciones) seasons = item.estaciones.map((s,i)=>({num:s.numero||i+1, episodes:s.episodios||s.episodes}));
        else if(item.seasons) seasons = item.seasons;

        return {
            id: item.id || Math.random().toString(36),
            title: item.title || item.titulo,
            desc: item.sinopsis || item.description || "Sin descripción.",
            poster: item.poster || item.img || DEFAULT_IMG,
            hero: item.backdrop || item.poster || item.img || DEFAULT_IMG,
            type: 'series',
            seasons: seasons
        };
    }

    function cardHtml(item) {
        const p = getProgress(item.id);
        const bar = p.pct > 0 ? `<div class="progress-track" style="display:block"><div class="progress-fill" style="width:${p.pct}%"></div></div>` : '';
        return `<div class="card focusable" tabindex="0" onclick="openDetails('${item.id}')" data-id="${item.id}">
                <div class="card-fallback-title">${item.title}</div>
                <img src="${item.poster}" loading="lazy" onerror="this.style.display='none'">
                ${bar}</div>`;
    }

    function openDetails(id) {
        const item = catalog.find(x => x.id === id);
        if(!item) return;
        currentItem = item; currentView = 'details';
        document.getElementById('app').style.display = 'none'; document.getElementById('main-header').style.display = 'none'; document.getElementById('search-interface').style.display = 'none';
        document.getElementById('details-view').style.display = 'block';
        
        document.getElementById('det-hero').style.backgroundImage = `url('${item.hero}')`;
        document.getElementById('det-title').innerText = item.title;
        document.getElementById('det-desc').innerText = item.desc;
        
        // Cargar Temporadas
        const sel = document.getElementById('season-select'); sel.innerHTML = '';
        item.seasons.forEach((s, idx) => { sel.innerHTML += `<option value="${idx}">Temporada ${s.num}</option>`; });
        sel.onchange = () => renderEpisodes(item, sel.value);
        
        // Recuperar progreso (último episodio visto)
        let defIdx = 0; const last = localStorage.getItem('last_seen_' + item.id);
        if(last) { const l = JSON.parse(last); defIdx = parseInt(l.s); }
        sel.value = defIdx; renderEpisodes(item, defIdx);
        
        const btnPlay = document.getElementById('btn-play-hero');
        const txtPlay = document.getElementById('play-text');
        
        // Lógica botón Play (reproducir siguiente episodio no visto)
        let nextE = last ? JSON.parse(last).e : 0;
        txtPlay.innerText = `Reproducir T${item.seasons[defIdx].num} E${nextE+1}`;
        btnPlay.onclick = () => playEpisode(defIdx, nextE);
        
        setTimeout(() => btnPlay.focus(), 100);
    }

    function renderEpisodes(item, sIdx) {
        const list = document.getElementById('episodes-list'); list.innerHTML = '';
        item.seasons[sIdx].episodes.forEach((ep, idx) => {
            const p = getProgress(getEpId(item.id, sIdx, idx));
            const bar = p.pct > 0 ? `<div class="progress-track" style="display:block"><div class="progress-fill" style="width:${p.pct}%"></div></div>` : '';
            const div = document.createElement('div'); div.className = 'episode-card focusable'; div.tabIndex = 0; div.onclick = () => playEpisode(sIdx, idx);
            div.innerHTML = `<img src="${ep.img || item.poster}" class="ep-thumb" onerror="this.src='${DEFAULT_IMG}'">${bar}<div class="ep-info"><div class="ep-title">${idx+1}. ${ep.title||'Episodio '+(idx+1)}</div></div>`;
            list.appendChild(div);
        });
    }

    function closeDetails() {
        document.getElementById('details-view').style.display = 'none';
        document.getElementById('app').style.display = 'block';
        document.getElementById('main-header').style.display = 'flex';
        currentView = 'home';
        setTimeout(() => document.querySelector(`.card[data-id="${currentItem.id}"]`).focus(), 100);
    }

    async function playEpisode(sIdx, eIdx) {
        currentSeasonIdx = parseInt(sIdx); currentEpIdx = parseInt(eIdx);
        const ep = currentItem.seasons[sIdx].episodes[eIdx];
        if (ep) startPlayer(ep.url || ep.mpd, ep.drm, `T${currentItem.seasons[sIdx].num} E${eIdx+1}: ${ep.title||''}`);
    }

    function changeEpisode(dir) {
        let newEp = currentEpIdx + dir, newSe = currentSeasonIdx;
        if (dir === 1 && newEp >= currentItem.seasons[newSe].episodes.length) { newSe++; newEp = 0; }
        else if (dir === -1 && newEp < 0) { newSe--; if(newSe>=0) newEp = currentItem.seasons[newSe].episodes.length-1; else return; }
        if(newSe>=0 && newSe<currentItem.seasons.length) playEpisode(newSe, newEp); else exitPlayer();
    }

    function initShaka() {
        shaka.polyfill.installAll();
        if (shaka.Player.isBrowserSupported()) {
            player = new shaka.Player(document.getElementById('video'));
            player.configure({ streaming: { bufferingGoal: 60, rebufferingGoal: 5 } });
            const ui = new shaka.ui.Overlay(player, document.getElementById('player-container'), document.getElementById('video'));
            ui.configure({ controlPanelElements: ['time_and_duration', 'spacer', 'mute', 'fullscreen'] });
            player.addEventListener('error', onError);
            document.getElementById('video').addEventListener('timeupdate', () => {
                if(!document.getElementById('video').paused && currentItem) {
                    const saveId = getEpId(currentItem.id, currentSeasonIdx, currentEpIdx);
                    localStorage.setItem('last_seen_' + currentItem.id, JSON.stringify({ s: currentSeasonIdx, e: currentEpIdx }));
                    saveProgress(saveId, document.getElementById('video').currentTime, document.getElementById('video').duration);
                }
            });
            document.getElementById('video').addEventListener('ended', () => changeEpisode(1));
        }
    }

    async function startPlayer(mpd, drm, title) {
        document.getElementById('player-container').style.display = 'block';
        currentView = 'player';
        document.getElementById('p-title').innerText = title;
        updateClock(); clockInterval = setInterval(updateClock, 60000);
        try {
            await player.load(mpd);
            if(drm?.clearKeys) player.configure({drm:{clearKeys:drm.clearKeys}});
            document.getElementById('video').play();
            const id = getEpId(currentItem.id, currentSeasonIdx, currentEpIdx);
            const saved = getProgress(id);
            if(saved.pct > 1 && saved.pct < 98) document.getElementById('video').currentTime = saved.time;
            setTimeout(() => { document.getElementById('btn-play-center').focus(); resetUiTimer(); }, 500);
        } catch(e) { onError(e); }
    }

    function exitPlayer() {
        document.getElementById('video').pause(); player.unload(); clearInterval(clockInterval);
        document.getElementById('player-container').style.display = 'none';
        openDetails(currentItem.id);
    }

    // UTILS
    function togglePlay() { const v = document.getElementById('video'); v.paused ? v.play() : v.pause(); resetUiTimer(); }
    function resetUiTimer() { 
        const ui = document.getElementById('player-ui'); ui.classList.remove('ui-fade-out'); clearTimeout(uiTimer);
        if(!document.getElementById('video').paused) uiTimer = setTimeout(()=>ui.classList.add('ui-fade-out'), 3500);
    }
    function updateClock() { document.getElementById('p-clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }
    function onError(e) { console.log(e); }
    function getEpId(itemId, sIdx, eIdx) { return `${itemId}_s${sIdx}e${eIdx}`; }
    function saveProgress(id,t,d) { localStorage.setItem('prog_'+id, JSON.stringify({time:t, pct:(t/d)*100})); }
    function getProgress(id) { const d = localStorage.getItem('prog_'+id); return d ? JSON.parse(d) : {pct:0}; }

    // --- SEARCH ---
    function openSearchInterface() {
        currentView = 'search'; document.getElementById('app').style.display = 'none'; document.getElementById('search-interface').style.display = 'block';
        searchString = ""; document.getElementById('virtual-input-display').innerText = ""; document.getElementById('search-results-grid').innerHTML = "";
        setTimeout(() => document.querySelector('.key-btn').focus(), 100);
    }
    function closeSearchInterface() {
        document.getElementById('search-interface').style.display = 'none'; document.getElementById('app').style.display = 'block'; currentView = 'home';
        document.querySelector('.search-btn-header').focus();
    }
    function updateSearchString(char) {
        if(char==='DEL') searchString = searchString.slice(0,-1); else if(char==='SPACE') searchString += " "; else searchString += char;
        document.getElementById('virtual-input-display').innerText = searchString + "_";
        const term = searchString.toLowerCase(); const results = document.getElementById('search-results-grid'); results.innerHTML = "";
        if(term.length > 0) {
            const hits = catalog.filter(i => i.title.toLowerCase().includes(term));
            if(hits.length) { document.getElementById('results-count-text').innerText = `${hits.length} Resultados`; results.innerHTML = hits.map(i => cardHtml(i)).join(''); }
        }
    }
    function generateKeyboard() {
        const grid = document.getElementById('keyboard-grid'); grid.innerHTML = '';
        KEYBOARD_LAYOUT.forEach(c => {
            const btn = document.createElement('button'); btn.className = 'key-btn focusable';
            btn.innerText = c==='DEL'?'⌫':(c==='SPACE'?'␣':c);
            if(c==='SPACE'||c==='DEL'||c==='VOLVER') btn.classList.add('wide','action');
            if(c==='VOLVER') { btn.innerText='Volver'; btn.onclick=closeSearchInterface; } else btn.onclick = () => updateSearchString(c);
            btn.setAttribute('data-char', c); grid.appendChild(btn);
        });
    }

    function handleRemote(e) {
        const k = e.keyCode;
        if(isKey(e,'BACK')) {
            e.preventDefault();
            if(currentView==='player') exitPlayer();
            else if(currentView==='details') closeDetails();
            else if(currentView==='search') closeSearchInterface();
            else window.location.href = 'index.html';
            return;
        }
        if([37,38,39,40].includes(k)) { e.preventDefault(); moveFocus(k); }
        if(isKey(e,'ENTER')) { if(document.activeElement) document.activeElement.click(); }
        if(currentView==='player') {
            if(isKey(e,'PLAY')||isKey(e,'PAUSE')) togglePlay();
            if(isKey(e,'STOP')) exitPlayer();
            if(isKey(e,'NEXT') || isKey(e,'FAST_FWD')) changeEpisode(1);
            if(isKey(e,'PREV') || isKey(e,'REWIND')) changeEpisode(-1);
        }
    }
    
    function moveFocus(k) {
        const current = document.activeElement;
        const all = Array.from(document.querySelectorAll('.focusable:not([style*="display: none"])'));
        if(!all.length) return;
        const idx = all.indexOf(current);
        if (idx === -1) { all[0].focus(); return; }
        if (k === 39 && idx < all.length - 1) all[idx + 1].focus();
        if (k === 37 && idx > 0) all[idx - 1].focus();
        if (k === 40) { const cols = Math.floor(document.body.clientWidth / 155); if(idx + cols < all.length) all[idx + cols].focus(); }
        if (k === 38) { const cols = Math.floor(document.body.clientWidth / 155); if(idx - cols >= 0) all[idx - cols].focus(); }
    }
    function isKey(e,n) { return KEYMAP[n] && KEYMAP[n].includes(e.keyCode); }
</script>
</body>
</html>
