<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Series</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    <style>
        body { margin: 0; background: #141414; color: white; font-family: sans-serif; overflow: hidden; }
        .focusable:focus { outline: 4px solid white; transform: scale(1.05); z-index: 100; background:#333; }
        
        #app { padding: 40px; height: 100vh; box-sizing: border-box; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .card { aspect-ratio: 2/3; background: #222; border-radius: 6px; cursor: pointer; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        
        #details { position: fixed; inset: 0; background: #141414; z-index: 50; display: none; overflow-y: auto; }
        .hero { width: 100%; height: 50vh; background-size: cover; mask-image: linear-gradient(to bottom, black, transparent); }
        .content { padding: 20px; }
        
        /* EPISODIOS */
        .ep-row { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center; gap: 20px; }
        .ep-thumb { width: 120px; height: 70px; background: black; object-fit: cover; }
        
        #player { position: fixed; inset: 0; background: black; z-index: 100; display: none; }
        video { width: 100%; height: 100%; }
    </style>
</head>
<body>
    <div id="app"><div class="grid" id="grid"></div></div>

    <div id="details">
        <div class="hero" id="hero"></div>
        <div class="content">
            <h1 id="title"></h1>
            <select id="season-sel" class="focusable" style="padding:10px; font-size:1.2rem; margin-bottom:20px;"></select>
            <div id="ep-list"></div>
        </div>
    </div>

    <div id="player"><video id="video" autoplay controls></video></div>

<script>
    // TUS LISTAS DE SERIES
    const SOURCES = [
        { url: 'https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1' }
    ];

    let player;
    let currentSeries;

    window.onload = async () => {
        shaka.polyfill.installAll();
        if(shaka.Player.isBrowserSupported()) player = new shaka.Player(document.getElementById('video'));
        
        const grid = document.getElementById('grid');
        for(const src of SOURCES) {
            try {
                const res = await fetch(src.url);
                const data = await res.json();
                data.forEach(item => {
                    // FILTRO SOLO SERIES (detectando array de estaciones)
                    if(item.estaciones || item.seasons || item.tipo === 'series') {
                        const c = document.createElement('div');
                        c.className = 'card focusable';
                        c.tabIndex = 0;
                        c.innerHTML = `<img src="${item.poster || item.img}">`;
                        c.onclick = () => openDetails(item);
                        grid.appendChild(c);
                    }
                });
            } catch(e){}
        }
        setTimeout(()=>document.querySelector('.card')?.focus(), 100);
    };

    function openDetails(item) {
        currentSeries = item;
        document.getElementById('title').innerText = item.title || item.titulo;
        document.getElementById('hero').style.backgroundImage = `url('${item.poster || item.img}')`;
        
        const sel = document.getElementById('season-sel');
        sel.innerHTML = '';
        const seasons = item.estaciones || item.seasons;
        
        seasons.forEach((s, idx) => {
            const opt = document.createElement('option');
            opt.value = idx;
            opt.text = `Temporada ${s.numero || idx+1}`;
            sel.appendChild(opt);
        });
        
        sel.onchange = () => renderEpisodes(seasons[sel.value]);
        renderEpisodes(seasons[0]);
        
        document.getElementById('details').style.display = 'block';
        setTimeout(()=>sel.focus(), 100);
    }

    function renderEpisodes(season) {
        const list = document.getElementById('ep-list');
        list.innerHTML = '';
        const eps = season.episodios || season.episodes;
        
        eps.forEach((ep, i) => {
            const row = document.createElement('div');
            row.className = 'ep-row focusable';
            row.tabIndex = 0;
            const thumb = ep.img || ep.image || currentSeries.poster;
            row.innerHTML = `<img src="${thumb}" class="ep-thumb"><div>${i+1}. ${ep.title || ep.titulo}</div>`;
            row.onclick = () => playVideo(ep.url || ep.mpd, ep.drm);
            list.appendChild(row);
        });
    }

    async function playVideo(url, drm) {
        document.getElementById('player').style.display = 'block';
        try {
            await player.load(url);
            if(drm?.clearKeys) player.configure({drm:{clearKeys:drm.clearKeys}});
        } catch(e){}
    }

    window.addEventListener('keydown', e => {
        if(e.keyCode===8 || e.keyCode===27) { // BACK
            if(document.getElementById('player').style.display==='block') {
                player.unload(); document.getElementById('player').style.display='none';
            } else if(document.getElementById('details').style.display==='block') {
                document.getElementById('details').style.display='none';
                document.querySelector('.card').focus();
            } else {
                window.location.href = 'index.html';
            }
        }
        if(e.keyCode===13) document.activeElement.click();
        if([37,38,39,40].includes(e.keyCode)) {
            e.preventDefault();
            const items = Array.from(document.querySelectorAll('.focusable')); // visible ones
            const idx = items.indexOf(document.activeElement);
            if(e.keyCode===40) items[idx+1]?.focus();
            if(e.keyCode===38) items[idx-1]?.focus();
        }
    });
</script>
</body>
</html>
