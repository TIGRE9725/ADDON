<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Series</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/shaka-player.ui.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/shaka-player/4.7.0/controls.min.css">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    <style>
        /* ESTILOS IDÉNTICOS A PELÍCULAS PARA CONSISTENCIA */
        :root { --primary: #E50914; --bg: #000000; }
        body { margin: 0; background: var(--bg); color: white; font-family: 'Roboto', sans-serif; overflow: hidden; }
        .focusable:focus { outline: none; border: 3px solid white !important; transform: scale(1.05); z-index: 100; background: rgba(255,255,255,0.2); }

        header { position: fixed; top: 0; width: 100%; height: 60px; z-index: 100; background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent); display: flex; align-items: center; justify-content: space-between; padding: 0 4%; box-sizing: border-box; }
        .logo { color: #FFD700; font-size: 24px; font-weight: 900; }

        #app { padding-top: 80px; height: 100vh; overflow-y: auto; padding-bottom: 50px; box-sizing: border-box; }
        .grid-prov { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; padding: 0 4%; }
        .card-prov { aspect-ratio: 16/9; background: #222; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; border: 3px solid transparent; }
        .card-prov img { height: 50px; object-fit: contain; margin-bottom: 10px; }

        .grid-content { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; padding: 0 4%; display: none; }
        .card { aspect-ratio: 2/3; background: #222; border-radius: 6px; cursor: pointer; position: relative; overflow: hidden; border: 3px solid transparent; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        .card-title { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; text-align: center; background: rgba(0,0,0,0.7); opacity: 0; font-weight: bold; }
        .card:focus .card-title { opacity: 1; }

        #details-view { position: fixed; inset: 0; background: var(--bg); z-index: 200; display: none; overflow-y: auto; }
        .details-hero { width: 100%; height: 60vh; background-size: cover; mask-image: linear-gradient(to bottom, black 50%, transparent); }
        .details-content { position: absolute; top: 30%; left: 5%; width: 50%; z-index: 10; }
        .details-title { font-size: 3rem; font-weight: 900; }
        .details-desc { font-size: 1.1rem; color: #ccc; margin-bottom: 20px; }
        
        .season-sel { padding: 10px; font-size: 1.2rem; background: #333; color: white; border: 2px solid #555; margin-bottom: 20px; }
        .ep-row { padding: 15px; border-bottom: 1px solid #333; cursor: pointer; display: flex; align-items: center; gap: 20px; }
        .ep-thumb { width: 140px; height: 80px; object-fit: cover; }

        #player-container { position: fixed; inset: 0; background: black; z-index: 5000; display: none; }
        #video { width: 100%; height: 100%; }
        #loading { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: #FFD700; color: black; padding: 10px 20px; display: none; z-index: 9999; }
    </style>
</head>
<body>

    <header id="main-header">
        <span class="material-icons-round" style="font-size:30px; margin-right:15px; cursor:pointer;" onclick="goBack()">arrow_back</span>
        <div class="logo">SERIES</div>
    </header>

    <div id="loading">Cargando Series...</div>

    <div id="app">
        <div class="grid-prov" id="prov-grid"></div>
        <div class="grid-content" id="content-grid"></div>
    </div>

    <div id="details-view">
        <div class="details-hero" id="det-hero"></div>
        <div class="details-content">
            <h1 class="details-title" id="det-title"></h1>
            <p class="details-desc" id="det-desc"></p>
            <button class="focusable" onclick="closeDetails()" style="padding:10px 20px; background:#333; color:white; border:none; margin-bottom:20px;">VOLVER</button>
            <br>
            <select id="season-sel" class="season-sel focusable"></select>
            <div id="ep-list"></div>
        </div>
    </div>

    <div id="player-container"><video id="video" autoplay controls></video></div>

<script>
    const PROVIDERS = [
        { title: 'IZZI GO', url: 'https://dl.dropboxusercontent.com/s/bryak61h00csivwlq84vt/series.json?rlkey=9dkv93rejmqogxvrt2vcs2i4v&dl=1', type: 'json', img: 'https://i.imgur.com/LOGO_IZZIGO.png' },
        { title: 'NETVIDEO', url: 'https://raw.githubusercontent.com/TIGRE9725/PELIS/main/netvideo.series.m3u', type: 'm3u', img: 'https://i.imgur.com/LOGO_NETVIDEO.png' },
        { title: 'SERVER 1', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/playlist_series.m3u', type: 'm3u', img: 'https://via.placeholder.com/300?text=S1' },
        { title: 'SERVER 2', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_server_series.m3u', type: 'm3u', img: 'https://via.placeholder.com/300?text=S2' },
        { title: 'SERVER 3', url: 'https://raw.githubusercontent.com/TIGRE9725/btv-auto/main/lista_dyndns_series.m3u', type: 'm3u', img: 'https://via.placeholder.com/300?text=S3' }
    ];

    let player;
    let currentSeries;
    const DEFAULT_IMG = "https://via.placeholder.com/200x300?text=Serie";

    window.onload = () => {
        shaka.polyfill.installAll();
        if(shaka.Player.isBrowserSupported()) player = new shaka.Player(document.getElementById('video'));
        renderProviders();
    };

    function renderProviders() {
        const grid = document.getElementById('prov-grid');
        grid.innerHTML = '';
        PROVIDERS.forEach(p => {
            const c = document.createElement('div');
            c.className = 'card-prov focusable';
            c.tabIndex = 0;
            c.innerHTML = `<img src="${p.img}"><div style="font-weight:bold">${p.title}</div>`;
            c.onclick = () => loadProvider(p);
            grid.appendChild(c);
        });
        setTimeout(()=>document.querySelector('.card-prov')?.focus(), 100);
    }

    async function loadProvider(p) {
        document.getElementById('loading').style.display = 'block';
        try {
            const res = await fetch(p.url);
            const text = await res.text();
            let list = [];
            if(p.type === 'json' || text.trim().startsWith('[')) {
                const data = JSON.parse(text);
                list = data.map(item => ({
                    title: item.title || item.titulo,
                    img: item.poster || item.img,
                    desc: item.sinopsis || item.description,
                    seasons: (item.estaciones || item.seasons || []).map((s,i) => ({
                        num: s.numero || s.season_number || i+1,
                        episodes: (s.episodios || s.episodes || []).map(e => ({
                            title: e.title || e.titulo,
                            img: e.img || e.image,
                            url: e.url || e.mpd || e.source?.url,
                            drm: e.drm || e.source?.drm
                        }))
                    }))
                }));
            } else {
                list = parseM3USeries(text);
            }
            renderSeries(list);
            document.getElementById('prov-grid').style.display = 'none';
            document.getElementById('content-grid').style.display = 'grid';
        } catch(e){}
        finally { document.getElementById('loading').style.display = 'none'; }
    }

    function renderSeries(list) {
        const grid = document.getElementById('content-grid');
        grid.innerHTML = '';
        list.forEach(item => {
            if(item.seasons && item.seasons.length > 0) {
                const c = document.createElement('div');
                c.className = 'card focusable';
                c.tabIndex = 0;
                c.innerHTML = `<img src="${item.img || DEFAULT_IMG}"><div class="card-title">${item.title}</div>`;
                c.onclick = () => openDetails(item);
                grid.appendChild(c);
            }
        });
        setTimeout(()=>document.querySelector('#content-grid .card')?.focus(), 100);
    }

    function parseM3USeries(text) {
        const lines = text.split('\n');
        const groups = {};
        let curr = null;
        for(let l of lines) {
            l = l.trim();
            if(l.startsWith('#EXTINF')) {
                curr = {};
                const grp = l.match(/group-title="([^"]+)"/);
                const logo = l.match(/tvg-logo="([^"]+)"/);
                curr.seriesName = grp ? grp[1] : "Series Varias";
                curr.img = logo ? logo[1] : null;
                curr.title = l.split(',')[1];
            } else if(l.startsWith('http')) {
                if(curr) {
                    curr.url = l;
                    if(!groups[curr.seriesName]) groups[curr.seriesName] = { title: curr.seriesName, img: curr.img, desc: "", seasons: [{num:1, episodes:[]}] };
                    if(!groups[curr.seriesName].img && curr.img) groups[curr.seriesName].img = curr.img;
                    groups[curr.seriesName].seasons[0].episodes.push(curr);
                    curr = null;
                }
            }
        }
        return Object.values(groups);
    }

    function openDetails(item) {
        currentSeries = item;
        document.getElementById('det-title').innerText = item.title;
        document.getElementById('det-desc').innerText = item.desc || "";
        document.getElementById('det-hero').style.backgroundImage = `url('${item.img || DEFAULT_IMG}')`;
        
        const sel = document.getElementById('season-sel');
        sel.innerHTML = '';
        item.seasons.forEach((s, idx) => {
            const opt = document.createElement('option');
            opt.value = idx;
            opt.text = `Temporada ${s.num}`;
            sel.appendChild(opt);
        });
        sel.onchange = () => renderEpisodes(item.seasons[sel.value]);
        renderEpisodes(item.seasons[0]);
        
        document.getElementById('details-view').style.display = 'block';
        setTimeout(()=>sel.focus(), 100);
    }

    function renderEpisodes(season) {
        const list = document.getElementById('ep-list');
        list.innerHTML = '';
        season.episodes.forEach((ep, i) => {
            const row = document.createElement('div');
            row.className = 'ep-row focusable';
            row.tabIndex = 0;
            const thumb = ep.img || currentSeries.img || DEFAULT_IMG;
            row.innerHTML = `<img src="${thumb}" class="ep-thumb"><div><h3>${i+1}. ${ep.title}</h3></div>`;
            row.onclick = () => playVideo(ep.url, ep.drm);
            list.appendChild(row);
        });
    }

    async function playVideo(url, drm) {
        document.getElementById('player-container').style.display = 'block';
        try {
            await player.unload();
            await player.load(url);
            if(drm?.clearKeys) player.configure({drm:{clearKeys:drm.clearKeys}});
        } catch(e){}
    }

    function closeDetails() {
        document.getElementById('details-view').style.display = 'none';
        document.querySelector('#content-grid .card').focus();
    }

    function goBack() {
        if(document.getElementById('player-container').style.display==='block') {
            player.unload(); document.getElementById('player-container').style.display='none'; return;
        }
        if(document.getElementById('details-view').style.display==='block') {
            closeDetails(); return;
        }
        if(document.getElementById('content-grid').style.display==='grid') {
            document.getElementById('content-grid').style.display='none';
            document.getElementById('prov-grid').style.display='grid';
            document.querySelector('.card-prov').focus();
            return;
        }
        window.location.href = 'index.html';
    }

    window.addEventListener('keydown', e => {
        if([8, 27, 461, 10009].includes(e.keyCode)) { e.preventDefault(); goBack(); }
        if(e.keyCode===13 || e.keyCode===23) document.activeElement.click();
        if([37,38,39,40].includes(e.keyCode)) {
            e.preventDefault();
            const items = Array.from(document.querySelectorAll('.focusable:not([style*="display: none"])'));
            const idx = items.indexOf(document.activeElement);
            if(e.keyCode===39 && idx < items.length-1) items[idx+1].focus();
            if(e.keyCode===37 && idx > 0) items[idx-1].focus();
            if(e.keyCode===40) { const c = Math.floor(document.body.clientWidth/155); if(idx+c < items.length) items[idx+c].focus(); }
            if(e.keyCode===38) { const c = Math.floor(document.body.clientWidth/155); if(idx-c >= 0) items[idx-c].focus(); }
        }
    });
</script>
</body>
</html>
